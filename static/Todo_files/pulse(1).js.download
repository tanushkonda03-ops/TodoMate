(()=>{var e={682:e=>{var t=function(e){null==e&&(e=(new Date).getTime()),this.N=624,this.M=397,this.MATRIX_A=2567483615,this.UPPER_MASK=2147483648,this.LOWER_MASK=2147483647,this.mt=new Array(this.N),this.mti=this.N+1,e.constructor==Array?this.init_by_array(e,e.length):this.init_seed(e)};t.prototype.init_seed=function(e){for(this.mt[0]=e>>>0,this.mti=1;this.mti<this.N;this.mti++){e=this.mt[this.mti-1]^this.mt[this.mti-1]>>>30;this.mt[this.mti]=(1812433253*((4294901760&e)>>>16)<<16)+1812433253*(65535&e)+this.mti,this.mt[this.mti]>>>=0}},t.prototype.init_by_array=function(e,t){var i,s,n;for(this.init_seed(19650218),i=1,s=0,n=this.N>t?this.N:t;n;n--){var r=this.mt[i-1]^this.mt[i-1]>>>30;this.mt[i]=(this.mt[i]^(1664525*((4294901760&r)>>>16)<<16)+1664525*(65535&r))+e[s]+s,this.mt[i]>>>=0,s++,++i>=this.N&&(this.mt[0]=this.mt[this.N-1],i=1),s>=t&&(s=0)}for(n=this.N-1;n;n--){r=this.mt[i-1]^this.mt[i-1]>>>30;this.mt[i]=(this.mt[i]^(1566083941*((4294901760&r)>>>16)<<16)+1566083941*(65535&r))-i,this.mt[i]>>>=0,++i>=this.N&&(this.mt[0]=this.mt[this.N-1],i=1)}this.mt[0]=2147483648},t.prototype.random_int=function(){var e,t=new Array(0,this.MATRIX_A);if(this.mti>=this.N){var i;for(this.mti==this.N+1&&this.init_seed(5489),i=0;i<this.N-this.M;i++)e=this.mt[i]&this.UPPER_MASK|this.mt[i+1]&this.LOWER_MASK,this.mt[i]=this.mt[i+this.M]^e>>>1^t[1&e];for(;i<this.N-1;i++)e=this.mt[i]&this.UPPER_MASK|this.mt[i+1]&this.LOWER_MASK,this.mt[i]=this.mt[i+(this.M-this.N)]^e>>>1^t[1&e];e=this.mt[this.N-1]&this.UPPER_MASK|this.mt[0]&this.LOWER_MASK,this.mt[this.N-1]=this.mt[this.M-1]^e>>>1^t[1&e],this.mti=0}return e=this.mt[this.mti++],e^=e>>>11,e^=e<<7&2636928640,e^=e<<15&4022730752,(e^=e>>>18)>>>0},t.prototype.random_int31=function(){return this.random_int()>>>1},t.prototype.random_incl=function(){return this.random_int()*(1/4294967295)},t.prototype.random=function(){return this.random_int()*(1/4294967296)},t.prototype.random_excl=function(){return(this.random_int()+.5)*(1/4294967296)},t.prototype.random_long=function(){return(67108864*(this.random_int()>>>5)+(this.random_int()>>>6))*(1/9007199254740992)},e.exports=t}},t={};function i(s){var n=t[s];if(void 0!==n)return n.exports;var r=t[s]={exports:{}};return e[s](r,r.exports,i),r.exports}i.n=e=>{var t=e&&e.__esModule?()=>e.default:()=>e;return i.d(t,{a:t}),t},i.d=(e,t)=>{for(var s in t)i.o(t,s)&&!i.o(e,s)&&Object.defineProperty(e,s,{enumerable:!0,get:t[s]})},i.o=(e,t)=>Object.prototype.hasOwnProperty.call(e,t),(()=>{"use strict";var e=function(t,i){return e=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(e,t){e.__proto__=t}||function(e,t){for(var i in t)Object.prototype.hasOwnProperty.call(t,i)&&(e[i]=t[i])},e(t,i)};function t(t,i){if("function"!=typeof i&&null!==i)throw new TypeError("Class extends value "+String(i)+" is not a constructor or null");function s(){this.constructor=t}e(t,i),t.prototype=null===i?Object.create(i):(s.prototype=i.prototype,new s)}var s=function(){return s=Object.assign||function(e){for(var t,i=1,s=arguments.length;i<s;i++)for(var n in t=arguments[i])Object.prototype.hasOwnProperty.call(t,n)&&(e[n]=t[n]);return e},s.apply(this,arguments)};function n(e,t,i,s){return new(i||(i=Promise))(function(n,r){function o(e){try{c(s.next(e))}catch(e){r(e)}}function a(e){try{c(s.throw(e))}catch(e){r(e)}}function c(e){var t;e.done?n(e.value):(t=e.value,t instanceof i?t:new i(function(e){e(t)})).then(o,a)}c((s=s.apply(e,t||[])).next())})}function r(e,t){var i,s,n,r={label:0,sent:function(){if(1&n[0])throw n[1];return n[1]},trys:[],ops:[]},o=Object.create(("function"==typeof Iterator?Iterator:Object).prototype);return o.next=a(0),o.throw=a(1),o.return=a(2),"function"==typeof Symbol&&(o[Symbol.iterator]=function(){return this}),o;function a(a){return function(c){return function(a){if(i)throw new TypeError("Generator is already executing.");for(;o&&(o=0,a[0]&&(r=0)),r;)try{if(i=1,s&&(n=2&a[0]?s.return:a[0]?s.throw||((n=s.return)&&n.call(s),0):s.next)&&!(n=n.call(s,a[1])).done)return n;switch(s=0,n&&(a=[2&a[0],n.value]),a[0]){case 0:case 1:n=a;break;case 4:return r.label++,{value:a[1],done:!1};case 5:r.label++,s=a[1],a=[0];continue;case 7:a=r.ops.pop(),r.trys.pop();continue;default:if(!(n=r.trys,(n=n.length>0&&n[n.length-1])||6!==a[0]&&2!==a[0])){r=0;continue}if(3===a[0]&&(!n||a[1]>n[0]&&a[1]<n[3])){r.label=a[1];break}if(6===a[0]&&r.label<n[1]){r.label=n[1],n=a;break}if(n&&r.label<n[2]){r.label=n[2],r.ops.push(a);break}n[2]&&r.ops.pop(),r.trys.pop();continue}a=t.call(e,r)}catch(e){a=[6,e],s=0}finally{i=n=0}if(5&a[0])throw a[1];return{value:a[0]?a[1]:void 0,done:!0}}([a,c])}}}Object.create;function o(e){var t="function"==typeof Symbol&&Symbol.iterator,i=t&&e[t],s=0;if(i)return i.call(e);if(e&&"number"==typeof e.length)return{next:function(){return e&&s>=e.length&&(e=void 0),{value:e&&e[s++],done:!e}}};throw new TypeError(t?"Object is not iterable.":"Symbol.iterator is not defined.")}function a(e,t){var i="function"==typeof Symbol&&e[Symbol.iterator];if(!i)return e;var s,n,r=i.call(e),o=[];try{for(;(void 0===t||t-- >0)&&!(s=r.next()).done;)o.push(s.value)}catch(e){n={error:e}}finally{try{s&&!s.done&&(i=r.return)&&i.call(r)}finally{if(n)throw n.error}}return o}function c(e,t,i){if(i||2===arguments.length)for(var s,n=0,r=t.length;n<r;n++)!s&&n in t||(s||(s=Array.prototype.slice.call(t,0,n)),s[n]=t[n]);return e.concat(s||Array.prototype.slice.call(t))}function u(e){return this instanceof u?(this.v=e,this):new u(e)}function h(e,t,i){if(!Symbol.asyncIterator)throw new TypeError("Symbol.asyncIterator is not defined.");var s,n=i.apply(e,t||[]),r=[];return s=Object.create(("function"==typeof AsyncIterator?AsyncIterator:Object).prototype),o("next"),o("throw"),o("return",function(e){return function(t){return Promise.resolve(t).then(e,h)}}),s[Symbol.asyncIterator]=function(){return this},s;function o(e,t){n[e]&&(s[e]=function(t){return new Promise(function(i,s){r.push([e,t,i,s])>1||a(e,t)})},t&&(s[e]=t(s[e])))}function a(e,t){try{(i=n[e](t)).value instanceof u?Promise.resolve(i.value.v).then(c,h):l(r[0][2],i)}catch(e){l(r[0][3],e)}var i}function c(e){a("next",e)}function h(e){a("throw",e)}function l(e,t){e(t),r.shift(),r.length&&a(r[0][0],r[0][1])}}function l(e){if(!Symbol.asyncIterator)throw new TypeError("Symbol.asyncIterator is not defined.");var t,i=e[Symbol.asyncIterator];return i?i.call(e):(e=o(e),t={},s("next"),s("throw"),s("return"),t[Symbol.asyncIterator]=function(){return this},t);function s(i){t[i]=e[i]&&function(t){return new Promise(function(s,n){(function(e,t,i,s){Promise.resolve(s).then(function(t){e({value:t,done:i})},t)})(s,n,(t=e[i](t)).done,t.value)})}}}Object.create;"function"==typeof SuppressedError&&SuppressedError;let d=null;const p=e=>{if(null!==d)return d;try{if(void 0===e||!("localStorage"in e)||!e.localStorage.getItem)return!1;const t="__test__";return e.localStorage.setItem(t,"1"),e.localStorage.removeItem(t),d=!0,!0}catch{return d=!1,!1}};let g=null;function f(e,t=!1){if(null!==g)return t?Promise.resolve(g):g;if(void 0===e||!e.indexedDB)return g=!1,!!t&&Promise.resolve(!1);try{const i=e?.indexedDB?.open("testDB");return t?new Promise(t=>{i.onsuccess=()=>{i.result.close(),e.indexedDB.deleteDatabase("testDB"),g=!0,t(!0)},i.onerror=()=>{g=!1,t(!1)}}):(i.onsuccess=()=>{i.result.close(),e.indexedDB.deleteDatabase("testDB"),g=!0},i.onerror=()=>{g=!1},!0)}catch{return g=!1,!!t&&Promise.resolve(!1)}}function v(e){return"function"==typeof e}function b(e){var t=e(function(e){Error.call(e),e.stack=(new Error).stack});return t.prototype=Object.create(Error.prototype),t.prototype.constructor=t,t}var m=b(function(e){return function(t){e(this),this.message=t?t.length+" errors occurred during unsubscription:\n"+t.map(function(e,t){return t+1+") "+e.toString()}).join("\n  "):"",this.name="UnsubscriptionError",this.errors=t}});function y(e,t){if(e){var i=e.indexOf(t);0<=i&&e.splice(i,1)}}var S=function(){function e(e){this.initialTeardown=e,this.closed=!1,this._parentage=null,this._finalizers=null}return e.prototype.unsubscribe=function(){var e,t,i,s,n;if(!this.closed){this.closed=!0;var r=this._parentage;if(r)if(this._parentage=null,Array.isArray(r))try{for(var u=o(r),h=u.next();!h.done;h=u.next()){h.value.remove(this)}}catch(t){e={error:t}}finally{try{h&&!h.done&&(t=u.return)&&t.call(u)}finally{if(e)throw e.error}}else r.remove(this);var l=this.initialTeardown;if(v(l))try{l()}catch(e){n=e instanceof m?e.errors:[e]}var d=this._finalizers;if(d){this._finalizers=null;try{for(var p=o(d),g=p.next();!g.done;g=p.next()){var f=g.value;try{E(f)}catch(e){n=null!=n?n:[],e instanceof m?n=c(c([],a(n)),a(e.errors)):n.push(e)}}}catch(e){i={error:e}}finally{try{g&&!g.done&&(s=p.return)&&s.call(p)}finally{if(i)throw i.error}}}if(n)throw new m(n)}},e.prototype.add=function(t){var i;if(t&&t!==this)if(this.closed)E(t);else{if(t instanceof e){if(t.closed||t._hasParent(this))return;t._addParent(this)}(this._finalizers=null!==(i=this._finalizers)&&void 0!==i?i:[]).push(t)}},e.prototype._hasParent=function(e){var t=this._parentage;return t===e||Array.isArray(t)&&t.includes(e)},e.prototype._addParent=function(e){var t=this._parentage;this._parentage=Array.isArray(t)?(t.push(e),t):t?[t,e]:e},e.prototype._removeParent=function(e){var t=this._parentage;t===e?this._parentage=null:Array.isArray(t)&&y(t,e)},e.prototype.remove=function(t){var i=this._finalizers;i&&y(i,t),t instanceof e&&t._removeParent(this)},e.EMPTY=function(){var t=new e;return t.closed=!0,t}(),e}(),w=S.EMPTY;function _(e){return e instanceof S||e&&"closed"in e&&v(e.remove)&&v(e.add)&&v(e.unsubscribe)}function E(e){v(e)?e():e.unsubscribe()}var T={onUnhandledError:null,onStoppedNotification:null,Promise:void 0,useDeprecatedSynchronousErrorHandling:!1,useDeprecatedNextContext:!1},k={setTimeout:function(e,t){for(var i=[],s=2;s<arguments.length;s++)i[s-2]=arguments[s];var n=k.delegate;return(null==n?void 0:n.setTimeout)?n.setTimeout.apply(n,c([e,t],a(i))):setTimeout.apply(void 0,c([e,t],a(i)))},clearTimeout:function(e){var t=k.delegate;return((null==t?void 0:t.clearTimeout)||clearTimeout)(e)},delegate:void 0};function C(e){k.setTimeout(function(){var t=T.onUnhandledError;if(!t)throw e;t(e)})}function I(){}var x=P("C",void 0,void 0);function P(e,t,i){return{kind:e,value:t,error:i}}var N=null;function A(e){if(T.useDeprecatedSynchronousErrorHandling){var t=!N;if(t&&(N={errorThrown:!1,error:null}),e(),t){var i=N,s=i.errorThrown,n=i.error;if(N=null,s)throw n}}else e()}var O=function(e){function i(t){var i=e.call(this)||this;return i.isStopped=!1,t?(i.destination=t,_(t)&&t.add(i)):i.destination=B,i}return t(i,e),i.create=function(e,t,i){return new M(e,t,i)},i.prototype.next=function(e){this.isStopped?U(function(e){return P("N",e,void 0)}(e),this):this._next(e)},i.prototype.error=function(e){this.isStopped?U(P("E",void 0,e),this):(this.isStopped=!0,this._error(e))},i.prototype.complete=function(){this.isStopped?U(x,this):(this.isStopped=!0,this._complete())},i.prototype.unsubscribe=function(){this.closed||(this.isStopped=!0,e.prototype.unsubscribe.call(this),this.destination=null)},i.prototype._next=function(e){this.destination.next(e)},i.prototype._error=function(e){try{this.destination.error(e)}finally{this.unsubscribe()}},i.prototype._complete=function(){try{this.destination.complete()}finally{this.unsubscribe()}},i}(S),R=Function.prototype.bind;function L(e,t){return R.call(e,t)}var D=function(){function e(e){this.partialObserver=e}return e.prototype.next=function(e){var t=this.partialObserver;if(t.next)try{t.next(e)}catch(e){$(e)}},e.prototype.error=function(e){var t=this.partialObserver;if(t.error)try{t.error(e)}catch(e){$(e)}else $(e)},e.prototype.complete=function(){var e=this.partialObserver;if(e.complete)try{e.complete()}catch(e){$(e)}},e}(),M=function(e){function i(t,i,s){var n,r,o=e.call(this)||this;v(t)||!t?n={next:null!=t?t:void 0,error:null!=i?i:void 0,complete:null!=s?s:void 0}:o&&T.useDeprecatedNextContext?((r=Object.create(t)).unsubscribe=function(){return o.unsubscribe()},n={next:t.next&&L(t.next,r),error:t.error&&L(t.error,r),complete:t.complete&&L(t.complete,r)}):n=t;return o.destination=new D(n),o}return t(i,e),i}(O);function $(e){var t;T.useDeprecatedSynchronousErrorHandling?(t=e,T.useDeprecatedSynchronousErrorHandling&&N&&(N.errorThrown=!0,N.error=t)):C(e)}function U(e,t){var i=T.onStoppedNotification;i&&k.setTimeout(function(){return i(e,t)})}var B={closed:!0,next:I,error:function(e){throw e},complete:I},j="function"==typeof Symbol&&Symbol.observable||"@@observable";function H(e){return e}function F(e){return 0===e.length?H:1===e.length?e[0]:function(t){return e.reduce(function(e,t){return t(e)},t)}}var V=function(){function e(e){e&&(this._subscribe=e)}return e.prototype.lift=function(t){var i=new e;return i.source=this,i.operator=t,i},e.prototype.subscribe=function(e,t,i){var s,n=this,r=(s=e)&&s instanceof O||function(e){return e&&v(e.next)&&v(e.error)&&v(e.complete)}(s)&&_(s)?e:new M(e,t,i);return A(function(){var e=n,t=e.operator,i=e.source;r.add(t?t.call(r,i):i?n._subscribe(r):n._trySubscribe(r))}),r},e.prototype._trySubscribe=function(e){try{return this._subscribe(e)}catch(t){e.error(t)}},e.prototype.forEach=function(e,t){var i=this;return new(t=q(t))(function(t,s){var n=new M({next:function(t){try{e(t)}catch(e){s(e),n.unsubscribe()}},error:s,complete:t});i.subscribe(n)})},e.prototype._subscribe=function(e){var t;return null===(t=this.source)||void 0===t?void 0:t.subscribe(e)},e.prototype[j]=function(){return this},e.prototype.pipe=function(){for(var e=[],t=0;t<arguments.length;t++)e[t]=arguments[t];return F(e)(this)},e.prototype.toPromise=function(e){var t=this;return new(e=q(e))(function(e,i){var s;t.subscribe(function(e){return s=e},function(e){return i(e)},function(){return e(s)})})},e.create=function(t){return new e(t)},e}();function q(e){var t;return null!==(t=null!=e?e:T.Promise)&&void 0!==t?t:Promise}var K=b(function(e){return function(){e(this),this.name="ObjectUnsubscribedError",this.message="object unsubscribed"}}),z=function(e){function i(){var t=e.call(this)||this;return t.closed=!1,t.currentObservers=null,t.observers=[],t.isStopped=!1,t.hasError=!1,t.thrownError=null,t}return t(i,e),i.prototype.lift=function(e){var t=new G(this,this);return t.operator=e,t},i.prototype._throwIfClosed=function(){if(this.closed)throw new K},i.prototype.next=function(e){var t=this;A(function(){var i,s;if(t._throwIfClosed(),!t.isStopped){t.currentObservers||(t.currentObservers=Array.from(t.observers));try{for(var n=o(t.currentObservers),r=n.next();!r.done;r=n.next()){r.value.next(e)}}catch(e){i={error:e}}finally{try{r&&!r.done&&(s=n.return)&&s.call(n)}finally{if(i)throw i.error}}}})},i.prototype.error=function(e){var t=this;A(function(){if(t._throwIfClosed(),!t.isStopped){t.hasError=t.isStopped=!0,t.thrownError=e;for(var i=t.observers;i.length;)i.shift().error(e)}})},i.prototype.complete=function(){var e=this;A(function(){if(e._throwIfClosed(),!e.isStopped){e.isStopped=!0;for(var t=e.observers;t.length;)t.shift().complete()}})},i.prototype.unsubscribe=function(){this.isStopped=this.closed=!0,this.observers=this.currentObservers=null},Object.defineProperty(i.prototype,"observed",{get:function(){var e;return(null===(e=this.observers)||void 0===e?void 0:e.length)>0},enumerable:!1,configurable:!0}),i.prototype._trySubscribe=function(t){return this._throwIfClosed(),e.prototype._trySubscribe.call(this,t)},i.prototype._subscribe=function(e){return this._throwIfClosed(),this._checkFinalizedStatuses(e),this._innerSubscribe(e)},i.prototype._innerSubscribe=function(e){var t=this,i=this,s=i.hasError,n=i.isStopped,r=i.observers;return s||n?w:(this.currentObservers=null,r.push(e),new S(function(){t.currentObservers=null,y(r,e)}))},i.prototype._checkFinalizedStatuses=function(e){var t=this,i=t.hasError,s=t.thrownError,n=t.isStopped;i?e.error(s):n&&e.complete()},i.prototype.asObservable=function(){var e=new V;return e.source=this,e},i.create=function(e,t){return new G(e,t)},i}(V),G=function(e){function i(t,i){var s=e.call(this)||this;return s.destination=t,s.source=i,s}return t(i,e),i.prototype.next=function(e){var t,i;null===(i=null===(t=this.destination)||void 0===t?void 0:t.next)||void 0===i||i.call(t,e)},i.prototype.error=function(e){var t,i;null===(i=null===(t=this.destination)||void 0===t?void 0:t.error)||void 0===i||i.call(t,e)},i.prototype.complete=function(){var e,t;null===(t=null===(e=this.destination)||void 0===e?void 0:e.complete)||void 0===t||t.call(e)},i.prototype._subscribe=function(e){var t,i;return null!==(i=null===(t=this.source)||void 0===t?void 0:t.subscribe(e))&&void 0!==i?i:w},i}(z),J=function(e){function i(t){var i=e.call(this)||this;return i._value=t,i}return t(i,e),Object.defineProperty(i.prototype,"value",{get:function(){return this.getValue()},enumerable:!1,configurable:!0}),i.prototype._subscribe=function(t){var i=e.prototype._subscribe.call(this,t);return!i.closed&&t.next(this._value),i},i.prototype.getValue=function(){var e=this,t=e.hasError,i=e.thrownError,s=e._value;if(t)throw i;return this._throwIfClosed(),s},i.prototype.next=function(t){e.prototype.next.call(this,this._value=t)},i}(z),W=b(function(e){return function(){e(this),this.name="EmptyError",this.message="no elements in sequence"}});function Y(e,t){var i="object"==typeof t;return new Promise(function(s,n){var r=new M({next:function(e){s(e),r.unsubscribe()},error:n,complete:function(){i?s(t.defaultValue):n(new W)}});e.subscribe(r)})}function Q(e){return function(t){if(function(e){return v(null==e?void 0:e.lift)}(t))return t.lift(function(t){try{return e(t,this)}catch(e){this.error(e)}});throw new TypeError("Unable to lift unknown Observable type")}}function X(e,t,i,s,n){return new Z(e,t,i,s,n)}var Z=function(e){function i(t,i,s,n,r,o){var a=e.call(this,t)||this;return a.onFinalize=r,a.shouldUnsubscribe=o,a._next=i?function(e){try{i(e)}catch(e){t.error(e)}}:e.prototype._next,a._error=n?function(e){try{n(e)}catch(e){t.error(e)}finally{this.unsubscribe()}}:e.prototype._error,a._complete=s?function(){try{s()}catch(e){t.error(e)}finally{this.unsubscribe()}}:e.prototype._complete,a}return t(i,e),i.prototype.unsubscribe=function(){var t;if(!this.shouldUnsubscribe||this.shouldUnsubscribe()){var i=this.closed;e.prototype.unsubscribe.call(this),!i&&(null===(t=this.onFinalize)||void 0===t||t.call(this))}},i}(O);function ee(e,t){return Q(function(i,s){var n=0;i.subscribe(X(s,function(i){return e.call(t,i,n++)&&s.next(i)}))})}var te=function(e){return e&&"number"==typeof e.length&&"function"!=typeof e};function ie(e){return v(null==e?void 0:e.then)}function se(e){return v(e[j])}function ne(e){return Symbol.asyncIterator&&v(null==e?void 0:e[Symbol.asyncIterator])}function re(e){return new TypeError("You provided "+(null!==e&&"object"==typeof e?"an invalid object":"'"+e+"'")+" where a stream was expected. You can provide an Observable, Promise, ReadableStream, Array, AsyncIterable, or Iterable.")}var oe,ae="function"==typeof Symbol&&Symbol.iterator?Symbol.iterator:"@@iterator";function ce(e){return v(null==e?void 0:e[ae])}function ue(e){return h(this,arguments,function(){var t,i,s;return r(this,function(n){switch(n.label){case 0:t=e.getReader(),n.label=1;case 1:n.trys.push([1,,9,10]),n.label=2;case 2:return[4,u(t.read())];case 3:return i=n.sent(),s=i.value,i.done?[4,u(void 0)]:[3,5];case 4:return[2,n.sent()];case 5:return[4,u(s)];case 6:return[4,n.sent()];case 7:return n.sent(),[3,2];case 8:return[3,10];case 9:return t.releaseLock(),[7];case 10:return[2]}})})}function he(e){return v(null==e?void 0:e.getReader)}function le(e){if(e instanceof V)return e;if(null!=e){if(se(e))return n=e,new V(function(e){var t=n[j]();if(v(t.subscribe))return t.subscribe(e);throw new TypeError("Provided object does not correctly implement Symbol.observable")});if(te(e))return s=e,new V(function(e){for(var t=0;t<s.length&&!e.closed;t++)e.next(s[t]);e.complete()});if(ie(e))return i=e,new V(function(e){i.then(function(t){e.closed||(e.next(t),e.complete())},function(t){return e.error(t)}).then(null,C)});if(ne(e))return de(e);if(ce(e))return t=e,new V(function(e){var i,s;try{for(var n=o(t),r=n.next();!r.done;r=n.next()){var a=r.value;if(e.next(a),e.closed)return}}catch(e){i={error:e}}finally{try{r&&!r.done&&(s=n.return)&&s.call(n)}finally{if(i)throw i.error}}e.complete()});if(he(e))return de(ue(e))}var t,i,s,n;throw re(e)}function de(e){return new V(function(t){(function(e,t){var i,s,o,a;return n(this,void 0,void 0,function(){var n,c;return r(this,function(r){switch(r.label){case 0:r.trys.push([0,5,6,11]),i=l(e),r.label=1;case 1:return[4,i.next()];case 2:if((s=r.sent()).done)return[3,4];if(n=s.value,t.next(n),t.closed)return[2];r.label=3;case 3:return[3,1];case 4:return[3,11];case 5:return c=r.sent(),o={error:c},[3,11];case 6:return r.trys.push([6,,9,10]),s&&!s.done&&(a=i.return)?[4,a.call(i)]:[3,8];case 7:r.sent(),r.label=8;case 8:return[3,10];case 9:if(o)throw o.error;return[7];case 10:return[7];case 11:return t.complete(),[2]}})})})(e,t).catch(function(e){return t.error(e)})})}function pe(e){return Q(function(t,i){var s,n=null,r=!1;n=t.subscribe(X(i,void 0,void 0,function(o){s=le(e(o,pe(e)(t))),n?(n.unsubscribe(),n=null,s.subscribe(i)):r=!0})),r&&(n.unsubscribe(),n=null,s.subscribe(i))})}function ge(e,t){return Q(function(i,s){var n=0;i.subscribe(X(s,function(i){s.next(e.call(t,i,n++))}))})}!function(e){e[e.None=0]="None",e[e.Error=1]="Error",e[e.Warn=2]="Warn",e[e.Info=3]="Info",e[e.Verbose=4]="Verbose"}(oe||(oe={}));const fe={app:"",mode:"standard",app_version:"0",version:"1.94.15",logLevel:oe.Error,locksMaxAge:864e5,storagePrefix:"paa_",keyPulseSyncCookie:"pulse-state",hashStoreStorageType:"persistent",stateStorageKey:"ss",handledErrorPrefix:"HANDLED ERROR >>>"},ve={...fe,transportTimeout:6e4,transportRetries:Number.POSITIVE_INFINITY,transportRetryBackoffMS:100,transportRetryBackoffMaxMS:3e4,pulseClientType:"browser",tabManagerStorageType:"tab",sessionStorageType:"persistent",initialDocURL:"",experimentStorageKey:"experiments",keySessionID:"sid",keyDeviceId:"did",trafficSourceDetectorStorageType:"persistent",cacheStorageType:"persistent"};class be{env;_db;connectionState$=new J("NOT_CONNECTED");storeList=["settingsStore","attributesStore"];pulseDB="pulseDB";get db(){if(!this._db)throw Error("IndexDB store not exist ");return this._db}constructor(e){this.env=e}async truncate(e){if(!f(this.env.win))return;const t=await this.getTransaction(e,"readwrite");return new Promise((i,s)=>{try{const n=t.objectStore(e).clear();n.onerror=e=>{this.logerr(e),s(e)},n.onsuccess=()=>{i(n.result)}}catch(e){s(e)}})}async getValue(e,t){if(!f(this.env.win))return;const i=await this.getTransaction(e,"readonly");return new Promise((s,n)=>{try{const n=i.objectStore(e).get(t);n.onerror=this.logerr,n.onsuccess=()=>{s(n.result)}}catch(e){n(e)}})}async getAllValue(e){if(!f(this.env.win))return Promise.resolve();const t=await this.getTransaction(e,"readonly");return new Promise((i,s)=>{try{const s=t.objectStore(e).getAll();s.onerror=this.logerr,s.onsuccess=()=>{i(s.result)}}catch(e){s(e)}})}async putValue(e,t){if(!f(this.env.win))return Promise.resolve(!1);const i=await this.getTransaction(e,"readwrite");return new Promise((s,n)=>{try{const n=i.objectStore(e).put(t);n.onsuccess=()=>{s(!0)},n.onerror=this.logerr}catch(e){n(e)}})}async putBulkValue(e,t){if(!f(this.env.win))return;const i=(await this.getTransaction(e,"readwrite")).objectStore(e);for(const e of t)i.put(e);return await this.getAllValue(e)}async deleteValue(e,t){if(!f(this.env.win))return;const i=await this.getTransaction(e,"readwrite");return new Promise((s,n)=>{try{const n=i.objectStore(e),r=n.get(t);r.onsuccess=()=>{r.result||s("-1"),n.delete(t).onsuccess=()=>s(t)},r.onerror=this.logerr}catch(e){n(e)}})}async connectDB(){if(!f(this.env.win))return;this.connectionState$.next("CONNECTING");const e=this.env.win.indexedDB.open(this.pulseDB,1);return new Promise((t,i)=>{try{e.onerror=e=>{this.connectionState$.next("NOT_CONNECTED"),this.logerr(e)},e.onsuccess=()=>{this.createObjectStore(e.result),t(e.result)},e.onupgradeneeded=e=>{e.target&&e.target?.result&&this.createObjectStore(e.target?.result)}}catch(e){this.connectionState$.next("NOT_CONNECTED"),i(e)}})}logerr(e){console.warn(e)}createObjectStore(e){this.storeList.forEach(t=>{if(!e.objectStoreNames.contains(t)){const i=e.createObjectStore(t,{autoIncrement:!1,keyPath:"id"});i.createIndex("id","id",{unique:!0}),i.createIndex("time","time",{unique:!1}),i.createIndex("id_time",["id","time"],{unique:!0})}}),this._db=e,this.connectionState$.next("CONNECTED"),this.db.onclose=this.reconnectDB.bind(this),this.db.onabort=this.reconnectDB.bind(this)}getTransaction(e,t,i){if("CONNECTED"===this.connectionState$.getValue())try{return Promise.resolve(this.db.transaction(e,t,i))}catch(e){console.warn(e),this.connectDB()}return Y(this.connectionState$.pipe(ee(e=>"CONNECTED"===e),ge(()=>this.db.transaction(e,t,i)),pe(e=>{return this.logerr(e),s=v(t=()=>e)?t:function(){return t},n=function(e){return e.error(s())},new V(i?function(e){return i.schedule(n,0,e)}:n);var t,i,s,n})))}reconnectDB(e){e&&this.logerr(`${ve.handledErrorPrefix} ${JSON.stringify(e)}`),this.connectDB()}}class me{win;doc;navigator;landingUrl;constructor(e){this.win=e,this.doc=this.win.document,this.navigator=this.win.navigator,this.landingUrl=this.getInitialDocumentURL()}getInitialDocumentURL(){if("function"==typeof this.win.performance?.getEntries){const e=this.win.performance.getEntries().find(e=>"navigation"===e.entryType);if(e&&this.isValidURL(e.name))return e.name}return this.isValidURL(this.win.pulse?.idu)?this.win.pulse.idu:this.win.document.location.href}isValidURL(e){if("string"!=typeof e)return!1;try{const t=new URL(e);return Boolean(t.hostname)}catch{return!1}}}class ye{key;___;constructor(e){if(this.key=e,"string"!=typeof e||!e.trim())throw new Error("Invalid InjectionToken name!");this.___=e}}const Se=new ye("PULSE_ROOT_CONFIGURATION");let we;function _e(){const e=function(){if(we)return we;try{if("object"==typeof navigator&&"Cloudflare-Workers"===navigator?.userAgent)return we="cf-worker",we;if("undefined"!=typeof window&&void 0!==window.document)return"object"==typeof navigator&&navigator?.userAgent?.includes("jsdom")?(we="jsdom",we):(we="browser",we);if("undefined"!=typeof process&&process.versions?.node)return we="node",we;if("undefined"!=typeof globalThis&&"function"==typeof globalThis.addEventListener&&"function"==typeof globalThis.Request){if("EdgeRuntime"in globalThis&&"edge"===globalThis.EdgeRuntime)return we="vercel-edge",we;if("undefined"!=typeof WebSocket)return we="cf-worker",we}}catch{console.warn("Failed to detect environment")}return we="unknown",we}();return"browser"===e||"jsdom"===e}class Ee{task;resolveTask;rejectTask;completed=!1;constructor(e){if(this.task=new Promise((e,t)=>{this.resolveTask=e,this.rejectTask=t}),e){const t=setTimeout(()=>{this.reject(new Error(`AsyncTask timeout after ${e}ms!`))},e);this.waitUntilResolved().then(()=>clearTimeout(t)).catch(()=>clearTimeout(t))}}resolve(e){this.completed||(this.completed=!0,this.resolveTask(e))}reject(e){this.completed||(this.completed=!0,this.rejectTask(e))}waitUntilResolved(){return this.task}}class Te{parent;providers=new Map;store=new Map;tasks=new Map;constructor(e){this.parent=e}register(...e){for(const t of e)this.providers.set(t.provide,t);return this}factory(e){return this.providers.set(e.provide,e),this}get(e){const t=this.getOrCreate(e);return this.isPromise(t)?t:Promise.resolve(t)}getSync(e){const t=this.getOrCreate(e);if(this.isPromise(t)){const t=this.typeName(e);throw new Error(["Cannot instantiate dependency synchronously!",`One of the providers of the dependencies of '${t}' is asynchronous!`].join("\n"))}return t}getOrCreate(e){if(e===Te)return this;const t=this.store.get(e);if(t)return t;let i=this.tasks.get(e);if(i)return i.waitUntilResolved();i=new Ee;const s=this.providers.get(e);if(!s){if(this.parent)return this.parent.getOrCreate(e);throw new Error(`No provider found for type '${this.typeName(e)}'!`)}const n=this.getDeps(s);if(this.isPromise(n))return this.tasks.set(e,i),n.then(e=>this.createValue(s,e)).then(t=>{this.store.set(e,t),i?.resolve(t),this.tasks.delete(e)}).catch(t=>{this.tasks.delete(e),i?.reject(t)}),i.waitUntilResolved();{const t=this.createValue(s,n);return this.store.set(e,t),t}}createValue(e,t){if(void 0!==e.useValue)return e.useValue;if(e.useClass)return new e.useClass(...t);if(e.useFactory)return e.useFactory(...t);if(this.isClass(e.provide))return new e.provide(...t);{const t=this.typeName(e.provide);throw new Error(`No useClass or useFactory is provided for type '${t}'`)}}getDeps(e){this.checkDeps(e);const t=(Array.isArray(e.deps)?e.deps:[]).map(e=>this.getOrCreate(e));return t.some(e=>this.isPromise(e))?Promise.all(t):t}checkDeps(e){const t=Array.isArray(e.deps)?e.deps:[],i=t.map(e=>this.findProvider(e)),s=t.filter((e,t)=>void 0===i[t]);if(!s.length)return;const n=this.typeName(e.provide),r=i.map(e=>e?this.typeName(e.provide):"?").join(", "),o=`No provider found for the following tokens: ${s.map(e=>this.typeName(e)).join(", ")}`;throw new Error(`Cannot instantiate dependency '${n}(${r})'!\n\n ${o}`)}findProvider(e){return this.providers.get(e)||this.parent?.findProvider(e)}typeName(e){return e instanceof ye?`Token(${e.key})`:this.isClass(e)?e.name:String(e)}isClass(e){return e&&"function"==typeof e&&"string"==typeof e.name&&"function"==typeof e.constructor&&e.name}isPromise(e){return"object"==typeof e&&(e instanceof Promise||e.then&&e.catch)}}class ke{providers=[];useClass(e,t,i,s){return this.providers.push({provide:e,useClass:t,deps:i,provideInRoot:s}),this}useFactory(e,t,i,s){return this.providers.push({provide:e,useFactory:t,deps:i,provideInRoot:s}),this}useValue(e,t,i){return this.providers.push({provide:e,useValue:t,provideInRoot:i}),this}_getProviders(){return this.providers}}class Ce{imports=[];builder=new ke;beforeInitHandler;initHandler;injector=new Te;parent;bootstrapped=!1;import(e){if(e.bootstrapped)throw new Error("Cannot import already bootstrapped module! Only root module must be bootstrapped!");return e.parent=this,this.imports.push(e),this}provide(e){const t=e(this.builder);if(!(t&&t instanceof ke))throw new Error("Provide function must return the received ProviderBuilder instance!");return this.builder=t,this}beforeInit(e){if("function"!=typeof e)throw new Error("BeforeInit handler must be a function!");return this.beforeInitHandler=e,this}onInit(e,t){if("function"!=typeof e)throw new Error("OnInit handler must be a function!");if(t&&!Array.isArray(t))throw new Error("OnInit handler dependency list must be an array!");return this.initHandler={provide:"initializer",useFactory:e,deps:t||void 0},this}bootstrapStrict(e){return this.bootstrap(e)}async bootstrap(e){if(this.bootstrapped)throw new Error("PulseModule is already bootstrapped!");if(this.bootstrapped)throw new Error("Cannot bootstrap child module!");if(this.imports.some(e=>e.bootstrapped))throw new Error("Cannot import already bootstrapped module! Only root module must be bootstrapped!");const t=await this.runModulesBeforeInit(e),i=this.getConfigOverride(t),s={provide:Se,useValue:i};return this.injector.register(s),await this.initializeModules(e),this.injector}getConfigOverride(e){try{if(_e()&&"undefined"!=typeof window&&p(window)){const t=window.localStorage.getItem(`${e.storagePrefix}config_override`);if(t){const i=JSON.parse(t);return i&&"object"==typeof i?{...e,...i}:(console.error("Configuration entry must be an object!"),e)}}}catch(e){console.error("Pulse configuration provided through localStorage is invalid!"),console.log(e)}return e}async initializeModules(e){const t=[...this.imports,this];for(const e of t)e.configureInjector();const i=t.map(t=>t.runOnInit(e));await Promise.all(i)}configureInjector(){if(this.parent&&this.imports.length)throw new Error("Deep module imports are not supported yet!");const e=this.parent?.injector,t=e?new Te(e):this.injector,i=this.builder._getProviders(),s=i.filter(e=>!1!==e.provideInRoot),n=i.filter(e=>!e.provideInRoot);t.register(...n),e?e.register(...s):s.length&&t.register(...s),this.injector=t}async runModulesBeforeInit(e){const t=await this.runBeforeInit(e),i=this.imports.map(t=>t.runBeforeInit(e));return{...t,...(await Promise.all(i)).reduce((e,t)=>({...e,...t}))}}async runBeforeInit(e){try{const t=this.beforeInitHandler?this.beforeInitHandler(e):void 0;return(t instanceof Promise?await t:t)||{}}catch(e){throw console.error("Module beforeInit hook failed!"),e}}async runOnInit(e){try{if(!this.initHandler?.useFactory)return;const t=(this.initHandler.deps||[]).map(e=>this.injector.get(e)),i=await Promise.all(t),s=this.initHandler.useFactory(e,...i);s instanceof Promise&&await s}catch(e){throw console.error(e),console.error("Module onInit hook failed!"),e}}}const Ie={settingsBaseURL:"https://optifyr.com/web/v2",timeout:1500,cacheTimeout:6e5,defaults:{},attributes:{},storagePrefix:"paa_",remoteSettingEnabled:!0},xe=new ye("Window"),Pe=new ye("STORAGE_SELECTOR"),Ne=new ye("COOKIE_BC"),Ae=new ye("UN_PREFIXED_COOKIE_STORAGE"),Oe=new ye("LOCK_MANAGER"),Re=new ye("PREFIXED_COOKIE_STORAGE");class Le{}class De extends Le{env;hrtTimeOrigin;constructor(e){super(),this.env=e;const t=this.now(),i=this.hrt(),s=e.win.performance.timeOrigin;this.hrtTimeOrigin=s??t-i}now(){return this.env.win.Date.now()}hrtTime(){return this.hrtTimeOrigin+this.env.win.performance.now()}hrt(){return this.env.win.performance.now()}timezoneOffset(){const e=new this.env.win.Date;return e.getTimezoneOffset&&e.getTimezoneOffset()}}class Me{env;constructor(e){this.env=e}push(e){this.env.win?.dataLayer&&this.env.win.dataLayer.push(e)}}var $e,Ue;!function(e){e.All="all",e.External="external",e.Internal="internal"}($e||($e={})),function(e){e.Start="start",e.Full="full"}(Ue||(Ue={}));var Be={now:function(){return(Be.delegate||Date).now()},delegate:void 0},je=function(e){function i(t,i,s){void 0===t&&(t=1/0),void 0===i&&(i=1/0),void 0===s&&(s=Be);var n=e.call(this)||this;return n._bufferSize=t,n._windowTime=i,n._timestampProvider=s,n._buffer=[],n._infiniteTimeWindow=!0,n._infiniteTimeWindow=i===1/0,n._bufferSize=Math.max(1,t),n._windowTime=Math.max(1,i),n}return t(i,e),i.prototype.next=function(t){var i=this,s=i.isStopped,n=i._buffer,r=i._infiniteTimeWindow,o=i._timestampProvider,a=i._windowTime;s||(n.push(t),!r&&n.push(o.now()+a)),this._trimBuffer(),e.prototype.next.call(this,t)},i.prototype._subscribe=function(e){this._throwIfClosed(),this._trimBuffer();for(var t=this._innerSubscribe(e),i=this._infiniteTimeWindow,s=this._buffer.slice(),n=0;n<s.length&&!e.closed;n+=i?1:2)e.next(s[n]);return this._checkFinalizedStatuses(e),t},i.prototype._trimBuffer=function(){var e=this,t=e._bufferSize,i=e._timestampProvider,s=e._buffer,n=e._infiniteTimeWindow,r=(n?1:2)*t;if(t<1/0&&r<s.length&&s.splice(0,s.length-r),!n){for(var o=i.now(),a=0,c=1;c<s.length&&s[c]<=o;c+=2)a=c;a&&s.splice(0,a+1)}},i}(z);class He{uuid;storage;cookieStorage;config;webToMobileService;storageChange;deviceId="";deviceIdSubject$=new je(1);constructor(e,t,i,s,n,r){this.uuid=e,this.storage=t,this.cookieStorage=i,this.config=s,this.webToMobileService=n,this.storageChange=r,this.cookieStorage.remove(this.config.keyDeviceId),this.registerStorageChangeListeners(),this.setDeviceId(this.fetchDeviceId().trim())}getDeviceId(){return this.deviceId}getDeviceId$(){return this.deviceIdSubject$.asObservable()}setDeviceId(e){if(e===this.deviceId||"string"!=typeof e||!e.trim())return;let t;const i=e.trim(),s=this.webToMobileService.getWebToMobileMetaInfo();t=s?.device_id?String(s.device_id):i;this.storage.get(this.config.keyDeviceId)!==t&&this.storage.set(this.config.keyDeviceId,t),this.deviceId=t,this.deviceIdSubject$.next(t)}generateDeviceId(){return this.uuid.generate()}registerStorageChangeListeners(){this.storage.change(this.config.keyDeviceId,Ue.Full,this.storageChange).subscribe(({value:e})=>{this.setDeviceId(e||"")})}fetchDeviceId(){return this.storage.get(this.config.keyDeviceId)||this.generateDeviceId()}}function Fe(e){const t=e.toLowerCase(),i=t.indexOf("?");return t.substring(0,i+1)+t.substring(i+1).split(/[#?]/g).join("&")}function Ve(e,t){if(e===t)return!0;if("object"!=typeof e||"object"!=typeof t||!e||!t)return!1;const i=e,s=t;return Object.keys({...i,...s}).every(e=>Ve(i[e],s[e]))}class qe{utmService;storage;page;trafficSourceSubject$=new je(1);constructor(e,t,i){this.utmService=e,this.storage=t,this.page=i;const s=this.getStoredTrafficSource();s&&this.trafficSourceSubject$.next(s)}getTrafficSource(){const e=this.utmService.getUTMParams(),t=this.getReferrer(),i=this.getClickId(t?.url),s=this.page.landingPageUrl();return e||i||t?{utmParams:e,clickId:i,referrer:t,landingPageURL:s}:null}getLastTrafficSource(){const e=this.getStoredTrafficSource(),t=this.getTrafficSource(),i=t?.referrer?.internal??!1;return this.changed(t?.clickId,e?.clickId)||this.changed(t?.utmParams,e?.utmParams)||this.changed(t?.referrer,e?.referrer)&&!i?(this.storage.setJSON("traffic_source",t),this.trafficSourceSubject$.next(t),t):e}getLastTrafficSource$(){return this.trafficSourceSubject$.asObservable()}getStoredTrafficSource(){return this.storage.getJSON("traffic_source")}getClickId(e){const{searchParams:t}=new URL(Fe(this.page.landingPageUrl())),i=t.get("gclid"),s=t.get("gclsrc")||t.get("wbraid")||t.get("gbraid"),n=t.get("msclkid"),r=t.get("fbclid"),o=t.get("yclid"),a=e?.includes("yahoo")?"yahoo":"yandex",c=t.get("dclid"),u=t.get("li_fat_id"),h=t.get("ttclid"),l=t.get("twclid");let d,p;return i?(d=i,p=s?`google.${s}`:"google"):r?(d=r,p="facebook"):n?(d=n,p="microsoft"):o?(d=o,p=a):c?(d=c,p="doubleclick"):u?(d=u,p="linkedin"):h?(d=h,p="tiktok"):l&&(d=l,p="twitter"),d&&p?{value:d,source:p}:void 0}getReferrer(){const e=this.page.referrer()||"";if(e)return{url:e,internal:this.isInternalURL(e)}}isInternalURL(e){return new URL(e).host===this.page.url().host}changed(e,t){return e&&!Ve(e,t)}}function Ke(e,t){return new Promise(i=>{const s=setTimeout(i,e);t&&(t.onabort=()=>{clearTimeout(s)})})}class ze{documentVisibility;env;date;logger;config;deviceIdService;get async(){return this.documentVisibility.visible}timeoutLimit=2e4;constructor(e,t,i,s,n,r){this.documentVisibility=e,this.env=t,this.date=i,this.logger=s,this.config=n,this.deviceIdService=r}async get(e,t,i){return this.retry(()=>this.trySendGetRequest(e,t,i),this.config.transportRetries,this.config.transportTimeout)}async post(e,t,i,s=!1){return await this.retry(()=>this.trySendPostRequest(e,t,s,i),this.config.transportRetries,this.config.transportTimeout)}async put(e,t,i){return(await this.env.win.fetch(e,{method:"PUT",headers:t,body:JSON.stringify(i)})).json()}async delete(e,t){return(await this.env.win.fetch(e,{method:"DELETE",headers:t})).json()}async retry(e,t=Number.MAX_SAFE_INTEGER,i=6e4){const s=this.date.now();let n=0;for(;;){const r=n<t;if(this.date.now()-s>i)throw new Error("Timedout!");if(!r)throw new Error("Max retries exeeded!");this.env.navigator.onLine||void 0===this.env.win.navigator.onLine||await this.waitForNetwork();try{const t=await e();if(t)return t;throw new Error("Request Failed!")}catch(e){this.logger.error(e);const t=this.backoffTime(++n);await Ke(t)}}}waitForNetwork(){return new Promise(e=>{if(this.env.win.navigator.onLine)return e();this.env.win.addEventListener("online",()=>{e()})})}succeeded(e){return"boolean"==typeof e?e:e>=200&&e<=400}backoffTime(e){if(!this.async&&e<10)return 0;const t=Math.floor(Math.pow(1e3,e/50)*this.config.transportRetryBackoffMS);return Math.min(this.config.transportRetryBackoffMaxMS,t)}fetchPossible(){const e=this.env.win,t="Request"in e&&"boolean"==typeof new Request("https://t.picsart.com").keepalive;return!("function"!=typeof e.fetch||!("AbortController"in e)||!this.async&&!t)}sendBeacon(e,t){return this.env.win.navigator.sendBeacon(`${t}/beacon`,e)}async trySendGetRequest(e,t,i){let s;if(this.env.win.navigator.onLine||void 0===this.env.win.navigator.onLine||await this.waitForNetwork(),this.fetchPossible()){const n=new AbortController,r=setTimeout(()=>n.abort(),this.timeoutLimit),o={method:"GET",headers:t,credentials:"include",signal:n.signal};"high"===i&&(o.priority=i);const a=await this.env.win.fetch(e,o);if(clearTimeout(r),!a)return{ok:!1,body:void 0,headers:new Map,status:400};const c=await(a?.json()),u=new Map(a.headers.entries());s={ok:a.ok,body:c,headers:u,status:a?.status},"object"==typeof s&&s?.headers.has("paa-did")&&this.replaceDeviceId(s.headers.get("paa-did"))}else s=await this.sendGetXHR(e,t,!0);return s}async trySendPostRequest(e,t,i,s){let n;if(this.env.win.navigator.onLine||void 0===this.env.win.navigator.onLine||await this.waitForNetwork(),this.fetchPossible()){let r,o,a;try{if(r=await this.env.win.fetch(`${e}/fetch`,{method:"POST",headers:t,body:JSON.stringify(s),credentials:"include",keepalive:i}),o=new Map(r.headers.entries()),a=await r.json(),r.status>=500)return!1;n={ok:4===r.status,body:a.body,headers:o,status:r.status}}catch{return!1}"object"==typeof n&&n?.headers.has("paa-did")&&this.replaceDeviceId(n.headers.get("paa-did"))}else if(i&&"function"==typeof this.env.win.navigator?.sendBeacon){if(this.sendBeacon(JSON.stringify(s),e))return!0;n=await this.sendPostXHR(JSON.stringify(s),!0,t,e)}else n=await this.sendPostXHR(JSON.stringify(s),!0,t,e);return n}async sendGetXHR(e,t,i){const s=this.env,n=this.config,r=new Promise((r,o)=>{try{const o=new s.win.XMLHttpRequest;i&&(o.timeout=n.transportTimeout,o.onreadystatechange=()=>{this.requestStateChange(o,r)}),o.open("GET",`${e}`,i),o.withCredentials=!0,o.timeout=this.timeoutLimit;for(const e in t)o.setRequestHeader(e,String(t[e]));o.send()}catch(e){o(e)}});return await r}sendPostXHR(e,t,i,s){return new Promise((n,r)=>{try{const r=new this.env.win.XMLHttpRequest;t&&(r.timeout=this.config.transportTimeout,r.onreadystatechange=()=>{this.requestStateChange(r,n)}),r.open("POST",`${s}/xhr`,t),r.withCredentials=!0;for(const e in i)r.setRequestHeader(e,String(i[e]));r.send(e),t||n(r.response)}catch(e){r(e)}})}requestStateChange(e,t){if(4===e.readyState){const i=this.succeeded(e.status),s=new Map;let n;e.getAllResponseHeaders().trim().split(/[\r\n]+/).forEach((e,t)=>{s.set(t.toString(),e)});try{n=JSON.parse(e.response)}catch{throw new Error(`${e.response} is not a JSON!`)}const r={ok:i,status:e.status,body:n,headers:s};"object"==typeof r&&r?.headers.has("paa-did")&&this.replaceDeviceId(s.get("paa-did")),t(r)}}replaceDeviceId(e){e&&this.deviceIdService.setDeviceId(e)}}function Ge(e){return"object"==typeof e&&e?Array.isArray(e)?e.map(e=>Ge(e)):Object.keys(e).sort().reduce((t,i)=>(t[i]=Ge(e[i]),t),{}):e}class Je{storage;crypto;date;KEY_ATTR_HASHES="hs";hashes=new Map;constructor(e,t,i){this.storage=e,this.crypto=t,this.date=i,this.refresh(),this.storage.change(this.KEY_ATTR_HASHES).subscribe(e=>this.refresh(e.value))}changed(e,t,i,s=!0){let n;n=null===t?"null":void 0===t?"undefined":"object"==typeof t?JSON.stringify(Ge(t)):"string"==typeof t?t:JSON.stringify(t);const r=this.date.now(),o=this.crypto.unsafeShortHash(e),a=this.crypto.unsafeShortHash(n),c=this.hashes.get(o),[u,h]=(c||"").split("."),l=parseInt(h||"0",36);return!(u===a&&(!i||l&&!(r-l>i)))&&(this.hashes.set(o,`${a}.${r.toString(36)}`),this.persist(),!(!s&&!c))}refresh(e){let t=e?JSON.parse(e):this.storage.getJSON(this.KEY_ATTR_HASHES);t&&Array.isArray(t.hs)||(t={hs:[]},this.storage.setJSON(this.KEY_ATTR_HASHES,t)),this.hashes=new Map(t.hs)}persist(){const e={hs:Array.from(this.hashes)};this.storage.setJSON(this.KEY_ATTR_HASHES,e)}}class We{storage;storageKey;storageChangeOrigin;state;stateSubject$=new je(1);constructor(e,t,i){this.storage=e,this.storageKey=t,this.storageChangeOrigin=i,this.registerStorageChangeListeners();const s=this.getState();this.stateSubject$.next(s)}setState(e){const t=this.getState(),i={...t,...e};Ve(t,i)||(this.state=i,this.storage.setJSON(this.storageKey,i),this.stateSubject$.next(i))}getState(){return this.state?this.state:this.refreshState()}getState$(){return this.stateSubject$.asObservable()}removePropertyFromState(e){const t=this.getState();if(e in t){const i={...t};delete i[e],Ve(t,i)||(this.state=i,this.storage.setJSON(this.storageKey,i),this.stateSubject$.next(i))}}refreshState(e){const t=e||this.storage.getJSON(this.storageKey)||this.state||{};return this.state=t,t}registerStorageChangeListeners(){this.storage.change(this.storageKey,Ue.Full,this.storageChangeOrigin).subscribe(({value:e})=>{const t=JSON.parse(e||"{}"),i=this.getState(),s=this.refreshState(t);Ve(i,s)||this.stateSubject$.next(s)})}}class Ye{env;constructor(e){this.env=e}async quoteSize(){return new Promise(e=>{try{"function"==typeof this.env.navigator?.storage?.estimate?navigator?.storage.estimate().then(t=>{e(t?.quota)}).catch(t=>{console.error(t),e(null)}):e(null)}catch(t){console.error(t),e(null)}})}}class Qe{env;constructor(e){this.env=e}pushData(e){this.env.win.dataLayer||(this.env.win.dataLayer=[]),this.env.win.dataLayer.push(e)}}class Xe{env;constructor(e){this.env=e}host(){return this.env.win.location.host}landingPageUrl(){return this.env.landingUrl.toLowerCase()}referrer(){return this.env.doc.referrer}href(){return this.env.win.location.href}url(){return new URL(this.env.win.location.href)}}class Ze{env;page;constructor(e,t){this.env=e,this.page=t}cleanupURL(e){const t=this.page.url();t.searchParams.has(e)&&(t.searchParams.delete(e),this.env.win.history.replaceState(this.env.win.history.state,this.env.doc.title,t.href))}}class et{env;registeredConrols=new Map;debugCtrlIconKey="pulse-debug-ctrl-icon";experimentIcon=`<svg class="${this.debugCtrlIconKey}"  width="16" height="16" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">\n                                <path d="M9 2C9 1.44772 9.44772 1 10 1H14C14.5523 1 15 1.44772 15 2V3C15 3.55228 14.5523 4 14 4H10C9.44772 4 9 3.55228 9 3V2Z" fill="#ff6d91"/>\n                                <path d="M6 8V6C6 5.44772 6.44772 5 7 5H17C17.5523 5 18 5.44772 18 6V8C18 8.55228 17.5523 9 17 9H7C6.44772 9 6 8.55228 6 8Z" fill="#ff6d91"/>\n                                <path d="M8 9H16L20 17C21 19 19.5 21 17 21H7C4.5 21 3 19 4 17L8 9Z" stroke="#ff6d91" stroke-width="2"/>\n                                <path d="M19 3H21M20 2V4M4 3H6M5 2V4M16 5H18M17 4V6" stroke="#ff6d91" stroke-width="2" stroke-linecap="round"/>\n                            </svg>`;debugIcon=`<svg class="${this.debugCtrlIconKey}" width="16" height="16" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">\n                            <path d="M10 2C9.44772 2 9 2.44772 9 3V4.07071C7.2845 4.55606 6 6.13616 6 8V10H4C3.44772 10 3 10.4477 3 11C3 11.5523 3.44772 12 4 12H6V14H4C3.44772 14 3 14.4477 3 15C3 15.5523 3.44772 16 4 16H6V18C6 19.8638 7.2845 21.4439 9 21.9293V23C9 23.5523 9.44772 24 10 24C10.5523 24 11 23.5523 11 23V22H13V23C13 23.5523 13.4477 24 14 24C14.5523 24 15 23.5523 15 23V21.9293C16.7155 21.4439 18 19.8638 18 18V16H20C20.5523 16 21 15.5523 21 15C21 14.4477 20.5523 14 20 14H18V12H20C20.5523 12 21 11.5523 21 11C21 10.4477 20.5523 10 20 10H18V8C18 6.13616 16.7155 4.55606 15 4.07071V3C15 2.44772 14.5523 2 14 2C13.4477 2 13 2.44772 13 3V4H11V3C11 2.44772 10.5523 2 10 2Z" fill="#ff6d91"/>\n                            <circle cx="17" cy="17" r="5" stroke="#ff6d91" stroke-width="2"/>\n                            <line x1="20.5" y1="20.5" x2="23" y2="23" stroke="#ff6d91" stroke-width="2"/>\n                        </svg>`;copyIcon=function(e){return`<svg \n            class="pulse-debug-ctrl-copy-icon"\n            onclick="(()=>{\n                try {\n                    navigator.clipboard.writeText('${e}');\n                } catch (err) {\n                    console.log('Failed to copy:', err);\n                }\n            })()" \n            width="12" height="12" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">\n            <rect x="8" y="4" width="12" height="14" rx="2" stroke="#ff6d91" stroke-width="2"/>\n            <path d="M6 8H5C3.89543 8 3 8.89543 3 10V18C3 19.1046 3.89543 20 5 20H13C14.1046 20 15 19.1046 15 18V17" stroke="#ff6d91" stroke-width="2"/>\n        </svg>`};constructor(e){this.env=e}registerControl({control:e,content:t,url:i,title:s="",deviceId:n="",callbackFn:r}){this.registeredConrols.has(e)||this.registeredConrols.set(e,this.displayControls({controlName:e,content:t,url:i,title:s,deviceId:n,callbackFn:r}))}unregisterControl(e){const t=this.registeredConrols.get(e);t&&(this.animateOut(t),this.registeredConrols.delete(e))}displayControls({controlName:e,content:t,url:i,title:s,deviceId:n,callbackFn:r}){const o=this.createElements({controlName:e,content:t,url:i,title:s,deviceId:n});return o.button.addEventListener("click",()=>{r()}),this.addStyles(e),this.animateIn(o),o}async animateIn(e){window.document.body.appendChild(e.fragment),await Ke(10),e.container.classList.add("active"),await Ke(500),e.container.classList.add("animate"),await Ke(1500),e.container.classList.remove("animate")}async animateOut(e){e.container.classList.remove("active"),await Ke(1e3),this.env.win.location.reload()}createElements({controlName:e,content:t,url:i,title:s,deviceId:n}){const r=window.document;let o,a;switch(e){case"experiment":o=this.experimentIcon,a="Exit preview";break;case"debug":o=this.debugIcon,a="Exit from debug mode"}const c=`${o}<div class="pulse-debug-ctrl-${e}-details">\n                                <div class="pulse-debug-ctrl-${e}-title">\n                                    <a href="${i}" title="${s}" target="_blank">${t}</a>\n                                </div>\n                            <div>\n                            ${n?`<p class="pulse-debug-ctrl-${e}-device-id">${n} ${this.copyIcon(n)}</p>`:""}\n                            <button>${a}</button>\n                            </div>\n                            </div>`,u=r.createElement("div");u.classList.add(`pulse-debug-ctrl-${e}-badge`),u.innerHTML=c;const h=r.createDocumentFragment();h.appendChild(u);const l=h.querySelector(`.pulse-debug-ctrl-${e}-details button`);return{container:u,fragment:h,button:l}}addStyles(e){const t=`\n        .pulse-debug-ctrl-${e}-badge {\n            display: flex;\n            position: fixed;\n            z-index: 9999999999;\n            box-sizing: border-box;\n            align-items: center;\n            width: 310px;\n            height: 60px;\n            bottom: ${"debug"===e?"55vh":"48vh"};\n            right: 0;\n            border: solid 1px #ff6d91;\n            border-right: none;\n            border-radius: 1000px;\n            border-top-right-radius: 0;\n            border-bottom-right-radius: 0;\n            box-shadow: 0 2px 25px rgba(255, 0, 130, 0.1);\n            color: #fff;\n            text-align: center;\n            font-family: sans-serif;\n            font-size: 10px;\n            background-color: #1b1b1b;\n            -webkit-user-select: none;\n            -ms-user-select: none;\n            user-select: none;\n            transition: transform 0.2s;\n            transform: translateX(345px);\n        }\n\n        .pulse-debug-ctrl-${e}-badge .pulse-debug-ctrl-copy-icon{\n            cursor: pointer;\n        }\n\n        .pulse-debug-ctrl-${e}-badge .${this.debugCtrlIconKey} {\n            margin: 0 10px 0 10px;\n        }\n\n        .pulse-debug-ctrl-${e}-badge.active {\n            transition-delay: 0.5s;\n            transform: translateX(275px);\n        }\n\n        .pulse-debug-ctrl-${e}-badge.active:hover {\n            transform: translateX(0);\n        }\n\n        .pulse-debug-ctrl-${e}-badge .pulse-debug-ctrl-${e}-details {\n            width: 10px;\n            flex-grow: 1111;\n        }\n        \n        .pulse-debug-ctrl-${e}-badge .pulse-debug-ctrl-${e}-device-id {\n            margin: 0px 0px 3px 0px;\n        }\n\n        .pulse-debug-ctrl-${e}-device-id {\n            cursor: pointer;\n        }\n\n        .pulse-debug-ctrl-${e}-badge .pulse-debug-ctrl-${e}-title {\n            white-space: nowrap;\n            overflow: hidden;\n            text-overflow: ellipsis;\n            width: 100%;\n            text-align: center;\n            padding: 0;\n            margin: 0 0 3px 0;\n            display: block;\n        }\n\n        .pulse-debug-ctrl-${e}-badge .pulse-debug-ctrl-${e}-title a {\n            color: #fff;\n            text-decoration: none;\n            padding: 0;\n            margin: 0;\n        }\n\n        .pulse-debug-ctrl-${e}-badge .pulse-debug-ctrl-${e}-title a:hover {\n            text-decoration: underline;\n        }\n\n        .pulse-debug-ctrl-${e}-badge button {\n            padding: 1px 5px;\n            border: solid 1px #ff6d91;\n            border-radius: 3px;\n            cursor: pointer;\n            background: none;\n            color: #ff6d91;\n            font-size: 10px;\n            transition: all 0.15s;\n        }\n\n        .pulse-debug-ctrl-${e}-badge button:hover {\n            color: #fff;\n            background-color: #bb1367;\n            border: solid 1px #bb1367;\n        }\n\n        .pulse-debug-ctrl-${e}-badge:before,\n        .pulse-debug-ctrl-${e}-badge:after {\n            position: absolute;\n            content: "";\n            display: block;\n            width: 140%;\n            height: 100%;\n            left: -20%;\n            z-index: -1000;\n            transition: all ease-in-out 0.5s;\n            background-repeat: no-repeat;\n        }\n\n        .pulse-debug-ctrl-${e}-badge:before {\n            display: none;\n            top: -75%;\n            background-image: radial-gradient(circle, #ff0081 20%, transparent 20%),\n                            radial-gradient(circle, transparent 20%, #ff0081 20%, transparent 30%),\n                            radial-gradient(circle, #ff0081 20%, transparent 20%),\n                            radial-gradient(circle, #ff0081 20%, transparent 20%),\n                            radial-gradient(circle, transparent 10%, #ff0081 15%, transparent 20%),\n                            radial-gradient(circle, #ff0081 20%, transparent 20%),\n                            radial-gradient(circle, #ff0081 20%, transparent 20%),\n                            radial-gradient(circle, #ff0081 20%, transparent 20%),\n                            radial-gradient(circle, #ff0081 20%, transparent 20%);\n            background-size: 10% 10%, 20% 20%, 15% 15%, 20% 20%, 18% 18%, 10% 10%, 15% 15%, 10% 10%, 18% 18%;\n        }\n\n        .pulse-debug-ctrl-${e}-badge:after {\n            display: none;\n            bottom: -75%;\n            background-image: radial-gradient(circle, #ff0081 20%, transparent 20%),\n                            radial-gradient(circle, #ff0081 20%, transparent 20%),\n                            radial-gradient(circle, transparent 10%, #ff0081 15%, transparent 20%),\n                            radial-gradient(circle, #ff0081 20%, transparent 20%),\n                            radial-gradient(circle, #ff0081 20%, transparent 20%),\n                            radial-gradient(circle, #ff0081 20%, transparent 20%),\n                            radial-gradient(circle, #ff0081 20%, transparent 20%);\n            background-size: 15% 15%, 20% 20%, 18% 18%, 20% 20%, 15% 15%, 10% 10%, 20% 20%;\n        }\n\n        .pulse-debug-ctrl-${e}-badge.animate:before {\n            display: block;\n            animation: topBubbles ease-in-out 0.75s forwards;\n        }\n\n        .pulse-debug-ctrl-${e}-badge.animate:after {\n            display: block;\n            animation: bottomBubbles ease-in-out 0.75s forwards;\n        }\n\n        @keyframes topBubbles {\n            0% {\n                background-position: 5% 90%, 10% 90%, 10% 90%, 15% 90%, 25% 90%, 25% 90%, 40% 90%, 55% 90%, 70% 90%;\n            }\n            50% {\n                background-position: 0 80%, 0% 20%, 10% 40%, 20% 0%, 30% 30%, 22% 50%, 50% 50%, 65% 20%, 90% 30%;\n            }\n            100% {\n                background-position: 0 70%, 0% 10%, 10% 30%, 20% -10%, 30% 20%, 22% 40%, 50% 40%, 65% 10%, 90% 20%;\n                background-size: 0 0%, 0% 0%, 0% 0%, 0% 0%, 0% 0%, 0% 0%;\n            }\n        }\n\n        @keyframes bottomBubbles {\n            0% {\n                background-position: 10% -10%, 30% 10%, 55% -10%, 70% -10%, 85% -10%, 70% -10%, 70% 0%;\n            }\n            50% {\n                background-position: 0 80%, 20% 80%, 45% 60%, 60% 100%, 75% 70%, 95% 60%, 105% 0%;\n            }\n            100% {\n                background-position: 0 90%, 20% 90%, 45% 70%, 60% 110%, 75% 80%, 95% 70%, 110% 10%;\n                background-size: 0 0%, 0% 0%, 0% 0%, 0% 0%, 0% 0%, 0% 0%;\n            }\n        }\n        `,i=document.head||document.getElementsByTagName("head")[0],s=document.createElement("style");s.appendChild(document.createTextNode(t)),i.appendChild(s)}}class tt{page;constructor(e){this.page=e}getUTMParams(){const e=new URL(Fe(this.page.landingPageUrl())),t=e.searchParams.get("utm_source"),i=e.searchParams.get("utm_medium"),s=e.searchParams.get("utm_campaign"),n=e.searchParams.get("utm_term")||"",r=e.searchParams.get("utm_content")||"";if(t||s)return{utm_source:t||void 0,utm_medium:i||void 0,utm_campaign:s||void 0,utm_term:n||void 0,utm_content:r||void 0}}}class it{}class st extends it{}class nt extends st{}class rt extends st{}class ot extends rt{}class at{unsafeShortHash(e){let t=5381,i=e.length;for(;i;)t=33*t^e.charCodeAt(--i);return t>>>=0,t.toString(36)}}class ct{pulseStorage;cookieStorage;dateService;responseTrackerService;cacheService;usageTrackerService;eventAdapterService;config;experiments=[];experimentsSubject$=new je(1);constructor(e,t,i,s,n,r,o,a){this.pulseStorage=e,this.cookieStorage=t,this.dateService=i,this.responseTrackerService=s,this.cacheService=n,this.usageTrackerService=r,this.eventAdapterService=o,this.config=a,this.cookieStorage.remove(this.config.experimentStorageKey),this.experiments=this.pulseStorage.getJSON(this.config.experimentStorageKey),this.experiments&&this.experiments.length>0&&this.experimentsSubject$.next(this.experiments),this.responseTrackerService.responses().subscribe(e=>{this.cacheResponse(e)}),this.usageTrackerService.usages().subscribe(e=>{const t=this.findUnparticipatedExperiment(e.key);t&&this.experiments&&(this.eventAdapterService.push({pulse:"event",event_type:"experiment_participate",data:{experiment_id:t.name,variant:t.variant}}),this.experiments=this.experiments.map(e=>{const t=void 0===e?.actual||e?.actual;return{...e,actual:t}}),this.cacheExperiments(this.experiments))}),this.pulseStorage.change(this.config.experimentStorageKey).subscribe(e=>{e.value?this.experiments=JSON.parse(e.value):this.experiments=[],this.experimentsSubject$.next(this.experiments||[])})}getExperiments(){return this.pulseStorage.getJSON(this.config.experimentStorageKey)||[]}getExperiments$(){return this.experimentsSubject$.asObservable()}getExperimentsString(){return this.getExperiments().map(e=>`${e.name}:${e.variant}`).join(",")}getExperimentsString$(){return this.experimentsSubject$.asObservable().pipe(ge(e=>e.map(e=>`${e.name}:${e.variant}`).join(",")))}fireExperimentPopulation(e){e&&e.length&&e.forEach(e=>{e.trackable&&this.eventAdapterService.push({pulse:"event",event_type:"experiment_populate",data:{experiment_id:e.name,variant:e.variant}})})}cacheResponse(e){if(!e.experiments)return;e.experiments=e.experiments.map(e=>({...e,actual:!0}));const t=this.findNewExperiments(e.experiments),i=this.experimentDifferent(e.experiments);t&&t.length&&(this.cacheService.removeCachedSettings(t),this.cacheExperiments(e.experiments)),t&&t.length||!i||this.cacheExperiments(e.experiments),this.fireExperimentPopulation(t)}cacheExperiments(e){const t=this.dateService.now(),i=this.getExperiments(),s=[...e.map(e=>{const s=i.find(t=>t.name===e.name),n=s?.participation_date||e?.participation_date||null,r=s?.participation_session||e?.participation_session||null;return{...e,participation_date:n,participation_session:r,time:t}}),...i.filter(t=>!e.some(e=>e.name===t.name)).map(e=>({...e,actual:!1}))];this.experiments=s,this.pulseStorage.remove(this.config.experimentStorageKey),this.pulseStorage.set(this.config.experimentStorageKey,JSON.stringify(s)),this.experimentsSubject$.next(s)}findNewExperiments(e){const t=this.getExperiments();if(!t)return e;return e.filter(e=>-1===t.findIndex(t=>t.name===e.name))}experimentDifferent(e){if(!this.experiments||!this.experiments.length)return!1;for(const t of this.experiments)if(-1===e.findIndex(e=>e.name===t.name))return!0;return!1}findUnparticipatedExperiment(e){if(!this.experiments||!this.experiments.length)return null;for(const t of this.experiments)if(t.settings?.includes(e)&&!t.participation_date)return t.participation_date=this.dateService.now(),t.participation_session=this.pulseStorage.get(this.config.keySessionID),t;return null}}class ut{responseTracker;storage;deviceId;date;storageKey;constructor(e,t,i,s){this.responseTracker=e,this.storage=t,this.deviceId=i,this.date=s,this.storageKey=`segments-${this.deviceId.getDeviceId().substring(0,5)}`,this.responseTracker.responses().subscribe(e=>{Array.isArray(e.segments)&&this.persist(e.segments)})}async getSegments(){const e=this.read();return e?.segments||[]}persist(e){this.storage.setJSON(this.storageKey,{segments:e,ts:this.date.now()})}read(){return this.storage.getJSON(this.storageKey)}}class ht{crypto;constructor(e){this.crypto=e}getAttributesFromQuery(e){const t={};return e.split(",").forEach(e=>{const[i,s]=e.split(".");t[i]=s}),t}getPulseScript(){if(document?.currentScript instanceof HTMLScriptElement)return new URLSearchParams(document?.currentScript.src);{const e=document.getElementsByTagName("script");for(let t=0;t<e.length;t++){const i=e[t].getAttribute("src");if(i&&i.match(/^(https?|http):\/\/[^/]+\/pulse\/[^/]+\/(module\/|nomodule\/)?pulse\.js/i))return new URLSearchParams(i)}}return null}getSettingsAttributes(e){const t=e.get("attr");return t?this.getAttributesFromQuery(t):{}}shouldReturnDefaultValue(e,t,i,s,n){if(!e)return!0;if(t.firstCallDone&&t.defaultReturned)return!0;const r="string"==typeof n?.cachedSetting.emptyForTags?n.cachedSetting.emptyForTags.split(","):[];return!(n?.timedOut||void 0!==n?.cachedSetting[i]||!r.includes(s))}getAttributesHash({tag:e,attributes:t,userRole:i,isTest:s,userId:n,tierId:r,deviceLastTierId:o,debugExperiment:a,appVersion:c}){return this.crypto.unsafeShortHash(`${e}-${i}-${s}-${n}-${r}-${o}-${a}-${JSON.stringify(t)}-${c}`)}}const lt={id:"",variant:"",app:"",name:"",url:""},dt={referrer:{url:"",internal:!1},landingPageURL:"",clickId:{source:"",value:""},utmParams:{utm_source:"",utm_medium:"",utm_campaign:"",utm_content:""}};class pt{responseTrackerService;deviceIdService;experimentsService;experimentDebugService;trafficSourceService;config;httpService;constructor(e,t,i,s,n,r,o){this.responseTrackerService=e,this.deviceIdService=t,this.experimentsService=i,this.experimentDebugService=s,this.trafficSourceService=n,this.config=r,this.httpService=o}composeRequestURL({app:e,app_version:t,tag:i,settingsBaseURL:s,deviceId:n,userId:r,tierId:o,deviceLastTierId:a,userRole:c,isTest:u,experiments:h,debugExperiment:l,trafficSource:d,attributes:p}){const g=new URL(`${s}/${e}/${i}`);if(g.searchParams.set("did",n),r&&g.searchParams.set("uid",r),o&&g.searchParams.set("tid",o),a&&g.searchParams.set("dltid",a),c&&g.searchParams.set("ur",c),u&&g.searchParams.set("is-test",u),t&&"0"!==t&&g.searchParams.set("versioncode",t),h&&g.searchParams.set("exp",h),l&&l!==lt&&g.searchParams.set("debug-exp",`${l.id}:${l.variant}`),d?.referrer&&d!==dt&&g.searchParams.set("ref",d.referrer.url),d?.clickId&&d!==dt&&g.searchParams.set("cidp",d.clickId.source),d?.utmParams&&d!==dt){const{utm_source:e,utm_medium:t,utm_campaign:i,utm_content:s}=d.utmParams;e&&g.searchParams.set("usrc",e),t&&g.searchParams.set("umed",t),i&&g.searchParams.set("ucmp",i),s&&g.searchParams.set("ucnt",s)}const f=Object.entries(p);if(f.length>0&&f.length<=10)for(const[e,t]of f)g.searchParams.set(`attr-${e}`,t);return g}handleResponse(e,t,i,s,n,r,o,a){i(t),this.cacheResponse(t,e,s,n,r,o,a)}async cacheResponse(e,t,i,s,n,r,o){let a;a=e.body instanceof ReadableStream&&e instanceof Response?await e.clone().json():e.body;const c={settings:a.settings,experiments:a.experiments,segments:a.segments,tag:t,emptyForTags:s,attributesHash:o};e&&"object"==typeof e&&200===e?.status&&a?.settings&&(r.firstCallDone||(n("firstCallDone",!0,r),n("defaultReturned",!1,r)),"object"!=typeof c.settings||null===c.settings||i in c.settings||(s.push(t),c.settings[i]=void 0),this.responseTrackerService.trackResponse(c))}createFakeResponse(e,t,i,s){return t.firstCallDone||(i("firstCallDone",!0,t),i("defaultReturned",!0,t)),{ok:!1,body:{settings:{},experiments:[],segments:[],tag:e,emptyForTags:[],attributesHash:s},headers:new Map([]),status:null}}async fetchSettings(e,t,i,s,n,r,o,a,c,u,h,l,d){if(!o.app)throw new Error("Application name has not been provided to settings SDK!");const p=this.composeRequestURL({tag:e,userRole:t,isTest:i,attributes:r,app:o.app,app_version:o.app_version||"0",deviceId:this.deviceIdService.getDeviceId(),userId:a?.toString()||null,tierId:c?.toString()||null,deviceLastTierId:u?.toString()||null,experiments:this.experimentsService.getExperimentsString(),debugExperiment:this.experimentDebugService.getDebugExperiment()||lt,trafficSource:this.trafficSourceService.getLastTrafficSource()||dt,settingsBaseURL:this.config.settingsBaseURL});return new Promise(t=>{const i=setTimeout(()=>t(this.createFakeResponse(e,h,l,d)),this.config.timeout);this.httpService.get(p.href,{},"high").then(r=>{clearTimeout(i),this.handleResponse(e,r,t,s,n,l,h,d)}).catch(()=>{clearTimeout(i),t(this.createFakeResponse(e,h,l,d))})})}}class gt{storage;cookieStorage;page;config;routeHelper;debugControlService;experiment=null;experimentSubject$=new je(1);constructor(e,t,i,s,n,r){this.storage=e,this.cookieStorage=t,this.page=i,this.config=s,this.routeHelper=n,this.debugControlService=r;const o=new URL(this.page.landingPageUrl()).searchParams.get("pulse-debug-exp")||this.storage.get("debug-exp"),a=this.parseExperimentInfo(o);this.cookieStorage.remove("debug-exp"),this.routeHelper.cleanupURL("pulse-debug-exp"),o&&a?(o&&this.storage.set("debug-exp",o),this.setExperiment(a),this.debugControlService.registerControl({control:"experiment",url:a.url,title:`Debugging Experiment [${a.id}]: ${a.name}\n\nVariant: ${a.variant}`,callbackFn:this.stopDebugging.bind(this),content:`${a.variant} ${a.name}`})):this.experimentSubject$.next(null)}getDebugExperiment(){return this.experiment}getDebugExperiment$(){return this.experimentSubject$.asObservable()}setExperiment(e){this.experiment=e,this.experimentSubject$.next(e)}stopDebugging(){this.setExperiment(null),this.storage.remove("debug-exp"),this.debugControlService.unregisterControl("experiment")}parseExperimentInfo(e){if("string"!=typeof e||!e.length)return null;try{const[t,i,s,n,r]=JSON.parse(e);return t!==this.config.app?null:{app:t,id:i,name:s,variant:n,url:r}}catch(e){return console.error("Failed to parse debug experiment info!"),console.error(e),null}}}var ft=Array.isArray,vt=Object.getPrototypeOf,bt=Object.prototype,mt=Object.keys;function yt(e){if(1===e.length){var t=e[0];if(ft(t))return{args:t,keys:null};if((s=t)&&"object"==typeof s&&vt(s)===bt){var i=mt(t);return{args:i.map(function(e){return t[e]}),keys:i}}}var s;return{args:e,keys:null}}function St(e,t,i,s,n){void 0===s&&(s=0),void 0===n&&(n=!1);var r=t.schedule(function(){i(),n?e.add(this.schedule(null,s)):this.unsubscribe()},s);if(e.add(r),!n)return r}function wt(e,t){return void 0===t&&(t=0),Q(function(i,s){i.subscribe(X(s,function(i){return St(s,e,function(){return s.next(i)},t)},function(){return St(s,e,function(){return s.complete()},t)},function(i){return St(s,e,function(){return s.error(i)},t)}))})}function _t(e,t){return void 0===t&&(t=0),Q(function(i,s){s.add(e.schedule(function(){return i.subscribe(s)},t))})}function Et(e,t){if(!e)throw new Error("Iterable cannot be null");return new V(function(i){St(i,t,function(){var s=e[Symbol.asyncIterator]();St(i,t,function(){s.next().then(function(e){e.done?i.complete():i.next(e.value)})},0,!0)})})}function Tt(e,t){if(null!=e){if(se(e))return function(e,t){return le(e).pipe(_t(t),wt(t))}(e,t);if(te(e))return function(e,t){return new V(function(i){var s=0;return t.schedule(function(){s===e.length?i.complete():(i.next(e[s++]),i.closed||this.schedule())})})}(e,t);if(ie(e))return function(e,t){return le(e).pipe(_t(t),wt(t))}(e,t);if(ne(e))return Et(e,t);if(ce(e))return function(e,t){return new V(function(i){var s;return St(i,t,function(){s=e[ae](),St(i,t,function(){var e,t,n;try{t=(e=s.next()).value,n=e.done}catch(e){return void i.error(e)}n?i.complete():i.next(t)},0,!0)}),function(){return v(null==s?void 0:s.return)&&s.return()}})}(e,t);if(he(e))return function(e,t){return Et(ue(e),t)}(e,t)}throw re(e)}function kt(e,t){return t?Tt(e,t):le(e)}var Ct=Array.isArray;function It(e){return ge(function(t){return function(e,t){return Ct(t)?e.apply(void 0,c([],a(t))):e(t)}(e,t)})}function xt(e){return e&&v(e.schedule)}function Pt(e){return e[e.length-1]}function Nt(e){return xt(Pt(e))?e.pop():void 0}function At(){for(var e=[],t=0;t<arguments.length;t++)e[t]=arguments[t];var i=Nt(e),s=function(e){return v(Pt(e))?e.pop():void 0}(e),n=yt(e),r=n.args,o=n.keys;if(0===r.length)return kt([],i);var a=new V(function(e,t,i){void 0===i&&(i=H);return function(s){Ot(t,function(){for(var n=e.length,r=new Array(n),o=n,a=n,c=function(n){Ot(t,function(){var c=kt(e[n],t),u=!1;c.subscribe(X(s,function(e){r[n]=e,u||(u=!0,a--),a||s.next(i(r.slice()))},function(){--o||s.complete()}))},s)},u=0;u<n;u++)c(u)},s)}}(r,i,o?function(e){return function(e,t){return e.reduce(function(e,i,s){return e[i]=t[s],e},{})}(o,e)}:H));return s?a.pipe(It(s)):a}function Ot(e,t,i){e?St(i,e,t):t()}function Rt(e,t,i){return void 0===i&&(i=1/0),v(t)?Rt(function(i,s){return ge(function(e,n){return t(i,e,s,n)})(le(e(i,s)))},i):("number"==typeof t&&(i=t),Q(function(t,s){return function(e,t,i,s,n,r,o,a){var c=[],u=0,h=0,l=!1,d=function(){!l||c.length||u||t.complete()},p=function(e){return u<s?g(e):c.push(e)},g=function(e){r&&t.next(e),u++;var a=!1;le(i(e,h++)).subscribe(X(t,function(e){null==n||n(e),r?p(e):t.next(e)},function(){a=!0},void 0,function(){if(a)try{u--;for(var e=function(){var e=c.shift();o?St(t,o,function(){return g(e)}):g(e)};c.length&&u<s;)e();d()}catch(e){t.error(e)}}))};return e.subscribe(X(t,p,function(){l=!0,d()})),function(){null==a||a()}}(t,s,e,i)}))}function Lt(e){return void 0===e&&(e=1/0),Rt(H,e)}function Dt(){for(var e=[],t=0;t<arguments.length;t++)e[t]=arguments[t];return Lt(1)(kt(e,Nt(e)))}function Mt(){for(var e=[],t=0;t<arguments.length;t++)e[t]=arguments[t];var i=Nt(e);return Q(function(t,s){(i?Dt(e,t,i):Dt(e,t)).subscribe(s)})}class $t{settingsHelper;settingsFetchHelper;cacheService;config;usageTrackerService;experimentDebugService;hashStore;lockManager;queueService;userRoleService;isTestService;stateService;observers=new Map;subjects=new Map;revalidate=new z;firstCallState={firstCallDone:!1,defaultReturned:!1};lock=[];syncIndexedDB;constructor(e,t,i,s,n,r,o,a,c,u,h,l){this.settingsHelper=e,this.settingsFetchHelper=t,this.cacheService=i,this.config=s,this.usageTrackerService=n,this.experimentDebugService=r,this.hashStore=o,this.lockManager=a,this.queueService=c,this.userRoleService=u,this.isTestService=h,this.stateService=l,this.userRoleService.setFromQueryParams(),this.isTestService.setFromQueryParams(),this.getPrefetchSettings(),At({state:this.stateService.getState$().pipe(Mt(this.stateService.getState())),userRole:this.userRoleService.getValue$().pipe(Mt(this.userRoleService.getValue())),isTest:this.isTestService.getValue$().pipe(Mt(this.isTestService.getValue()))}).subscribe({next:({state:e,userRole:t,isTest:i})=>{this.refreshStateProps({state:e,userRole:t||"",isTest:i||""})}}),this.syncIndexedDB=this.cacheService.updateInMemorySettings()}observe(e,t,i,s,n){return new V(r=>{this.observers.set(t,[...this.observers.get(t)||[],r]);const o=this.subjects.get(t),a=(o||this.getSettings(e,t,i,s,n)).subscribe(r);return()=>{const e=this.observers.get(t)?.filter(e=>e!==r)||[];0===e.length?this.observers.delete(t):this.observers.set(t,e),a.unsubscribe()}})}getSettings(e,t,i,s,n){return new V(r=>{this.get(e,t,i,s,n).then(e=>{r.next(e)});const o=this.revalidate.subscribe(()=>{this.get(e,t,i,s,n).then(e=>{r.next(e)})});return()=>{o.unsubscribe()}})}async get(e,t,i,s=!0,n){const r=void 0!==i?i:this.config.defaults[t];if(this.settingsHelper.shouldReturnDefaultValue(s,this.firstCallState,t,e,this.cacheService.getCachedSettings(t)))return this.usageTrackerService.trackUsage(e,t,r);const o=this.experimentDebugService.getDebugExperiment(),a=o?`${this.config.app}:${o.id}:${o.variant}`:null;let c;this.hashStore.changed("debug-experiment",a)&&this.cacheService.clearCache(),await this.syncIndexedDB;const u=this.cacheService.getCachedSettings(t),h="string"==typeof u?.cachedSetting.emptyForTags?u.cachedSetting.emptyForTags.split(","):[],l=u?.cachedSetting?.attributesHash,d=this.userRoleService.getValue()||"",p=this.isTestService.getValue(),g=this.settingsHelper.getAttributesHash({tag:e,userRole:String(d??""),isTest:String(p??""),userId:String(this.stateService.getState().user_id??""),tierId:String(this.stateService.getState().tier_id??""),deviceLastTierId:String(this.stateService.getState().device_last_tier_id??""),debugExperiment:o?`${o.id}:${o.variant}`:"",attributes:n||{},appVersion:this.config.app_version||"0"});if(u?.cachedSetting&&l!==g&&(u.timedOut=!0),!u?.timedOut&&void 0===u?.cachedSetting[t]&&h.includes(e))return this.usageTrackerService.trackUsage(e,t,r);if(void 0!==u&&u.cachedSetting&&!u.timedOut&&void 0!==u.cachedSetting[t])return this.usageTrackerService.trackUsage(e,t,u.cachedSetting[t]);if(this.lock.includes(g))return await this.queueService.waitQueueOpen(g,this.config.timeout,this.lock),this.getFromCacheAndReturn({settingName:t,settingDefaultValue:r,tag:e,userRole:d,isTest:p,debugExperiment:o,attributes:n});this.lock.push(g);if(await this.lockManager.locked(g))return await this.queueService.waitQueueOpen(g,this.config.timeout,this.lock),await this.getFromCacheAndReturn({settingName:t,settingDefaultValue:r,tag:e,userRole:d,isTest:p,debugExperiment:o,attributes:n});{this.lock.includes(g)||this.lock.push(g);const i=await this.lockManager.request(g,this.config.timeout);c=await this.settingsFetchHelper.fetchSettings(e,d,p,t,h,n||{},this.config,String(this.stateService.getState().user_id??""),String(this.stateService.getState().tier_id??""),String(this.stateService.getState().device_last_tier_id??""),this.firstCallState,this.mutateFirstCallState,g);const s=c?.body?.settings;let o=s&&s[t];return void 0===o&&(o=u?.cachedSetting[t]||r),this.lock.includes(g)&&this.lock.splice(this.lock.indexOf(g),1),i&&this.lockManager.release(i),this.usageTrackerService.trackUsage(e,t,o)}}getFromCacheAndReturn({settingName:e,settingDefaultValue:t,tag:i,userRole:s,isTest:n,debugExperiment:r,attributes:o}){const a=this.settingsHelper.getAttributesHash({tag:i,userRole:String(s??""),isTest:String(n??""),userId:String(this.stateService.getState().user_id??""),tierId:String(this.stateService.getState().tier_id??""),deviceLastTierId:String(this.stateService.getState().device_last_tier_id??""),debugExperiment:r?`${r.id}:${r.variant}`:"",attributes:o||{},appVersion:this.config.app_version||"0"});this.lock.includes(a)&&this.lock.splice(this.lock.indexOf(a),1);const c=this.cacheService.getCachedSettings(e);let u;if(c?.cachedSetting&&void 0!==c?.cachedSetting[e])u=c?.cachedSetting[e];else{const t="string"==typeof c?.cachedSetting.emptyForTags?c.cachedSetting.emptyForTags.split(","):[];t.includes(i)||t.push(i),this.cacheService.cacheSettings({[e]:void 0},i,t,a)}return u=void 0!==u?u:t,this.usageTrackerService.trackUsage(i,e,u)}refreshStateProps({state:e,userRole:t,isTest:i}){const s=e.user_id,n=e.tier_id,r=e.device_last_tier_id;(this.hashStore.changed("user_id",s)||this.hashStore.changed("tier_id",n)||this.hashStore.changed("device_last_tier_id",r)||this.hashStore.changed("user_role",t)||this.hashStore.changed("is_test",i))&&this.revalidate.next(!0)}getPrefetchSettings(){let e="";const t=this.settingsHelper.getPulseScript();if(t&&(e=t.get("prefetch")),e&&t){const i=this.settingsHelper.getSettingsAttributes(t);e.split(",").forEach(e=>{this.get(e,`${this.config.storagePrefix}${e}_prefetched`,{},!0,i)})}}mutateFirstCallState(e,t,i){i?i[e]=t:this.firstCallState[e]=t}}class Ut{pulseStorage;cookieStorage;STORAGE_KEY;value=null;valueSubject$=new je(1);constructor(e,t,i){this.pulseStorage=e,this.cookieStorage=t,this.STORAGE_KEY=i,this.subscribeToChanges(),this.cookieStorage.remove(this.STORAGE_KEY)}subscribeToChanges(){this.pulseStorage.change(this.STORAGE_KEY).subscribe(e=>{this.setValue(e.value)})}setValue(e){e!==this.value&&(this.value=e,this.valueSubject$.next(e))}getValue(){return this.value}getValue$(){return this.valueSubject$.asObservable()}setFromQueryParams(){let e=this.pulseStorage.get(this.STORAGE_KEY);if(null===e&&document?.currentScript instanceof HTMLScriptElement){e=new URLSearchParams(document?.currentScript.src).get(this.STORAGE_KEY)}this.setValue(e)}}class Bt extends Ut{pulseStorage;cookieStorage;STORAGE_KEY;constructor(e,t,i="ur"){super(e,t,i),this.pulseStorage=e,this.cookieStorage=t,this.STORAGE_KEY=i}}class jt extends Ut{pulseStorage;cookieStorage;STORAGE_KEY;constructor(e,t,i="is-test"){super(e,t,i),this.pulseStorage=e,this.cookieStorage=t,this.STORAGE_KEY=i}}function Ht(e,t){return void 0===t&&(t=H),e=null!=e?e:Ft,Q(function(i,s){var n,r=!0;i.subscribe(X(s,function(i){var o=t(i);!r&&e(n,o)||(r=!1,n=o,s.next(i))}))})}function Ft(e,t){return e===t}var Vt=new V(function(e){return e.complete()});function qt(e){return e<=0?function(){return Vt}:Q(function(t,i){var s=0;t.subscribe(X(i,function(t){++s<=e&&(i.next(t),e<=s&&i.complete())}))})}var Kt=function(e){function i(t,i){return e.call(this)||this}return t(i,e),i.prototype.schedule=function(e,t){return void 0===t&&(t=0),this},i}(S),zt={setInterval:function(e,t){for(var i=[],s=2;s<arguments.length;s++)i[s-2]=arguments[s];var n=zt.delegate;return(null==n?void 0:n.setInterval)?n.setInterval.apply(n,c([e,t],a(i))):setInterval.apply(void 0,c([e,t],a(i)))},clearInterval:function(e){var t=zt.delegate;return((null==t?void 0:t.clearInterval)||clearInterval)(e)},delegate:void 0},Gt=function(e){function i(t,i){var s=e.call(this,t,i)||this;return s.scheduler=t,s.work=i,s.pending=!1,s}return t(i,e),i.prototype.schedule=function(e,t){var i;if(void 0===t&&(t=0),this.closed)return this;this.state=e;var s=this.id,n=this.scheduler;return null!=s&&(this.id=this.recycleAsyncId(n,s,t)),this.pending=!0,this.delay=t,this.id=null!==(i=this.id)&&void 0!==i?i:this.requestAsyncId(n,this.id,t),this},i.prototype.requestAsyncId=function(e,t,i){return void 0===i&&(i=0),zt.setInterval(e.flush.bind(e,this),i)},i.prototype.recycleAsyncId=function(e,t,i){if(void 0===i&&(i=0),null!=i&&this.delay===i&&!1===this.pending)return t;null!=t&&zt.clearInterval(t)},i.prototype.execute=function(e,t){if(this.closed)return new Error("executing a cancelled action");this.pending=!1;var i=this._execute(e,t);if(i)return i;!1===this.pending&&null!=this.id&&(this.id=this.recycleAsyncId(this.scheduler,this.id,null))},i.prototype._execute=function(e,t){var i,s=!1;try{this.work(e)}catch(e){s=!0,i=e||new Error("Scheduled action threw falsy error")}if(s)return this.unsubscribe(),i},i.prototype.unsubscribe=function(){if(!this.closed){var t=this.id,i=this.scheduler,s=i.actions;this.work=this.state=this.scheduler=null,this.pending=!1,y(s,this),null!=t&&(this.id=this.recycleAsyncId(i,t,null)),this.delay=null,e.prototype.unsubscribe.call(this)}},i}(Kt),Jt=function(){function e(t,i){void 0===i&&(i=e.now),this.schedulerActionCtor=t,this.now=i}return e.prototype.schedule=function(e,t,i){return void 0===t&&(t=0),new this.schedulerActionCtor(this,e).schedule(i,t)},e.now=Be.now,e}(),Wt=new(function(e){function i(t,i){void 0===i&&(i=Jt.now);var s=e.call(this,t,i)||this;return s.actions=[],s._active=!1,s}return t(i,e),i.prototype.flush=function(e){var t=this.actions;if(this._active)t.push(e);else{var i;this._active=!0;do{if(i=e.execute(e.state,e.delay))break}while(e=t.shift());if(this._active=!1,i){for(;e=t.shift();)e.unsubscribe();throw i}}},i}(Jt))(Gt),Yt=Wt;function Qt(e){return e instanceof Date&&!isNaN(e)}var Xt,Zt=b(function(e){return function(t){void 0===t&&(t=null),e(this),this.message="Timeout has occurred",this.name="TimeoutError",this.info=t}});function ei(e){throw new Zt(e)}function ti(){for(var e=[],t=0;t<arguments.length;t++)e[t]=arguments[t];return kt(e,Nt(e))}class ii{settingsObserver;config;experimentsService;segmentsResolver;firstCallState={firstCallDone:!1,defaultReturned:!1};constructor(e,t,i,s){this.settingsObserver=e,this.config=t,this.experimentsService=i,this.segmentsResolver=s}observe(e,t,i,s=!0,n){return new V(r=>{const o=this.settingsObserver.observe(e,t,i,s,n).pipe(Ht()),a=o.pipe(qt(1),function(e,t){var i=Qt(e)?{first:e}:"number"==typeof e?{each:e}:e,s=i.first,n=i.each,r=i.with,o=void 0===r?ei:r,a=i.scheduler,c=void 0===a?null!=t?t:Wt:a,u=i.meta,h=void 0===u?null:u;if(null==s&&null==n)throw new TypeError("No timeout provided.");return Q(function(e,t){var i,r,a=null,u=0,l=function(e){r=St(t,c,function(){try{i.unsubscribe(),le(o({meta:h,lastValue:a,seen:u})).subscribe(t)}catch(e){t.error(e)}},e)};i=e.subscribe(X(t,function(e){null==r||r.unsubscribe(),u++,t.next(a=e),n>0&&l(n)},void 0,void 0,function(){(null==r?void 0:r.closed)||null==r||r.unsubscribe(),a=null})),!u&&l(null!=s?"number"==typeof s?s:+s-c.now():n)})}(this.config.timeout),pe(()=>ti(i))),c=o.pipe((u=1,ee(function(e,t){return u<=t})));var u;var h,l;const d=a.pipe((h=e=>c.pipe(Mt(e)),v(l)?Rt(h,l,1):Rt(h,1))).subscribe(r);return()=>{d.unsubscribe()}})}async get(e,t,i,s=!0,n){return Y(this.observe(e,t,i,s,n))}async getSegments(e={}){let t=await this.segmentsResolver.getSegments();return t&&!(t?.length<1)||this.firstCallState.firstCallDone||(await this.get("dummy_tag",`${this.config.storagePrefix}_dummy_tag`,{},!0,e),t=await this.segmentsResolver.getSegments()),Promise.resolve(this.segmentsResolver.getSegments())}async getExperiments(e={}){let t=this.experimentsService.getExperiments();return t&&!(t?.length<1)||this.firstCallState.firstCallDone||(await this.get("dummy_tag",`${this.config.storagePrefix}_dummy_tag`,{},!0,e),t=this.experimentsService.getExperiments()),Promise.resolve(t)}}class si{settingsService;constructor(e){this.settingsService=e}createPulseSettings(e={},t=!0,i={}){const s=this.settingsService;return{async get(n,r,o){const a=e?.[r];if(!0===o){const e=s.observe(n,r,a,t,i);return{value:await Y(e),subscribe:e.subscribe.bind(e)}}return s.get(n,r,a,t,i)},getValue(n,r,o){const a=o??e?.[r];return s.get(n,r,a,t,i)},observe:(e,n,r)=>s.observe(e,n,r,t,i),getSegmentsIds:()=>s.getSegments(i),getExperiments:()=>s.getExperiments(i)}}}function ni(e,t){return void 0===t&&(t=Wt),Q(function(i,s){var n=null,r=null,o=null,a=function(){if(n){n.unsubscribe(),n=null;var e=r;r=null,s.next(e)}};function c(){var i=o+e,r=t.now();if(r<i)return n=this.schedule(void 0,i-r),void s.add(n);a()}i.subscribe(X(s,function(i){r=i,o=t.now(),n||(n=t.schedule(c,e),s.add(n))},function(){a(),s.complete()},void 0,function(){r=n=null}))})}!function(e){e[e.DEVICE_ID=0]="DEVICE_ID",e[e.USER_ID=1]="USER_ID",e[e.IS_TEST=2]="IS_TEST",e[e.EXPERIMENTS=3]="EXPERIMENTS",e[e.DEBUG_EXPERIMENTS=4]="DEBUG_EXPERIMENTS",e[e.REFERRER=5]="REFERRER",e[e.INTERNAL_REFERRER=6]="INTERNAL_REFERRER",e[e.UTM_CAMPAIGN=7]="UTM_CAMPAIGN",e[e.UTM_SOURCE=8]="UTM_SOURCE",e[e.UTM_MEDIUM=9]="UTM_MEDIUM",e[e.CLICK_ID=10]="CLICK_ID",e[e.CLICK_ID_SRC=11]="CLICK_ID_SRC",e[e.TIER_ID=12]="TIER_ID",e[e.DEVICE_LAST_TIER_ID=13]="DEVICE_LAST_TIER_ID",e[e.USER_ROLE=14]="USER_ROLE",e[e.ATTRIBUTES=15]="ATTRIBUTES"}(Xt||(Xt={}));class ri{storage;cookieStorage;config;deviceIdService;experimentsService;utmService;trafficSourceService;userRoleService;settingsHelper;stateService;isTestService;experimentDebugService;syncCookieSubject=new z;pendingUpdates={};constructor(e,t,i,s,n,r,o,a,c,u,h,l){this.storage=e,this.cookieStorage=t,this.config=i,this.deviceIdService=s,this.experimentsService=n,this.utmService=r,this.trafficSourceService=o,this.userRoleService=a,this.settingsHelper=c,this.stateService=u,this.isTestService=h,this.experimentDebugService=l,this.syncCookieSubject.pipe(ni(50)).subscribe(()=>{this.executeSyncCookie(),this.pendingUpdates={}});const d=this.parseCookie(this.cookieStorage.get(this.config.keyPulseSyncCookie)||"");d&&this.updatePulseStateFromCookie(d)}startService(){this.registerStateChangeListeners()}updatePulseStateFromCookie(e){if(e[Xt.DEVICE_ID]&&this.deviceIdService.setDeviceId(e[Xt.DEVICE_ID]),e[Xt.EXPERIMENTS]){const t=this.parseExperimentsFromCookie(e[Xt.EXPERIMENTS]);t.length>0&&this.experimentsService.cacheResponse({experiments:t,emptyForTags:[],attributesHash:""})}}parseExperimentsFromCookie(e){if(!e||!e.trim())return[];try{const t=decodeURIComponent(e);return t.split(",").map(e=>{const[t,i]=e.split(":");return{name:t.trim(),variant:i.trim(),trackable:1,settings:[],participation_session:null,participation_date:null}})}catch(e){return console.error("Failed to parse experiments from cookie:",e),[]}}serializeAttributesForCookie(e){if(!e||0===Object.keys(e).length)return"";const t=new URLSearchParams;return Object.entries(e).forEach(([e,i])=>{i&&t.set(e,i)}),t.toString()}setSyncCookie(e){Object.assign(this.pendingUpdates,e),this.syncCookieSubject.next(e)}executeSyncCookie(){const e=this.deviceIdService.getDeviceId(),t=this.experimentsService.getExperimentsString(),i=this.trafficSourceService.getLastTrafficSource(),s=this.utmService.getUTMParams(),n=this.userRoleService.getValue(),r=this.isTestService.getValue(),o=this.config.attributes;let a="";if(o){const e=this.serializeAttributesForCookie(o);a=e?encodeURIComponent(e):""}const c=this.experimentDebugService.getDebugExperiment(),u=c?`${c.id}:${c.variant}`:"",h=[e,this.storage.get("userId")||"",r||"",t||"",u,i?.referrer?.url||"",i?.referrer?.internal?"true":"",s?.utm_campaign||"",s?.utm_source||"",s?.utm_medium||"",i?.clickId?.value||"",i?.clickId?.source||"",this.storage.get("tierId")||"",this.storage.get("deviceLastTierId")||"",n||"",a];Object.entries(this.pendingUpdates).forEach(([e,t])=>{const i=Xt[e];"number"==typeof i&&void 0!==t&&(h[i]=t)}),this.cookieStorage.set(this.config.keyPulseSyncCookie,h.join("|"))}registerStateChangeListeners(){this.deviceIdService.getDeviceId$().subscribe(e=>{this.setSyncCookie({DEVICE_ID:e})}),this.stateService.getState$().pipe(ge(e=>({user_id:String(e?.user_id||""),tier_id:String(e?.tier_id||""),device_last_tier_id:String(e?.device_last_tier_id||"")})),Ht((e,t)=>e.user_id===t.user_id&&e.tier_id===t.tier_id&&e.device_last_tier_id===t.device_last_tier_id)).subscribe(({user_id:e,tier_id:t,device_last_tier_id:i})=>{this.setSyncCookie({USER_ID:e,TIER_ID:t,DEVICE_LAST_TIER_ID:i})}),this.isTestService.getValue$().subscribe(e=>{this.setSyncCookie({IS_TEST:e||""})}),this.experimentsService.getExperimentsString$().subscribe(e=>{this.setSyncCookie({EXPERIMENTS:e||""})}),this.experimentDebugService.getDebugExperiment$().subscribe(e=>{const t=e?`${e.id}:${e.variant}`:"";this.setSyncCookie({DEBUG_EXPERIMENTS:t})}),this.trafficSourceService.getLastTrafficSource$().subscribe(e=>{this.setSyncCookie({REFERRER:e?.referrer?.url||"",INTERNAL_REFERRER:e?.referrer?.internal?"true":"",CLICK_ID:e?.clickId?.value||"",CLICK_ID_SRC:e?.clickId?.source||"",UTM_CAMPAIGN:e?.utmParams?.utm_campaign||"",UTM_SOURCE:e?.utmParams?.utm_source||"",UTM_MEDIUM:e?.utmParams?.utm_medium||""})}),this.userRoleService.getValue$().subscribe(e=>{this.setSyncCookie({USER_ROLE:e||""})})}parseCookie(e){if(!e)return null;const t=e.split("|");return 16===t.length?t.slice(0,16):null}}function oi(e){if(null===e||"object"!=typeof e)return e;if("function"==typeof globalThis.structuredClone)try{return globalThis.structuredClone(e)}catch{console.warn("structuredClone failed, falling back to deepClonePruningNonStructured",e)}else try{return JSON.parse(JSON.stringify(e))}catch(e){console.warn("Deep clone failed using JSON fallback.",e)}return ai(e)}function ai(e,t=new WeakMap){if(null===e)return null;const i=typeof e;if("object"!==i){if("function"===i||"symbol"===i||"bigint"===i)return;return"number"!==i||Number.isFinite(e)?e:null}const s=e,n=t.get(s);if(n)return n;if(Array.isArray(s)){const e=new Array(s.length);t.set(s,e);for(let i=0;i<e.length;i+=1){const n=ai(s[i],t);e[i]=void 0===n?null:n}return e}const r=Object.getPrototypeOf(s);if(r!==Object.prototype&&null!==r)return;const o={};t.set(s,o);for(const[e,i]of Object.entries(s)){const s=ai(i,t);void 0!==s&&(o[e]=s)}return o}class ci{indexedDBService;dateService;responseTrackerService;quote;config;settingStorageKey="settingsStore";storedSettings={};constructor(e,t,i,s,n){this.indexedDBService=e,this.dateService=t,this.responseTrackerService=i,this.quote=s,this.config=n,this.responseTrackerService.responses().subscribe(e=>{e.settings&&e.tag&&this.cacheSettings(e.settings,e.tag,e.emptyForTags,e.attributesHash)})}clearCache(){this.storedSettings={},this.indexedDBService.truncate(this.settingStorageKey)}updateInMemorySettings(){return new Promise((e,t)=>{this.indexedDBService.getAllValue(this.settingStorageKey).then(t=>{t&&t.forEach(e=>{e.time<this.dateService.now()-this.config.cacheTimeout?this.indexedDBService.deleteValue(this.settingStorageKey,e.id):this.storedSettings[e.id]=e}),e(!0)}).catch(e=>{t(e)})})}getCachedSettings(e){const t=this.storedSettings[e];if(t){const e=t.time+this.config.cacheTimeout<this.dateService.now();return{cachedSetting:oi(t),timedOut:e}}}cacheSettings(e,t,i,s){const n=this.dateService.now();this.quote.quoteSize().then(r=>{const o=(new TextEncoder).encode(JSON.stringify(e)).length,a=r&&r-o>1e6;for(const[o,c]of Object.entries(e)){const e=i.join();(a||null===r)&&this.indexedDBService.putValue(this.settingStorageKey,{id:o,[o]:c,time:n,tag:t,attributesHash:s,emptyForTags:e})}}).catch(e=>console.log(e));for(const[r,o]of Object.entries(e)){const e=i.join();this.storedSettings[r]={[r]:o,time:n,tag:t,attributesHash:s,emptyForTags:e,version:this.config.app_version}}this.clearTimedOutSettings(t)}removeCachedSettings(e){e.forEach(e=>{e?.settings?.length&&e.settings.forEach(e=>{this.indexedDBService.deleteValue(this.settingStorageKey,e),delete this.storedSettings[e]})})}clearTimedOutSettings(e){for(const[t,i]of Object.entries(this.storedSettings))i.tag===e&&i.time<this.dateService.now()-this.config.cacheTimeout&&delete this.storedSettings[t];this.indexedDBService.getAllValue(this.settingStorageKey).then(t=>{t&&t.forEach(t=>{t.tag===e&&t.time<this.dateService.now()-this.config.cacheTimeout&&this.indexedDBService.deleteValue(this.settingStorageKey,t.id)})}).catch(e=>{console.log(e)})}getAllTags({ur:e,all:t=!1}){const i=this.storedSettings,s=new Set;if(i)for(const[n]of Object.entries(i))(i[n].ur!==e||t)&&s.add(i[n].tag);return s}}class ui{lockManager;constructor(e){this.lockManager=e}async waitQueueOpen(e,t,i=[]){let s=0;do{if(await this.lockManager.locked(e))await Ke(50),s+=50;else{if(!i.includes(e))return e;await Ke(50),s+=50}}while(s<t);return console.error("Request Timed Out For Setting"),null}}class hi{dataLayerService;responses$=new z;constructor(e){this.dataLayerService=e}responses(){return this.responses$.asObservable()}trackResponse(e){this.responses$.next(e);const t=e.experiments?.filter(e=>e?.trackable),i={pulse:"state",segments:e.segments};return t&&(i.experiments=t),this.dataLayerService.pushData(i),e}}class li{usage$=new z;usages(){return this.usage$.asObservable()}trackUsage(e,t,i){if(function(e){return"object"==typeof e&&null!==e&&!Array.isArray(e)}(i)){const s=this.usage$;return new Proxy(i,{get:(n,r)=>(Object.hasOwn(n,r)&&s.next({tag:e,key:t,value:i}),n[r])})}return this.usage$.next({tag:e,key:t,value:i}),i}}const di=(new Ce).provide(function(e){return e.useFactory(nt,e=>e,[Se]).useFactory(ct,(e,t,i,s,n,r,o,a)=>new ct(e(i.cacheStorageType),t,s,n,r,o,a,i),[Pe,Re,nt,De,hi,ci,li,Me]).useFactory(ut,(e,t,i,s,n)=>new ut(i,e(t.cacheStorageType),s,n),[Pe,nt,hi,He,De]).useClass(ht,ht,[at]).useClass(pt,pt,[hi,He,ct,gt,qe,nt,ze]).useFactory($t,(e,t,i,s,n,r,o,a,c,u,h,l)=>new $t(t,i,s,e,n,r,o,a,c,u,h,l),[nt,ht,pt,ci,li,gt,Je,Oe,ui,Bt,jt,We]).useFactory(ii,(e,t,i,s)=>new ii(e,t,i,s),[$t,nt,ct,ut]).useClass(ui,ui,[Oe]).useFactory(ci,(e,t,i,s,n)=>new ci(t,i,s,n,e),[nt,be,De,hi,Ye]).useClass(li,li,[]).useClass(hi,hi,[Qe]).useClass(si,si,[ii]).useFactory(gt,(e,t,i,s,n,r)=>new gt(e(t.cacheStorageType),i,s,t,n,r),[Pe,nt,Re,Xe,Ze,et]).useFactory(Bt,(e,t,i)=>new Bt(t(e.cacheStorageType),i),[nt,Pe,Re]).useFactory(jt,(e,t,i)=>new jt(t(e.cacheStorageType),i),[nt,Pe,Re]).useFactory(ri,(e,t,i,s,n,r,o,a,c,u,h,l)=>new ri(e(i.cacheStorageType),t,i,s,n,r,o,a,c,u,h,l),[Pe,Ae,nt,He,ct,tt,qe,Bt,ht,We,jt,gt])}).beforeInit(function(e){return{...Ie,...e}}).onInit(async(e,t,i,s)=>{await f(i.win,!0)&&await t.connectDB(),s.startService()},[be,me,ri]);class pi{env;uuid;lockManager;locks=new Map;constructor(e,t){this.env=e,this.uuid=t,this.lockManager=e.win.navigator.locks}async supported(){let e=!1;try{this.lockManager?.query&&(await(this.lockManager?.query()),e=!0)}catch{e=!1}return"function"==typeof this.lockManager?.request&&"function"==typeof this.lockManager?.query&&"function"==typeof this.env.win.AbortController&&e}async locked(e){if(!this.lockManager)throw new Error("Native LockManager not supported!");return(await this.lockManager.query()).held.some(t=>t.name===e)}request(e,t=1e3){if(!this.lockManager)throw new Error("Native LockManager not supported!");const i=new Ee,s=new Ee,n=new AbortController,r={signal:n.signal};let o=!1;return this.lockManager.request(e,r,()=>{o=!0;const t={name:e,id:this.uuid.generate(),clientId:"",createdDate:0,task:s};return this.locks.set(e,t),i.resolve(t),s.waitUntilResolved()}).catch(()=>i.resolve(null)),Ke(t).then(()=>{o||(n.abort(),i.resolve(null))}).catch(e=>{console.error(e)}),i.waitUntilResolved()}async release(e){if(!this.lockManager)throw new Error("Native LockManager not supported!");const t=this.locks.get(e.name);t&&t.id===e.id&&(t.task.resolve(),this.locks.delete(t.name))}}var gi=i(682),fi=i.n(gi);const vi=/^(?:[0-9a-f]{8}-[0-9a-f]{4}-[1-8][0-9a-f]{3}-[89ab][0-9a-f]{3}-[0-9a-f]{12}|00000000-0000-0000-0000-000000000000|ffffffff-ffff-ffff-ffff-ffffffffffff)$/i;const bi=function(e){return"string"==typeof e&&vi.test(e)},mi=[];for(let e=0;e<256;++e)mi.push((e+256).toString(16).slice(1));const yi=function(e,t=0){const i=function(e,t=0){return(mi[e[t+0]]+mi[e[t+1]]+mi[e[t+2]]+mi[e[t+3]]+"-"+mi[e[t+4]]+mi[e[t+5]]+"-"+mi[e[t+6]]+mi[e[t+7]]+"-"+mi[e[t+8]]+mi[e[t+9]]+"-"+mi[e[t+10]]+mi[e[t+11]]+mi[e[t+12]]+mi[e[t+13]]+mi[e[t+14]]+mi[e[t+15]]).toLowerCase()}(e,t);if(!bi(i))throw TypeError("Stringified UUID is invalid");return i};class Si{date;env;mersenne;nativePRNG;constructor(e,t){this.date=e,this.env=t,this.nativePRNG=this.getNativePRNG()}generate(){const e=this.date.now();return`a.${this.nativePRNG?"c":"m"}.${e.toString(36)}.${this.generateV4()}`}generateV4(){const e=this.randomValues(new Uint8Array(16));return e[6]=15&e[6]|64,e[8]=63&e[8]|128,yi(e)}randomValues(e){if(this.nativePRNG)return this.nativePRNG(e);this.mersenne||(this.mersenne=new(fi())(this.weakSeed()));let t=e.length;for(;t--;)e[t]=Math.floor(256*this.mersenne.random());return e}weakSeed(){const e=Array(127).fill(0).map(()=>Math.floor(Math.random()*Number.MAX_SAFE_INTEGER));return[this.date.now(),...e]}getNativePRNG(){const e=this.env.win;return e.crypto?.getRandomValues?.bind(e.crypto)||e.msCrypto?.getRandomValues?.bind(e.msCrypto)||void 0}}class wi{storage;date;config;uuid;id;locks;constructor(e,t,i,s,n){this.storage=e,this.date=t,this.config=i,this.uuid=s,this.id=s.generate(),this.locks=this.syncLocks(),this.storage.change("locks",Ue.Full,$e.External).subscribe(e=>{this.syncLocks(e.value)}),n.legacyOnUnload().subscribe(()=>this.releaseAll())}async release(e,t=!0){const i=this.locks.get(e.name);i&&i.clientId===this.id&&i.id===e.id&&(this.locks.delete(i.name),t&&this.syncLocks())}async locked(e){return this.locks.has(e)}async request(e,t=100,i=10){const s=this.date.now();for(;;){const n=await this.lock(e),r=this.date.now()-s>t;if(n||r)return n;await Ke(i)}}async lock(e){if(this.locks.has(e))return null;{const t={name:e,clientId:this.id,id:this.uuid.generate(),createdDate:this.date.now()};return this.locks.set(e,t),this.syncLocks(),t}}syncLocks(e){if(!this.locks||e){const t=e||this.storage.get("locks"),i=JSON.parse(t||"null"),s=new Map(i||[]),n=this.releaseExpiredLocks(s);this.locks=n,s.size!==n.size&&this.writeLocks(n)}else this.writeLocks(this.locks);return this.locks}writeLocks(e){0===e.size?this.storage.remove("locks"):this.storage.setJSON("locks",Array.from(e))}releaseAll(){for(const[e,t]of this.locks)t.clientId===this.id&&this.release(t,!1);this.syncLocks()}releaseExpiredLocks(e){const t=this.date.now(),i=Array.from(e).filter(([e,i])=>t-i.createdDate<this.config.locksMaxAge);return new Map(i)}}class _i{parseCookies(e){const t=[],i=e.split(";");for(const e of i){const i={},s=e.indexOf("=");s>-1?(i.name=e.slice(0,s).trim()||"",i.value=e.slice(s+1).trim()):(i.name="",i.value=e.trim()),i.name&&(i.name=(i.name||"").replace(/(%[\dA-F]{2})+/gi,decodeURIComponent),i.value=(i.value||"").replace(/(%[\dA-F]{2})+/gi,decodeURIComponent),t.push(i))}return t}serializeSetCookie(e){if(!e.name||"string"!=typeof e.name)throw new Error("Invalid cookie name!");const t={...e},i=encodeURIComponent(t.name).replace(/%(2[346B]|5E|60|7C)/g,decodeURIComponent).replace(/[()]/g,escape),s=encodeURIComponent(t.value||"").replace(/%(2[346BF]|3[AC-F]|40|5[BDE]|60|7[BCD])/g,decodeURIComponent),n=this.serializeExpires(t.expires),r=[`${i}=${s}`];if("string"==typeof n&&r.push(`Expires=${n}`),"string"==typeof t.domain&&r.push(`Domain=${t.domain}`),r.push(`Path=${t.path||"/"}`),"string"==typeof e.sameSite){const i=e.sameSite.toUpperCase();"LAX"===i?r.push("SameSite=Lax"):"STRICT"===i?r.push("SameSite=Strict"):"NONE"===i&&(r.push("SameSite=None"),t.secure=!0)}return!0===t.secure&&r.push("Secure"),r.join("; ")}serializeExpires(e){if(Number.isSafeInteger(e)){const t=new Date(e);if(!isNaN(Number(t)))return t.toUTCString()}}parseExpires(e){if("string"==typeof e){const t=Date.parse(e);if(Number.isSafeInteger(t))return t}}}class Ei{storage;config;logLevel=oe.Warn;KEY_LOG_LEVEL="log_level";constructor(e,t){this.storage=e,this.config=t}level(){return"number"!=typeof this.logLevel&&(this.logLevel=Number(this.storage.get(this.KEY_LOG_LEVEL)||0)||this.config.logLevel||0),this.logLevel}setLevel(e){this.logLevel=e,this.storage.set(this.KEY_LOG_LEVEL,String(e))}enabled(e){return e<=this.level()}error(e,...t){this.print(e,oe.Error,t)}warn(e,...t){this.print(e,oe.Warn,t)}info(e,...t){this.print(e,oe.Info,t)}verbose(e,...t){this.print(e,oe.Verbose,t)}print(e,t,i){if(this.enabled(t))switch(t){case oe.Error:console.log(`${e}:`),console.error(...i);break;case oe.Warn:console.warn(`${e}: `,...i);break;case oe.Info:console.info(`${e}: `,...i);break;case oe.Verbose:console.log(`${e}: `,...i)}}}class Ti{options;changes=new z;constructor(e){this.options=e}change(e,t=Ue.Full,i=$e.External){let s=this.changes.asObservable().pipe(ee(({external:e})=>i===$e.All||(i===$e.External?e:!e)));if(e)if(t&&t!==Ue.Full){if(t!==Ue.Start)throw new Error("Invalid keyMatch value!");s=s.pipe(ee(t=>t.key.startsWith(e)))}else s=s.pipe(ee(t=>t.key===e));return s}getJSON(e){const t=this.get(e);return"string"==typeof t?JSON.parse(t):null}setJSON(e,t){const i=JSON.stringify(t);this.set(e,i)}getStorageKey(e){const t=this.options.storagePrefix;return t?`${t}${e}`:e}revertStorageKey(e){const t=this.options.storagePrefix;return t?.length?e.slice(this.options.storagePrefix.length):e}isStorageKey(e){return!this.options.storagePrefix||!e||e.startsWith(this.options.storagePrefix)}emitChange(e){this.changes.next(e)}}class ki extends Ti{db=new Map;freeSpace$=new z;constructor(){super({storagePrefix:""})}get(e){return this.db.get(e)??null}set(e,t,i=!1){this.db.set(e,t),this.emitChange({key:e,value:t,external:i})}keys(){return Array.from(this.db.keys())}remove(e){this.db.delete(e),this.emitChange({key:e,value:null,external:!1})}clear(){this.db=new Map}all(){return Array.from(this.db.entries()).reduce((e,[t,i])=>(e[t]=i,e),{})}}class Ci extends Ti{env;parser;changeDetector;freeSpace$=new z;cookies=new Map;constructor(e,t,i,s){super(s),this.env=e,this.parser=t,this.changeDetector=i,this.pull(!1),this.changeDetector.changes().pipe(ee(e=>e||!s.storagePrefix)).subscribe(()=>this.pull())}get(e){return this.cookies.get(e)??null}set(e,t){const i={name:this.getStorageKey(e),value:t};this.cookies.set(e,t);const s=this.parser.serializeSetCookie(i);this.env.doc.cookie=s,this.emitChange({key:e,value:t,external:!1})}keys(){return Array.from(this.cookies.keys())}remove(e){const t={name:this.getStorageKey(e),value:"",expires:0};this.cookies.delete(e);const i=this.parser.serializeSetCookie(t);this.env.doc.cookie=i,this.emitChange({key:e,value:null,external:!1})}clear(){const e=this.keys();for(const t of e)this.remove(t)}all(){return Array.from(this.cookies).reduce((e,[t,i])=>("string"==typeof i&&(e[t]=i),e),{})}pull(e=!0){const t=this.cookies,i=this.fetchCookies(),s=new Set([...t.keys(),...i.keys()]);if(this.cookies=i,e)for(const e of s){const s=t.get(e),n=i.get(e)??null;if(s!==n){const t={key:e,value:n,external:!0};this.emitChange(t)}}}fetchCookies(){const e=this.env.doc,t=this.parser.parseCookies(e.cookie).filter(e=>this.isStorageKey(e.name));for(const e of t)e.name=this.revertStorageKey(e.name);const i=t.map(e=>[e.name,e.value]);return new Map(i)}}class Ii{env;static patchedDocuments=new Map;constructor(e,t){this.env=t;const i=this.patchChanges();i.pipe(ee(e=>!e)).subscribe(()=>{e.postMessage(!0)}),e.messages.pipe(ge(()=>!0)).subscribe(i)}changes(){return this.patchChanges()}patchChanges(){const e=this.env.doc;let t=Ii.patchedDocuments.get(e);if(t)return t;t=new z,Ii.patchedDocuments.set(e,t);const i=this.env.win.Document.prototype,s=Object.getOwnPropertyDescriptor(i,"cookie");let n=e.cookie;const r={enumerable:!0,configurable:!0,get:()=>e.__native_cookie,set:i=>{e.__native_cookie=i;const s=e.__native_cookie;if(s!==n)try{t.next(!1)}finally{n=s}}};return Object.defineProperty(i,"__native_cookie",s),Object.defineProperty(i,"cookie",r),t}}class xi{cookieStorage;KEY_W2M_META_INFO="w2m_meta_info";w2mMetaInfo;constructor(e){this.cookieStorage=e;try{const e=this.cookieStorage.get(this.KEY_W2M_META_INFO);e&&(this.w2mMetaInfo=JSON.parse(e))}catch(e){console.error("Error getting web to mobile configuration",e)}}getWebToMobileMetaInfo(){return this.w2mMetaInfo?this.w2mMetaInfo:null}}var Pi=["addListener","removeListener"],Ni=["addEventListener","removeEventListener"],Ai=["on","off"];function Oi(e,t,i,s){if(v(i)&&(s=i,i=void 0),s)return Oi(e,t,i).pipe(It(s));var n=a(function(e){return v(e.addEventListener)&&v(e.removeEventListener)}(e)?Ni.map(function(s){return function(n){return e[s](t,n,i)}}):function(e){return v(e.addListener)&&v(e.removeListener)}(e)?Pi.map(Ri(e,t)):function(e){return v(e.on)&&v(e.off)}(e)?Ai.map(Ri(e,t)):[],2),r=n[0],o=n[1];if(!r&&te(e))return Rt(function(e){return Oi(e,t,i)})(le(e));if(!r)throw new TypeError("Invalid event target");return new V(function(e){var t=function(){for(var t=[],i=0;i<arguments.length;i++)t[i]=arguments[i];return e.next(1<t.length?t:t[0])};return r(t),function(){return o(t)}})}function Ri(e,t){return function(i){return function(s){return e[i](t,s)}}}class Li extends Ti{storageArea;quote;freeSpace$=new z;availableSpace=void 0;constructor(e,t,i,s){super(s),this.storageArea=t,this.quote=i,this.calculateAvailableSpace(),Oi(e.win,"storage").pipe(ee(e=>Boolean(e.key)&&e.storageArea===t&&this.isStorageKey(e.key)),ge(e=>({key:this.revertStorageKey(e.key),value:e.newValue,external:!0}))).subscribe(e=>this.emitChange(e))}get(e){return this.storageArea.getItem(this.getStorageKey(e))}set(e,t){try{const i=(new TextEncoder).encode(t).length;null!==this.availableSpace&&void 0!==this.availableSpace&&this.availableSpace-i>100||null===this.availableSpace||void 0===this.availableSpace?(this.storageArea.setItem(this.getStorageKey(e),t),this.emitChange({key:e,value:t,external:!1})):this.freeSpace()}catch(e){this.freeSpace(),console.warn(e)}finally{this.calculateAvailableSpace()}}keys(){return Object.keys(this.storageArea).filter(e=>this.isStorageKey(e)).map(e=>this.revertStorageKey(e))}remove(e){this.storageArea.removeItem(this.getStorageKey(e)),this.emitChange({key:e,value:null,external:!1})}clear(){const e=this.keys();for(const t of e)this.remove(t)}all(){return Object.keys(this.storageArea).filter(e=>this.isStorageKey(e)).reduce((e,t)=>{const i=this.revertStorageKey(t),s=this.storageArea.getItem(t);return"string"==typeof s&&(e[i]=s),e},{})}freeSpace(){this.freeSpace$.next()}async calculateAvailableSpace(){this.availableSpace=await this.quote.quoteSize()}}class Di extends Li{constructor(e,t,i,s){super(e,p(e.win)?e.win.localStorage:s,i,t)}}class Mi extends Li{constructor(e,t,i,s){super(e,p(e.win)?e.win.sessionStorage:s,i,t)}}class $i{persistentStorage;env;messages=new z;nativeChannel;channelName;constructor(e,t,i){this.persistentStorage=t,this.env=i,this.channelName=`pulse_bc_${e}`,this.init()}postMessage(e){this.nativeChannel?this.nativeChannel.postMessage(e):this.persistentStorage.setJSON(this.channelName,e)}init(){if(this.env.win.BroadcastChannel)return this.nativeChannel=new this.env.win.BroadcastChannel(this.channelName),void this.nativeChannel.addEventListener("message",e=>{this.messages.next(e.data)});this.persistentStorage.change(this.channelName,Ue.Full,$e.External).subscribe(e=>{const t=JSON.parse(e.value||"null");this.messages.next(t)})}}function Ui(){for(var e=[],t=0;t<arguments.length;t++)e[t]=arguments[t];var i=Nt(e),s=function(e,t){return"number"==typeof Pt(e)?e.pop():t}(e,1/0),n=e;return n.length?1===n.length?le(n[0]):Lt(s)(kt(n,i)):Vt}const Bi={capture:!0,passive:!0};class ji{env;get visible(){return this.isPageVisible()}hiddenPropName="hidden";visibilityStatePropName="visibilityState";visibilityEventName="visibilitychange";constructor(e){this.env=e,this.configureVisibilityListener()}onVisibilityChange(){const e=this.env.win.document;let t=new z;return this.configureVisibilityListener()&&(t=Oi(e,this.visibilityEventName).pipe(ge(()=>this.isPageVisible()))),this.fullVisibilityAPISupport()||(t=Ui(t,this.legacyVisibilityEvents())),t.pipe(Ht())}legacyOnUnload(){const e=this.env.win;return Ui(this.legacyPageHide(),Oi(e,"beforeunload",Bi),Oi(e,"unload",Bi))}legacyPageHide(){return Oi(this.env.win,"pagehide",Bi)}legacyVisibilityEvents(){return Ui(this.legacyOnUnload().pipe(ge(()=>!1)),Oi(this.env.win,"pageshow",Bi).pipe(ge(()=>!0)),Oi(this.env.win,"focus",Bi).pipe(ge(()=>!0))).pipe(Ht())}isPageVisible(){const e=this.env.doc;return"string"==typeof e[this.visibilityStatePropName]&&e[this.visibilityStatePropName]?"visible"===e[this.visibilityStatePropName]:"boolean"==typeof e[this.hiddenPropName]?!e[this.hiddenPropName]:!this.env.win.document.hasFocus||this.env.win.document.hasFocus()}configureVisibilityListener(){const e=["","ms","webkit","moz","o"],t=this.env.doc;for(const i of e){const e=i?`${i}Hidden`:"hidden",s=i?`${i}VisibilityState`:"visibilityState",n=(i||"")+"visibilitychange";if(e in t||s in t)return this.hiddenPropName=e,this.visibilityEventName=n,this.visibilityStatePropName=s,!0}return!1}fullVisibilityAPISupport(){const e=this.env.doc,t=this.env.win.navigator.userAgent;return"string"==typeof e.visibilityState&&"boolean"==typeof e.hidden&&void 0!==e.onvisibilitychange&&!/Safari/i.test(t)}}class Hi{getElementAttributes(e){const t=["class","value","id","name"];return Array.from(e.attributes).map(e=>({name:e.name,value:e.value})).filter(e=>-1===t.indexOf(e.name))}getElementText(e){return e instanceof HTMLAnchorElement||e instanceof HTMLButtonElement?e.innerText:e instanceof HTMLInputElement&&("button"===e.type||"submit"===e.type||"reset"===e.type)?e.value:e===document.body?"<body>":e===document.documentElement?"<document>":e===document.head?"<head>":e.labels?.length?Array.from(e.labels||[]).map(e=>e.innerText).join(" "):null}getFirstParentElement(e){let t=e;for(;t;){if(t instanceof HTMLElement)return t;t=t.parentElement}return null}getTargetType(e){let t="other";return"A"===e.nodeName?t="link":"BUTTON"===e.nodeName||e instanceof HTMLInputElement&&"button"===e.type?t="button":e instanceof HTMLInputElement&&("submit"===e.type?t="submit":"reset"===e.type?t="reset":"file"===e.type?t="file":"submit"!==e.type&&"reset"!==e.type&&"file"!==e.type&&(t="input")),t}hasAttribute(e,t){return t?.hasAttribute(e)||t?.hasAttribute(`data-${e}`)}clickableTarget(e){let t=e,i=!1;for(;t&&!i;){const e=this.getTargetType(t);i=Boolean("submit"===e||"button"===e||"link"===e||this.hasAttribute("pulse-clickable",t)),i||(t=t.parentElement)}return t}createInteractionElement(e){const t=this.getTargetType(e),i=Array.from(e.classList),s=this.getElementAttributes(e),n=e.getAttribute("pulse-name")||e.getAttribute("data-pulse-name")||e.getAttribute("pulse-clickable")||e.getAttribute("data-pulse-clickable")||e.name||e.getAttribute("name")||void 0;return{attributes:s,attributeValueByName:s.reduce((e,t)=>({...e,[t.name]:t.value}),{}),classList:i,nodeType:t,id:e.id,name:n,nodeName:e.nodeName,text:this.getElementText(e)||void 0}}createSection(e,t,i=void 0,s){const n=e?e.getAttribute("pulse-section")||e.getAttribute("data-pulse-section"):null,r=t?t.getAttribute("pulse-section-group")||t.getAttribute("data-pulse-section-group"):null,o=i?i.getAttribute("pulse-component")||i.getAttribute("data-pulse-component"):null,a=i?i.getAttribute("pulse-component-type")||i.getAttribute("data-pulse-component-type"):null;return{name:n||r||void 0,group:r||n||void 0,sectionElement:e&&this.createInteractionElement(e),sectionGroupElement:t&&this.createInteractionElement(t),popupComponent:o||void 0,popupComponentType:a||void 0,additionalProperties:s&&Object.keys(s).length>0?s:void 0}}collectDynamicAttributes(e){const t={};return Array.from(e.attributes).forEach(e=>{const i=e.name,s=e.value;if(i.startsWith("data-pulse-dynamic-")){const e=i.replace("data-pulse-dynamic-","");t[e]=s}else if(i.startsWith("pulse-dynamic-")){const e=i.replace("pulse-dynamic-","");t[e]=s}}),t}}const Fi=(new Ce).provide(function(e){return e.useFactory(st,e=>e,[Se]).useClass(pi,pi,[me,Si]).useFactory(wi,(e,t,i,s,n)=>new wi(e(i.sessionStorageType),t,i,s,n),[Pe,De,st,Si,ji]).useFactory(Oe,async(e,t)=>await e.supported()?e:t,[pi,wi]).useClass(at,at,[]).useClass(_i,_i,[]).useFactory(Ei,(e,t)=>new Ei(e(t.sessionStorageType),t),[Pe,st]).useClass(ki,ki,[]).useValue(xe,window).useClass(me,me,[xe]).useClass(De,De,[me]).useClass(ze,ze,[ji,me,De,Ei,st,He]).useClass(et,et,[me]).useClass(Ze,Ze,[me,Xe]).useClass(Si,Si,[De,me]).useClass(Xe,Xe,[me]).useClass(Ci,Ci,[me,_i,Ii,st]).useClass(xi,xi,[Ae]).useFactory(Ae,(e,t,i,s)=>new Ci(e,t,i,{...s,storagePrefix:""}),[me,_i,Ii,st]).useFactory(Re,(e,t,i,s)=>new Ci(e,t,i,{...s,storagePrefix:s.storagePrefix}),[me,_i,Ii,st]).useFactory(He,(e,t,i,s,n)=>new He(e,t(i.sessionStorageType),s,i,n,$e.External),[Si,Pe,st,Re,xi]).useClass(Qe,Qe,[me]).useFactory(Je,(e,t,i,s)=>new Je(i(s.hashStoreStorageType),e,t),[at,De,Pe,st]).useClass(Me,Me,[me]).useClass(tt,tt,[Xe]).useFactory(qe,(e,t,i,s)=>new qe(e,t(i.trafficSourceDetectorStorageType),s),[tt,Pe,st,Xe]).useClass(Di,Di,[me,st,Ye,ki]).useClass(Mi,Mi,[me,st,Ye,ki]).useFactory(Ne,(e,t,i)=>new $i("pulse-cookie-changes",e(i.sessionStorageType),t),[Pe,me,st]).useClass(Ii,Ii,[Ne,me]).useClass(Ci,Ci,[me,_i,Ii,st]).useClass(Ye,Ye,[me]).useClass(be,be,[me]).useFactory(Pe,(e,t,i,s)=>n=>{if(!p(s.win))return e;switch(n){case"memory":return e;case"persistent":return i;case"tab":return t}},[ki,Mi,Di,me]).useClass(ji,ji,[me]).useFactory(We,(e,t)=>new We(e(t.sessionStorageType),t.stateStorageKey,$e.All),[Pe,st]).useClass(Hi,Hi,[])}).beforeInit(function(e){const t={...ve,...e,initialDocURL:window.paa?.idu};return"standard"!==t.mode&&(t.trafficSourceDetectorStorageType="memory"),t});class Vi{plugins=[];init(e){this.plugins.forEach(t=>t.init&&t.init(e))}enqueue(e,t){return this.plugins.every(i=>!i.enqueue||i.enqueue(e,t))}beforeBatchSend(e,t){return this.plugins.reduce((e,i)=>e&&i.beforeBatchSend?i.beforeBatchSend(e,t):e,e)}batchSent(e,t){this.plugins.forEach(i=>i.batchSent&&i.batchSent(e,t))}sessionChange(){throw new Error("Method not implemented.")}stateChange(){throw new Error("Method not implemented.")}register(e){this.plugins.push(e)}}class qi{transformPipes=[];enrichmentPipes=[];process(e,t){return this.transform(e,t).map(e=>this.enrich(e,t))}transform(e,t){const i=this.selectPipeSet(e,this.transformPipes);let s=[e];for(const e of i){if(!e.transform)continue;const i=[];for(const n of s){const s=e.transform(n,t);i.push(...s)}s=i}return s}enrich(e,t){return this.selectPipeSet(e,this.enrichmentPipes).reverse().reduce((e,i)=>i.enrich(e,t),e)}registerTransformSet(e){this.transformPipes.push(e)}registerEnrichmentSet(e){this.enrichmentPipes.push(e)}selectPipeSet(e,t){for(const i of t){if(!("*"===i.selector||i.selector===e.type||"function"==typeof i.selector&&i.selector(e)||!1))continue;if(!("function"==typeof i.exclude&&i.exclude(e)))return[...i.use]}return[]}}class Ki{transform(e){const t=e.data;if("object"!=typeof t||!t||Array.isArray(t))return[];if(!("object"==typeof t&&"string"==typeof t?.name&&["$overwrite","$inc","$dec"].indexOf(t?.type)>-1)&&"object"==typeof t&&t){const i=[];for(const s in t){if(!Object.prototype.hasOwnProperty.call(t,s))continue;const n=t[s];if(!("string"==typeof n||"number"==typeof n||"boolean"==typeof n))continue;const r={...e,data:{type:"$overwrite",name:s,value:n}};i.push(r)}return i}return[e]}}class zi{transform(e){const t={...e.data};return"string"==typeof t.event&&t.event||"string"!=typeof t.action||!t.action?(t.event_type=t.event||t.event_type,delete t.event):(t.event_type=t.action,delete t.action),"object"==typeof t.data&&t.data||("object"==typeof t.parameters&&t.parameters?(t.data=t.parameters,delete t.parameters):t.data={}),e.data=t,[e]}}var Gi,Ji,Wi,Yi;!function(e){e[e.Normal=1]="Normal",e[e.High=2]="High",e[e.Force=3]="Force"}(Gi||(Gi={})),function(e){e.NAVIGATION="navigation",e.CLICK="click",e.POPUP="popup",e.CONTEXTMENU="contextmenu",e.CONSENT_CHANGE="consent_change",e.SESSION_START="session_start"}(Ji||(Ji={}));class Qi{pageInfo;previousPath="";constructor(e){this.pageInfo=e}transform(e){let t=!0;const i=e.data;return i.event_type&&i.event_type===Ji.NAVIGATION&&(this.pageInfo.href()===this.previousPath&&(t=!1),this.previousPath=this.pageInfo.href()),t?[e]:[]}}class Xi{hashStore;config;constructor(e,t){this.hashStore=e,this.config=t}transform(e){const t=e.data;if("object"!=typeof t||!t||Array.isArray(t))return[];const i=`attribute_${t.name}`,s=`${t.type}_${t.value}`;return this.hashStore.changed(i,s,this.config.attributeTimeoutMS)?[e]:[]}}function Zi(e,t,i=!0){return"boolean"==typeof e?e:e&&"boolean"==typeof e[t]?e[t]??i:i}class es{historyTracker;tabManager;pageInfo;config;openerDetector;uuidService;env;webToMobileService;constructor(e,t,i,s,n,r,o,a){this.historyTracker=e,this.tabManager=t,this.pageInfo=i,this.config=s,this.openerDetector=n,this.uuidService=r,this.env=o,this.webToMobileService=a}enrich(e){const t={...e.data};if("object"==typeof t.data&&null!==t.data||(t.data={}),t.timestamp=e.timestamp,t.event_id=this.uuidService.generate(),t.data.metadata={event_id_source:"sdk"},this.env.win._pulse?.c?.dynamic_attributes){const e=Object.fromEntries(Object.entries(this.env.win._pulse?.c?.dynamic_attributes).map(([e,t])=>[`attr_${e}`,t]));t.data={...t.data,...e}}this.config.customerID&&(t.data.customer_id=this.config.customerID);const i=this.webToMobileService.getWebToMobileMetaInfo();if(i?.device_id&&(t.data.is_w2m=!0,t.data.mobile_attributes=i.mobile_attributes),Zi(this.config.eventEnrichment,"url")&&(t.data.url=this.pageInfo.href()),Zi(this.config.eventEnrichment,"tab_id")&&(t.data.tab_id=this.tabManager.getTabId(),t.data.tab_id)){const e=this.openerDetector.getOpener();e?.id&&(t.data.opener_tab_id=e.id)}return this.historyTracker.previousUrl&&Zi(this.config.eventEnrichment,"previous_url")&&(t.data.previous_url=this.historyTracker.previousUrl),this.pageInfo.referrer()&&Zi(this.config.eventEnrichment,"referrer")&&(t.data.referrer=this.pageInfo.referrer()),e.data=t,e}}class ts{sourceService;config;constructor(e,t){this.sourceService=e,this.config=t}enrich(e){if(!Zi(this.config.eventEnrichment,"legacy_source"))return e;const t={...e.data};"object"==typeof t.data&&null!==t.data||(t.data={});const i=t?.data?.source;if(!0===i||"string"==typeof i&&"true"===i.toLowerCase()){const e=this.sourceService.getSource();t.data.source=e}else void 0!==i&&"string"!=typeof i&&(t.data.source=JSON.stringify(i)||"");return e.data=t,e}}!function(e){e[e.Visible=0]="Visible",e[e.Hidden=1]="Hidden"}(Wi||(Wi={}));class is{visibility;visibilityState=Wi.Visible;constructor(e){this.visibility=e}init(){this.visibility.onVisibilityChange().subscribe(e=>{this.visibilityState=e?Wi.Visible:Wi.Hidden})}}class ss{historyTracker;navigationEventService;sessionService;consentService;constructor(e,t,i,s){this.historyTracker=e,this.navigationEventService=t,this.sessionService=i,this.consentService=s}init(){this.navigationEventService.send(!0),this.sessionService.session.subscribe(e=>{(e.isRenew||e?.renewedBy)&&this.consentService.trackingEnabled()&&this.navigationEventService.send(!1,e?.renewedBy)}),this.historyTracker.navigation.subscribe(()=>this.navigationEventService.send(!1))}}class ns{sessionService;experimentsService;debug;config;deviceInfo;stateService;constructor(e,t,i,s,n,r){this.sessionService=e,this.experimentsService=t,this.debug=i,this.config=s,this.deviceInfo=n,this.stateService=r}init(){const e=this.experimentsService.getInfected();e&&e.length?this.stateService.setState({infected:this.experimentsService.getInfected()}):e&&0===e.length&&this.stateService.removePropertyFromState("infected"),At([this.sessionService.session,this.debug.items]).subscribe(([e])=>{this.setState(e)})}setState(e){const{app:t}=e,i=this.deviceInfo.getNavigatorInfo(),s=this.deviceInfo.getScreenInfo().touch,n=this.deviceInfo.getHardwareInfo().cpus,r={app:Zi(this.config.stateEnrichment,"app")?t:void 0,market:Zi(this.config.stateEnrichment,"market")?"web":void 0,platform:Zi(this.config.stateEnrichment,"platform")?"web":void 0,version:Zi(this.config.stateEnrichment,"version")?this.config.app_version:void 0,data:{language_code:Zi(this.config.stateEnrichment,"language_code")?i.device_language_code:void 0,cpus:n,touch:s,browser_platform:i.browser_platform},v:Zi(this.config.stateEnrichment,"pulse_version")?this.config.version:void 0,debug:this.debug.enabled("debugger")};this.stateService.setState(r)}}class rs{activityTracker;env;constructor(e,t){this.activityTracker=e,this.env=t}init(){this.activityTracker.mutations().pipe(Rt(e=>e.mutatedElements)).subscribe(e=>{e&&this.env.win.dataLayer?.push({pulse:"event",event_type:Ji.POPUP,data:{component:e.component,component_type:e.componentType,popup_source:{section:e.section.name,group:e.section.group},action:"addedNodes"===e.mutationType?"open":"close",click_source:{tab_id:this.activityTracker.lastClickSourceInformation?.tab_id,url:this.activityTracker.lastClickSourceInformation?.url,section:this.activityTracker.lastClickSourceInformation?.name,group:this.activityTracker.lastClickSourceInformation?.group,popup_component:this.activityTracker.lastClickSourceInformation?.popupComponent,popup_component_type:this.activityTracker.lastClickSourceInformation?.popupComponentType,element:{id:this.activityTracker.lastClickSourceInformation?.element?.id||this.activityTracker.lastClickSourceInformation?.element?.name,name:this.activityTracker.lastClickSourceInformation?.element?.name,node_type:this.activityTracker.lastClickSourceInformation?.element?.nodeName,class_list:this.activityTracker.lastClickSourceInformation?.element?.classList},additional_properties:this.activityTracker.lastClickSourceInformation?.additionalProperties},additional_properties:e?.additionalProperties}})})}}class os{attributeService;constructor(e){this.attributeService=e}init(){this.attributeService.send()}}class as{consentService;sessionService;attributeService;env;constructor(e,t,i,s){this.consentService=e,this.sessionService=t,this.attributeService=i,this.env=s}init(){this.consentService.changes().pipe(ee(e=>!1!==e.consent.report)).subscribe(e=>{this.fireChangeEvent(e),"opt-in"===e.consent.mode&&(this.sessionService.startNewSession("consent_change"),this.attributeService.send())})}fireChangeEvent(e){const t=this.buildChangeEvent(e),i={event_type:Ji.CONSENT_CHANGE,data:t};this.env.win.dataLayer?.push({pulse:"event",...i,event_priority:Gi.Force})}buildChangeEvent({consent:e,result:t}){const i="string"==typeof e.consent?e.consent:e.consent.name;return{mode:e.mode,provider:i,state:t.state,necessary_cookies:t.necessary_cookies??void 0,performance_cookies:t.performance_cookies??void 0,functional_cookies:t.functional_cookies??void 0,targeting_cookies:t.targeting_cookies??void 0,social_media_cookies:t.social_media_cookies??void 0,provider_consent_id:t.provider_consent_id??void 0,response_time:t.response_time??void 0}}}class cs{cookieStorage;hashStore;attributeService;env;constructor(e,t,i,s){this.cookieStorage=e,this.hashStore=t,this.attributeService=i,this.env=s}init(){this.getPixelId()}getPixelId(){const e=this.cookieStorage.get("_fbp"),t=this.cookieStorage.change("_fbp",Ue.Full,$e.All).pipe(ge(e=>e.value));Dt(ti(e),t).pipe(ee(Boolean),ee(e=>this.hashStore.changed("pixel_id_attr",e))).subscribe(e=>{this.env.win.dataLayer?.push({pulse:"attribute",fb_pixel_id:e}),this.attributeService.send(!0)})}}class us{hashStore;trafficSourceService;sessionService;env;webToMobileService;lockedLocal="";constructor(e,t,i,s,n){this.hashStore=e,this.trafficSourceService=t,this.sessionService=i,this.env=s,this.webToMobileService=n}init(){this.sessionService.session.subscribe(e=>{this.fireEvent(e)});const e=this.sessionService.getSession();this.fireEvent(e)}async fireEvent(e){const t=this.webToMobileService.getWebToMobileMetaInfo();if(this.lockedLocal===e.sessionId||t?.session_id)return;if(this.lockedLocal=e.sessionId,!this.isNewSession(e))return;const i=this.trafficSourceService.getTrafficSource(),s={event_type:Ji.SESSION_START,data:{}};i?.clickId?.value&&(s.data.mkt_click={id:i.clickId.value,source:i.clickId.source}),i?.landingPageURL&&(s.data.landing_page_url=i?.landingPageURL),i?.utmParams&&(s.data.utm_params=i.utmParams),e.renewedBy&&(s.data.source=e.renewedBy),this.env.win.dataLayer?.push({pulse:"event",...s,event_priority:Gi.High})}isNewSession(e){return this.hashStore.changed("session_start_event_session_id",e.sessionId)}}class hs{activity;env;constructor(e,t){this.activity=e,this.env=t}init(){this.activity.interactions().pipe(ee(e=>e.type===Ji.CLICK&&!e.doNotTrack&&e.clickable)).subscribe(e=>{this.env.win.dataLayer?.push({pulse:"event",event_type:Ji.CLICK,data:{click_source:{section:e.section.name,group:e.section.group,popup_component:e.section.popupComponent,popup_component_type:e.section.popupComponentType,element:{id:e.element?.id||e.element?.name,name:e.element?.name,node_type:e.element?.nodeName,class_list:e.element?.classList}},additional_properties:e?.additionalProperties}})})}}class ls{activity;env;constructor(e,t){this.activity=e,this.env=t}init(){this.activity.interactions().pipe(ee(e=>e.type===Ji.CONTEXTMENU&&"link"===e.element?.nodeType&&!e.doNotTrack&&e.clickable)).subscribe(e=>{this.env.win.dataLayer?.push({pulse:"event",event_type:Ji.CONTEXTMENU,data:{click_source:{section:e.section.name,group:e.section.group,popup_component:e.section.popupComponent,popup_component_type:e.section.popupComponentType,element:{id:e.element?.id||e.element?.name,name:e.element?.name,node_type:e.element?.nodeName,class_list:e.element?.classList}},additional_properties:e?.additionalProperties}})})}}class ds{experimentsService;constructor(e){this.experimentsService=e}init(e){this.experimentsService.newExperimentTrigger$.subscribe(t=>{t&&e.tracker.flush()})}}class ps{debugService;env;liveEventDebug;config;routeHelper;webToMobileService;static DEBUGGER_KEY="debugger";constructor(e,t,i,s,n,r){this.debugService=e,this.env=t,this.liveEventDebug=i,this.config=s,this.routeHelper=n,this.webToMobileService=r}init(){try{const e=this.extractDebugLEUID();e&&this.enableDebugMode();this.isLiveDebugEnabled(e)&&this.handleLiveDebugMode(),e&&this.cleanupDebugParameter()}catch(e){console.error("Failed to initialize DebugEventPlugin:",e)}}extractDebugLEUID(){try{return new URL(this.env.landingUrl).searchParams.get(this.config.debugLiveEventKey)}catch(e){return console.error("Failed to parse landing URL:",e),null}}enableDebugMode(){this.debugService.enable(this.config.debugLiveEventKey)}isLiveDebugEnabled(e){return Boolean(e)||this.debugService.enabled(this.config.debugLiveEventKey)}handleLiveDebugMode(){this.debugService.enable(ps.DEBUGGER_KEY);const e=this.webToMobileService.getWebToMobileMetaInfo();Boolean(e?.session_id)||this.liveEventDebug.displayControl()}cleanupDebugParameter(){this.routeHelper.cleanupURL(this.config.debugLiveEventKey)}}class gs{activity;tabInfo;tabManager;config;constructor(e,t,i,s){this.activity=e,this.tabInfo=t,this.tabManager=i,this.config=s}init(){Zi(this.config.eventEnrichment,"tab_id")&&(this.activity.startService(this.tabManager.getTabId()),this.tabInfo.startService(this.tabManager.getTabId()))}}class fs{unPrefixedCookieStorage;cookieName="OptanonConsent";boxCookieName="OptanonAlertBoxClosed";constructor(e){this.unPrefixedCookieStorage=e}changes(){const e=this.parseOneTrustCookie(),t=new J(e),i=new z;return i.pipe(ni(30),ge(()=>this.parseOneTrustCookie())).subscribe(e=>t.next(e)),this.unPrefixedCookieStorage.change(this.cookieName,Ue.Full,$e.All).subscribe(()=>i.next()),this.unPrefixedCookieStorage.change(this.boxCookieName,Ue.Full,$e.All).subscribe(()=>i.next()),t}parseOneTrustCookie(){const e=this.unPrefixedCookieStorage.get(this.cookieName)||"",t=new URLSearchParams(e||""),i=this.parseConsentGroups(t);if(!i)return{state:"pending"};const s=t.get("consentId")||void 0,n=this.getResponseTime(),r=!Number.isSafeInteger(n)||"true"===t.get("AwaitingReconsent"),o="boolean"==typeof i.C0001?i.C0001:void 0,a="boolean"==typeof i.C0002?i.C0002:void 0,c="boolean"==typeof i.C0003?i.C0003:void 0,u="boolean"==typeof i.C0004?i.C0004:void 0;return{state:r?"pending":"responded",response_time:n,provider_consent_id:s,necessary_cookies:o,functional_cookies:c,performance_cookies:a,social_media_cookies:"boolean"==typeof i.C0005?i.C0005:void 0,targeting_cookies:u}}parseConsentGroups(e){const t=(e.get("groups")||"").trim();if(t)return t.split(",").reduce((e,t)=>{const i=(t||"").split(":").map(e=>e.trim()),s=i[0],n="1"===i[1]||"true"===i[1];return s&&2===i.length&&(e[s]=n),e},{})}getResponseTime(){const e=this.unPrefixedCookieStorage.get(this.boxCookieName),t=e?new Date(e):void 0;return t?.getTime()||void 0}}class vs{oneTrust;logger;hashStore;config;trackerConsentStream;consentChanges;constructor(e,t,i,s){this.oneTrust=e,this.logger=t,this.hashStore=i,this.config=s;const n=this.buildConsentChecks(this.config.consentChecks||[]),r=n.map(e=>e.result.pipe(ge(t=>({consent:{consent:e.consent,mode:e.mode,report:e.report,type:e.type},result:t}))));this.consentChanges=Ui(...r),this.trackerConsentStream=this.createTrackerCheckerStream(n)}trackingEnabled(){return this.trackerConsentStream}softChanges(){return this.consentChanges}changes(){return this.consentChanges.pipe(ee(({consent:e,result:t})=>{const i="string"==typeof e.consent?e.consent:e.consent.name,s=`tracking_consent_${e.type}${i}`;return this.hashStore.changed(s,t)}))}createTrackerCheckerStream(e){const t=e.every(e=>"opt-out"===e.mode),i=new J(t),s=e.map(e=>e.result.pipe(ge(t=>{if("tracking"===e.type){if("boolean"==typeof t.performance_cookies)return t.performance_cookies;if("pending"===t.state)return"opt-out"===e.mode}return!0})));return s.length&&At(s).pipe(ge(e=>e.every(e=>!0===e))).subscribe(e=>i.next(e)),i.asObservable().pipe(Ht())}buildConsentChecks(e){const t=[];for(const i of e)if("tracking"===i.type)if("OneTrust"===i.consent){const e=this.oneTrust.changes();t.push({...i,result:e})}else if("object"==typeof i.consent&&"function"==typeof i.consent?.handler){const e=this.buildFunctionConsentChecker(i);t.push(e)}else this.logger.warn("Consent","Unsupported ConsentChecker!");else this.logger.warn("Consent","Unsupported ConsentCheck type!");return t}buildFunctionConsentChecker(e){const t=new je;if("object"==typeof e.consent&&"function"==typeof e.consent?.handler){const s=e.consent.handler(t.next.bind(t));"object"==typeof s&&((i=s)&&(i instanceof V||v(i.lift)&&v(i.subscribe)))?s.subscribe(t):this.isPromise(s)?kt(s).subscribe(t):this.isValidResult(s)&&t.next(s)}var i;return{...e,result:t.pipe(ee(e=>this.isValidResult(e)))}}isPromise(e){return e instanceof Promise||"object"==typeof e&&"function"==typeof e?.then}isValidResult(e){const t=e;return"object"==typeof t&&("pending"===t?.state||"responded"===t?.state)}}class bs{utmService;page;engineList=new RegExp(["google","bing","baidub","yahoo","yandex","ask","duckduckgo","naver","aol","seznam"].join("|"));constructor(e,t){this.utmService=e,this.page=t}getSource(){const e=(this.page.referrer()||"").replace(/^https?:\/\//,""),t=this.utmService.getUTMParams();return t?.utm_source?`utm_${t.utm_source}`:e?this.engineList.test(e)?`search_${e}`:`referral_${e}`:"direct"}}class ms{date;storage;trafficSourceService;hashStore;config;deviceIdService;debugService;webToMobileService;stateService;storageChange;session;newSessionGenerated$=new J(0);sessionId;lastActivity;KEY_LAST_ACTIVITY="la";webToMobileSessionId;constructor(e,t,i,s,n,r,o,a,c,u){this.date=e,this.storage=t,this.trafficSourceService=i,this.hashStore=s,this.config=n,this.deviceIdService=r,this.debugService=o,this.webToMobileService=a,this.stateService=c,this.storageChange=u;const h=this.webToMobileService.getWebToMobileMetaInfo();this.lastActivity=Number(this.storage.get(this.KEY_LAST_ACTIVITY)||0),this.webToMobileSessionId=h?.session_id,this.sessionId=this.storage.get(this.config.keySessionID)||void 0,this.webToMobileSessionId&&(this.storage.set(this.config.keySessionID,this.webToMobileSessionId),this.stateService.setState({session_id:this.webToMobileSessionId})),this.registerStorageChangeListeners(),this.session=new J(this.getSession())}getSession(e=!0,t=!1){const i=this.deviceIdService.getDeviceId(),s=this.storage.get(this.config.keySessionID),n=this.isSessionExpired(),r=!this.sessionId;let o;o=this.webToMobileSessionId?this.webToMobileSessionId:!this.sessionId||n?this.fetchSessionId(n):this.sessionId,(n||r||t||s!==o)&&this.stateService.setState({device_id:Zi(this.config.stateEnrichment,"device_id")||this.debugService.enabled("debugger")?i:void 0,session_id:Zi(this.config.stateEnrichment,"session_id")?o:void 0});const a=this.stateService.getState(),c=this.lastActivity||0,u={app:this.config.app,deviceId:i,sessionId:o,lastActivity:c,state:a};return e&&this.refreshLastActivity(),n&&s&&(u.renewedBy="session_reset",u.isRenew=!0),(n||r)&&this.session?.next(u),u}startNewSession(e){return this.webToMobileSessionId&&(this.sessionId=this.webToMobileSessionId),this.sessionId=this.generateSessionId(),this.storage.set(this.config.keySessionID,this.sessionId),this.refreshLastActivity(),e&&this.session?.next({...this.getSession(!0,!0),renewedBy:e}),this.newSessionGenerated$.next(this.date.now()),this.sessionId}refreshLastActivity(){const e=this.date.now();e-(this.lastActivity||0)>1e3&&(this.lastActivity=e,this.storage.set(this.KEY_LAST_ACTIVITY,this.lastActivity.toString()))}isSessionExpired(){if(this.webToMobileSessionId)return!1;const{sessionTimeoutMS:e}=this.config,t=this.date.now(),i=this.trafficSourceChanged();return!this.sessionId||t-this.lastActivity>e||i}trafficSourceChanged(){const e=this.trafficSourceService.getLastTrafficSource();return this.hashStore.changed("session_traffic_source",e)}fetchSessionId(e=!1){if(this.webToMobileSessionId)return this.webToMobileSessionId;if(this.sessionId&&!e)return this.sessionId;return this.startNewSession()}registerStorageChangeListeners(){this.storage.change(this.config.keySessionID).subscribe(e=>{e.value&&(this.sessionId=e.value)}),this.deviceIdService.getDeviceId$().subscribe(e=>{this.stateService.setState({device_id:Zi(this.config.stateEnrichment,"device_id")||this.debugService.enabled("debugger")?e:void 0})}),this.storage.change(this.KEY_LAST_ACTIVITY).subscribe(({value:e})=>{const t=Number(e||"0");(this.lastActivity||0)<t&&(this.lastActivity=t)})}generateSessionId(){return this.webToMobileSessionId?this.webToMobileSessionId:`${this.date.now()}_${this.deviceIdService.getDeviceId()}`}}class ys{storage;items;debugItems;KEY_DEBUG="debug";constructor(e,t){this.storage=e,e.change(this.KEY_DEBUG).subscribe(e=>this.getDebugKeys(e.value));const i=this.getDebugKeys();this.items=new J(i),Array.isArray(t.debug)&&t.debug.length&&this.enable(...t.debug),t.debugClear&&this.disableAll()}enabled(e){const t=this.getDebugKeys();return t.has(e)||t.has("all")}enable(...e){const t=this.getDebugKeys();let i=!1;for(const s of e)i=i||!t.has(s),t.add(s);i&&this.set(Array.from(t))}disable(...e){const t=this.getDebugKeys();let i=!1;for(const s of e)i=i||t.has(s),t.delete(s);i&&this.set(Array.from(t))}disableAll(){this.getDebugKeys().clear(),this.set([])}set(e){this.storage.set(this.KEY_DEBUG,JSON.stringify(e)),this.debugItems=new Set(e),this.items.next(this.debugItems)}getDebugKeys(e){if(!this.debugItems||e){let t;try{if(t=JSON.parse(e||this.storage.get(this.KEY_DEBUG)||""),!Array.isArray(t))throw new Error("Failed to parse debug mode!")}catch{t=[]}this.debugItems=new Set(t)}return this.debugItems}}class Ss{debug;config;httpService;constructor(e,t,i){this.debug=e,this.config=t,this.httpService=i}send(e,t=!1,i=void 0,s){const n=`${this.config.serverBaseURL}/${this.config.app}`,r=this.getHeaders();this.httpService.post(n,r,e.chunks,t).then(()=>{i?.({size:e.size||0,batchId:s})}).catch(e=>{console.error(`Batch didn't send ${e}`)})}getHeaders(){const e=this.debug.enabled("receiver");return{"Content-Type":"application/json","receiver-debug":String(e)}}}class ws{env;tabStorage;dateService;previousUrl;navigation=new z;popStatePreviousUrl;lastLocationKey="last_location";internalLoadLimit=2e3;constructor(e,t,i){this.env=e,this.tabStorage=t,this.dateService=i;const s=this.getLastLocation();this.previousUrl=s?.locationURL||e.doc.referrer||"",this.popStatePreviousUrl=this.env.win.location.href,this.setLastLocation(this.env.win.location.href),addEventListener("beforeunload",()=>{this.setLastLocation()},{capture:!0}),this.init()}init(){"function"==typeof this.env.win.history?.pushState&&(this.patch("back"),this.patch("forward"),this.patch("go"),this.patch("pushState"),this.patch("replaceState"),this.env.win.addEventListener("popstate",()=>{const e=this.env.win.location.href;this.popStatePreviousUrl!==e&&(this.previousUrl=this.popStatePreviousUrl,this.popStatePreviousUrl=e,this.setLastLocation(e),this.navigation.next(e))},!1))}patch(e){const t=this.env.win.history,i=t[e].bind(t);t[e]=(...e)=>{const s=this.env.win.location.href;i.apply(t,e);const n=this.env.win.location.href;s!==n&&(this.setLastLocation(n),this.popStatePreviousUrl=n,this.previousUrl=s,this.navigation.next(n))}}setLastLocation(e=this.popStatePreviousUrl){this.tabStorage.setJSON(this.lastLocationKey,{locationURL:e,timestamp:this.dateService.now()})}getLastLocation(){let e=this.tabStorage.getJSON(this.lastLocationKey);return e=e?.timestamp&&this.dateService.hrtTimeOrigin-e?.timestamp<this.internalLoadLimit?this.env.win.location.href===e?.locationURL?null:e:null,e}}class _s{tabOpenerDetector;env;constructor(e,t){this.tabOpenerDetector=e,this.env=t}send(e,t){const i=this.tabOpenerDetector.getOpener(!0),s={event_type:Ji.NAVIGATION,pulse:"event",data:{initial:e,source:t,click_source:{}},event_priority:Gi.High};i?.element&&this.tabOpenerDetector.isFirstNavigation()&&e&&(s.data.click_source={section:i?.name,group:i?.group,popup_component:i?.popupComponent,popup_component_type:i?.popupComponentType,tab_id:i?.id,url:i?.url,type:i?.type,element:{id:i?.element?.id,name:i?.element?.name,node_type:i?.element?.nodeName,class_list:i?.element?.classList},additional_properties:i?.additionalProperties});const n=this.tabOpenerDetector.getTriggerEvent(e);!this.tabOpenerDetector.isFirstNavigation()&&n?.element&&(s.data.click_source={section:n?.name,group:n?.group,popup_component:n?.popupComponent,popup_component_type:n?.popupComponentType,tab_id:n?.id,url:n?.url,element:{id:n?.element?.id,name:n?.element?.name,node_type:n?.element?.nodeName,class_list:n?.element?.classList},additional_properties:n?.additionalProperties}),this.env.win.dataLayer?.push(s)}}function Es(e,t,i){var s=v(e)||t||i?{next:e,error:t,complete:i}:e;return s?Q(function(e,t){var i;null===(i=s.subscribe)||void 0===i||i.call(s);var n=!0;e.subscribe(X(t,function(e){var i;null===(i=s.next)||void 0===i||i.call(s,e),t.next(e)},function(){var e;n=!1,null===(e=s.complete)||void 0===e||e.call(s),t.complete()},function(e){var i;n=!1,null===(i=s.error)||void 0===i||i.call(s,e),t.error(e)},function(){var e,t;n&&(null===(e=s.unsubscribe)||void 0===e||e.call(s)),null===(t=s.finalize)||void 0===t||t.call(s)}))}):H}!function(e){e[e.LinkInteraction=1]="LinkInteraction",e[e.Link=2]="Link",e[e.Interaction=3]="Interaction",e[e.Focus=4]="Focus",e[e.Visibility=5]="Visibility",e[e.NoVisibility=6]="NoVisibility"}(Yi||(Yi={}));const Ts=["click","contextmenu"],ks=[...Ts];class Cs{visibilityTracker;win;tabManagerService;config;activityTrackerUtils;interactionEventsSubject;mutationEventsSubject;lastClickSourceInformation;constructor(e,t,i,s,n){this.visibilityTracker=e,this.win=t,this.tabManagerService=i,this.config=s,this.activityTrackerUtils=n,this.registerListeners()}interactions(){return this.interactionEventsSubject}mutations(){return this.mutationEventsSubject}registerListeners(){if(!this.interactionEventsSubject){const e=this.interactionEvents(),t=this.mutationEvents(),i=new je,s=new je;e.subscribe(i),t.subscribe(s),this.interactionEventsSubject=i,this.mutationEventsSubject=s}}mutationEvents(){const e=new je;return new MutationObserver(t=>{const i=this.getMutatedElements(t,"addedNodes"),s=this.getMutatedElements(t,"removedNodes");(i.length||s.length)&&e.next({mutatedElements:[...i,...s]})}).observe(document,{childList:!0,subtree:!0}),e}shouldCollectDynamicAttributes(e){return Boolean(e.component&&e.componentType)}isHidden(e){const t=this.win.win.getComputedStyle(e);return"none"===t.display||"hidden"===t.visibility||void 0===t.display}interactionEvents(){const e=this.win.doc.body,t={capture:!0,passive:!0};return kt(ks).pipe(ge(i=>Oi(e,i,t)),Lt(),ge(e=>this.processWindowEvent(e)),ee(Boolean),Es(e=>{"click"!==e.type&&"contextmenu"!==e.type||e.doNotTrack||!e.clickable||(this.lastClickSourceInformation={name:e.section.name,group:e.section.group,element:e.element,popupComponent:e.section.popupComponent,popupComponentType:e.section.popupComponentType,url:e.docURL,tab_id:Zi(this.config.eventEnrichment,"tab_id")?this.tabManagerService.getTabId():"",additionalProperties:e.additionalProperties})}))}getMutatedElements(e,t){return e.flatMap(e=>{const i=e.target;return Array.from(e[t]).map(e=>({node:e,target:i}))}).filter(({node:e})=>e instanceof HTMLElement).flatMap(e=>{const i=this.getInteractionInfoFor(e.node,e.target);let s;if(!i)return[];if(i&&(this.activityTrackerUtils.hasAttribute("pulse-component",i.element)||this.activityTrackerUtils.hasAttribute("data-pulse-component",i.element)))s=this.activityTrackerUtils.createInteractionElement(i.element);else{const e=i.element.querySelectorAll("[pulse-component], [data-pulse-component]");if(!e||!e[0])return[];s=this.activityTrackerUtils.createInteractionElement(e[0])}const n=s.attributeValueByName["pulse-component"]||s.attributeValueByName["data-pulse-component"],r=s.attributeValueByName["pulse-component-type"]||s.attributeValueByName["data-pulse-component-type"];if("addedNodes"===t&&this.isHidden(i.element))return[];const o=this.shouldCollectDynamicAttributes({component:n,componentType:r})?this.activityTrackerUtils.collectDynamicAttributes(i.element):void 0;return{element:s,component:n,componentType:r||n,mutationType:t,section:this.activityTrackerUtils.createSection(i.section,i.sectionGroup),additionalProperties:o&&Object.keys(o).length>0?o:void 0}})}processWindowEvent(e){if(!e.target)return null;const t=this.getInteractionInfoFor(e.target);if(!t)return null;const i=this.activityTrackerUtils.collectDynamicAttributes(t.element),s=this.win.doc;return{type:e.type,trusted:e.isTrusted??!0,eventPhase:e.eventPhase,bubbles:e.bubbles,section:this.activityTrackerUtils.createSection(t.section,t.sectionGroup,t.popupComponent,Object.keys(i).length>0?i:void 0),element:this.activityTrackerUtils.createInteractionElement(t.element),docFocused:s.hasFocus(),docVisible:this.visibilityTracker.visible,docURL:s.location.href,doNotTrack:t.doNotTrack,clickable:t.clickable,ts:Date.now(),additionalProperties:Object.keys(i).length>0?i:void 0}}getInteractionInfoFor(e,t){const i=this.win.doc,s=e instanceof Node&&e!==i&&e!==i.head?e:i.documentElement;let n=this.activityTrackerUtils.getFirstParentElement(s);if(!n)return;const r=this.activityTrackerUtils.getTargetType(s),o=t instanceof Element?t.closest("[pulse-section]")||t.closest("[data-pulse-section]"):void 0,a=t instanceof Element?t.closest("[pulse-section-group]")||t.closest("[data-pulse-section-group]"):void 0,c=o||n.closest("[pulse-section]")||n.closest("[data-pulse-section]")||void 0,u=n.closest("[pulse-component]")||n.closest("[data-pulse-component]")||void 0,h=a||n.closest("[pulse-section-group]")||n.closest("[data-pulse-section-group]")||void 0,l=this.activityTrackerUtils.clickableTarget(n);n=l||n;const d=Boolean(n.closest("[pulse-dnt]"))||Boolean(n.closest("[data-pulse-dnt]"));return{clickable:Boolean(l),doNotTrack:Boolean(d),type:r,element:n,section:c,sectionGroup:h,popupComponent:u}}}class Is{tabInfoService;tabStorage;activitySyncService;tabManager;date;env;config;opener=null;firstNavigationKey="first_navigation";firstNavigation=!0;constructor(e,t,i,s,n,r,o){this.tabInfoService=e,this.tabStorage=t,this.activitySyncService=i,this.tabManager=s,this.date=n,this.env=r,this.config=o}getOpener(e=!1){const t=this.opener||this.fetchOpener(),i=this.tabStorage.getJSON(this.firstNavigationKey),s=void 0===i?.firstNavigation;this.firstNavigation=s,this.tabStorage.setJSON(this.firstNavigationKey,{firstNavigation:!1,lastNavigationCount:i?.lastNavigationCount||0,lastNavigationUrl:e&&s?this.env.win.location.href:i?.lastNavigationUrl||""});const n="number"!=typeof this.env.win.history?.length||1===this.env.win.history.length,r=this.env.win.history.length>1&&s,o=r?5e3:0,a=n?this.config.tabOpenerDetectionTimeWindow:Math.max(o,Math.min(1e3,this.config.tabOpenerDetectionTimeWindow/2)),c=n?Yi.NoVisibility:Yi.Focus;if(t?.id)return t;let u,h=null;this.env.win.opener&&(h=this.tabManager.getSiblingTabId({win:this.env.win.opener})),u=h?this.tabInfoService.fetchSiblingTabs(h):this.tabInfoService.fetchSiblingTabs();const l=u.map(e=>{const t=this.activitySyncService.getTabEvents(e.id)||[];return{tabId:e.id,events:t}}),d=this.detectOpener(this.env.win.document.referrer,l,a,c,r);this.setOpener({id:d?.tabId||h,type:d?.type,url:d?.eventUrl,name:d?.section.name,group:d?.section.group,element:d?.element,popupComponent:d?.section?.popupComponent,popupComponentType:d?.section?.popupComponentType,additionalProperties:d?.additionalProperties});return d?.tabId?{id:d?.tabId,type:d?.type,url:d?.eventUrl,name:d?.section.name,group:d?.section.group,element:d?.element,popupComponent:d?.section?.popupComponent,popupComponentType:d?.section?.popupComponentType,additionalProperties:d?.additionalProperties}:null}isFirstNavigation(){return this.firstNavigation}getTriggerEvent(e=!1){if(!Zi(this.config.eventEnrichment,"tab_id"))return null;const t=this.tabStorage.getJSON(this.firstNavigationKey),i=void 0===t?.firstNavigation,s=t?.lastNavigationCount||0;this.tabStorage.setJSON(this.firstNavigationKey,{firstNavigation:!1,lastNavigationCount:this.env.win.history.length,lastNavigationUrl:this.env.win.location.href}),this.firstNavigation=i;const n=this.env.win.history.length-s>1&&!i,r=n?5e3:e?3500:500,o=Yi.NoVisibility,a=t?.lastNavigationUrl||this.env.win.document.referrer,c=this.tabInfoService.getCurrentTab(),u=this.activitySyncService.getTabEvents(c.id)||[],h=this.detectTriggerEvent(a,u,r,o,n,c.id);return h?{id:h?.tabId,type:h?.type,url:h?.eventUrl,name:h?.section.name,group:h?.section.group,popupComponent:h?.section?.popupComponent,popupComponentType:h?.section?.popupComponentType,element:h?.element,additionalProperties:h?.additionalProperties}:null}fetchOpener(){return this.opener=this.tabStorage.getJSON("tab_opener"),this.opener}detectOpener(e,t,i,s,n){const r=this.createDetectorEvents(e,t).filter(e=>e.timeDiff<=i);if(!r.length)return null;for(let t=1;t<=s;t++){const i=this.filterAccuracyMatches(r,e,t,n);if(i.length&&(t<Yi.NoVisibility||1===this.countTabs(i)))return i[0]||null}return null}detectTriggerEvent(e,t,i,s,n,r){const o=this.ctreateTriggerEvents(e,t,r).filter(e=>e.timeDiff<=i);if(!o.length)return null;for(let t=1;t<=s;t++){const i=this.filterAccuracyMatches(o,e,t,n);if(i.length&&t<Yi.NoVisibility)return i[0]||null}return null}setOpener(e){return this.opener=e,this.tabStorage.setJSON("tab_opener",this.opener)}filterAccuracyMatches(e,t,i,s){switch(i){case Yi.LinkInteraction:return this.filterLinkInteractionEvents(e,t);case Yi.Link:return this.filterLinkEvents(e,t);case Yi.Interaction:return this.filterInteractionEvents(e,t);case Yi.Focus:return this.filterFocusedEvents(e,t,s);case Yi.Visibility:return this.filterVisibleEvents(e,t);case Yi.NoVisibility:default:return this.filterNoVisibility(e,t)}}filterLinkInteractionEvents(e,t){return e.filter(e=>(!t||e.docURL.startsWith(t))&&this.isLinkMatch(e)&&this.isInteractionEvent(e)&&e.docFocused&&e.docVisible)}filterLinkEvents(e,t){return e.filter(e=>(!t||e.docURL.startsWith(t))&&this.isLinkMatch(e)&&e.docFocused&&e.docVisible)}filterInteractionEvents(e,t){return e.filter(e=>(!t||e.docURL.startsWith(t))&&this.isInteractionEvent(e)&&e.docFocused&&e.docVisible)}filterFocusedEvents(e,t,i){return e.filter(e=>i?e.docFocused&&e.docVisible:(!t||e.docURL.startsWith(t))&&e.docFocused&&e.docVisible)}filterVisibleEvents(e,t){return e.filter(e=>(!t||e.docURL.startsWith(t))&&e.docVisible)}filterNoVisibility(e,t){return e.filter(e=>!t||e.docURL.startsWith(t))}isLinkMatch(e){if(e.element&&"A"===e.element.nodeName){const t=e.element.attributes.find(e=>"href"===e.name)?.value;return t===this.config.initialDocURL}return!1}isInteractionEvent(e){return-1!==Ts.indexOf(e.type)}countTabs(e){return new Set(e.map(e=>e.tabId)).size}createDetectorEvents(e,t){const i=this.date.hrtTimeOrigin-2,s=[];for(const n of t){const t=n.events.map(t=>({...t,tabId:n.tabId,timeDiff:Math.abs(i-t.ts),referrerMatch:!e||t.docURL.startsWith(e),eventUrl:t.docURL}));s.push(...t)}return s.sort((e,t)=>e.timeDiff>t.timeDiff?1:e.timeDiff<t.timeDiff?-1:0)}ctreateTriggerEvents(e,t,i){const s=this.date.now()-2;let n=[];return n=t.map(t=>({...t,tabId:i,timeDiff:Math.abs(s-t.ts),referrerMatch:!e||t.docURL.startsWith(e),eventUrl:t.docURL})),n.sort((e,t)=>e.timeDiff>t.timeDiff?1:e.timeDiff<t.timeDiff?-1:0)}}class xs{pulseStorage;config;stateService;infected=[];newExperimentTrigger$=new z;constructor(e,t,i){this.pulseStorage=e,this.config=t,this.stateService=i,this.infected=this.getInfectedFromStorage(),this.stateService.setState({infected:this.infected}),this.pulseStorage.change(this.config.experimentStorageKey,Ue.Full,$e.All).subscribe(e=>{e.value&&(this.newExperimentTrigger$.next(!0),this.infected=this.getInfectedFromStorage(),this.infected&&this.infected.length?this.stateService.setState({infected:this.infected}):this.stateService.removePropertyFromState("infected"))})}getInfected(){return this.infected}getInfectedFromStorage(){const e=this.pulseStorage.getJSON(this.config.experimentStorageKey);return e?e?.filter(e=>e.participation_date&&e.trackable).map(e=>({id:e.name,variant:e.variant,participation_timestamp:e.participation_date,participation_session:e.participation_session})):[]}}class Ps{indexedDBService;quote;deviceIdService;dateService;attributesStorageKey="attributesStore";constructor(e,t,i,s){this.indexedDBService=e,this.quote=t,this.deviceIdService=i,this.dateService=s,e.connectDB()}async getCachedAttributes(){const e=await this.indexedDBService.getValue(this.attributesStorageKey,"attributes");if(null!=e)return e}async getCachedHints(){const e=await this.indexedDBService.getValue(this.attributesStorageKey,"hints");if(null!=e)return e}async cacheAttributes(e,t=!1){const i=await this.quote.quoteSize(),s=(new TextEncoder).encode(JSON.stringify({id:"attributes",attributes:e,attributesSent:!1,did:this.deviceIdService.getDeviceId(),time:this.dateService.now()})).length;i&&i-s>1e6||null===i?await this.indexedDBService.putValue(this.attributesStorageKey,{id:"attributes",attributes:e,attributesSent:t,did:this.deviceIdService.getDeviceId(),time:this.dateService.now()}):console.error("There is no enough space to store attributes")}async cacheHints(e,t=!1){const i=await this.quote.quoteSize(),s=(new TextEncoder).encode(JSON.stringify({id:"hints",hints:e,hintsSent:!1,did:this.deviceIdService.getDeviceId(),time:this.dateService.now()})).length;i&&i-s>1e6||null===i?await this.indexedDBService.putValue(this.attributesStorageKey,{id:"hints",hints:e,hintsSent:t,did:this.deviceIdService.getDeviceId(),time:this.dateService.now()}):console.error("There is no enough space to store attributes")}async markSent(e){if("hints"===e){const e=await this.getCachedHints();e&&this.cacheHints(e.hints,!0)}if("attributes"===e){const e=await this.getCachedAttributes();e&&this.cacheAttributes(e.attributes,!0)}}}class Ns{env;constructor(e){this.env=e}getHardwareInfo(){const{navigator:e}=this.env.win,t=this.getGPU();return{device_memory:e.deviceMemory||void 0,cpus:e.hardwareConcurrency||void 0,gpu_vendor:t?.vendor,gpu_renderer:t?.renderer}}getScreenInfo(){const e=this.env.win,t=e.screen;return{touch:e.navigator.maxTouchPoints>0||e.navigator.msMaxTouchPoints>0||"ontouchstart"in navigator,resolution_x:t.width,resolution_y:t.height,available_resolution_x:t.availWidth,available_resolution_y:t.availHeight,pixel_ratio:e.devicePixelRatio,pixel_depth:t.pixelDepth}}getNavigatorInfo(){const e=this.env.win.navigator;let t=e.language||e.languages[0]||"unknown";return t=(t.split("-").shift()??"").trim()||"unknown",{device_language_code:t,browser_platform:e.userAgentData?.platform??e.platform??"unknown",browser_vendor:this.getBrowserBrand(e)}}getUserAgent(){return this.env.win.navigator.userAgent}getBrowserBrand(e){return e.userAgentData?.brands?.[0]?.brand||e.userAgent||"unknown"}getGPU(){const e=this.env.win.document.createElement("canvas");try{const t=e.getContext("webgl")||e.getContext("experimental-webgl"),i=t?.getExtension("WEBGL_debug_renderer_info");if(!i)return;const s=t.getParameter(i.UNMASKED_VENDOR_WEBGL),n=t.getParameter(i.UNMASKED_RENDERER_WEBGL);if(s||n)return{vendor:s,renderer:n}}catch(e){console.warn(e)}}}class As{deviceInfoService;utmService;storage;date;config;sessionService;batchQueue;env;KEY_LAST_ATTRIBUTE_SYNC="attr";queueState;constructor(e,t,i,s,n,r,o,a){this.deviceInfoService=e,this.utmService=t,this.storage=i,this.date=s,this.config=n,this.sessionService=r,this.batchQueue=o,this.env=a,this.sessionService.newSessionGenerated$.subscribe(e=>{this.date.now()-e<100&&this.send(!0)})}async send(e=!1){const t=this.getHints(),i=this.getDeviceAttributes(),s=this.utmService.getUTMParams();(this.shouldSendHintsOld()||e)&&(this.env.win.dataLayer?.push({pulse:"attribute_hints",user_agent:t}),s?this.env.win.dataLayer?.push({pulse:"attribute",...s,...i}):this.env.win.dataLayer?.push({pulse:"attribute",...i}),this.queueState=this.batchQueue.queueEmpty$.subscribe(()=>{this.sent()}))}getDeviceAttributes(){return{...this.deviceInfoService.getScreenInfo(),...this.deviceInfoService.getHardwareInfo(),...this.deviceInfoService.getNavigatorInfo(),pa_open_time:Math.round(this.getOpenTime()/1e3)}}getHints(){return this.deviceInfoService.getUserAgent()}shouldSendHintsOld(){const e=Number(this.storage.get(this.KEY_LAST_ATTRIBUTE_SYNC)||"0");return this.date.now()-e>this.config.attributeSyncIntervalMS}sent(){this.queueState?.unsubscribe(),this.storage.set(this.KEY_LAST_ATTRIBUTE_SYNC,this.date.now().toString())}getOpenTime(){const e=this.sessionService.getSession().sessionId.match(/^(\d+)_.*$/);let t=this.date.now();return e&&(t=Number(e[1])),t}}class Os{tabStorage;transientStorage;lockManager;uuid;quote;env;tabIdKey="tab_id";tabId;enabled=!0;config={storagePrefix:"paa_"};constructor(e,t,i,s,n,r,o){this.tabStorage=e,this.transientStorage=t,this.lockManager=i,this.uuid=s,this.quote=n,this.env=r,this.enabled=Zi(o.eventEnrichment,"tab_id")}async init(){this.enabled&&(this.tabId=await this.trackTabId())}getSiblingTabId(e){try{if(!p(this.env.win))return null;if(!this.isSameHost(e.win,this.env.win))return null;return new Mi(e,this.config,this.quote,this.transientStorage).get(this.tabIdKey)}catch{return console.error("Sibling tab referance is invalid"),null}}getTabId(){if(!this.tabId)throw new Error("TabManager is not initialized!");return this.tabId}async trackTabId(){const e=this.tabStorage.get(this.tabIdKey);let t=await this.lockAndUseTabId(e);if(!t){const e=this.uuid.generate();return t=await this.lockAndUseTabId(e),t||console.warn("Failed to lock the tab identifier!"),e}return t}async lockAndUseTabId(e){if(!e)return null;const t=`${this.tabIdKey}_${e}`;return await this.lockManager.request(t)?(this.tabStorage.set(this.tabIdKey,e),e):(this.tabStorage.clear(),null)}isSameHost(e,t){try{return e.location.host===t.location.host}catch{return!1}}}class Rs{persistentStorage;activityTracker;date;config;pageEvents=[];constructor(e,t,i,s){this.persistentStorage=e,this.activityTracker=t,this.date=i,this.config=s,this.persistentStorage.freeSpace$.subscribe(()=>{this.clearClosedTabsActivity()})}startService(e){this.activityTracker.interactions().subscribe(t=>{const i=this.date.now();this.pageEvents.push(t),this.pageEvents=this.pageEvents.slice(this.pageEvents.length-100).filter(e=>i-e.ts<=this.config.tabOpenerDetectionTimeWindow),this.pageEvents.length?this.persistentStorage.setJSON(`tab_activity_${e}`,this.pageEvents):this.remove(e)}),this.clearClosedTabsActivity()}getTabEvents(e){return this.persistentStorage.getJSON(`tab_activity_${e}`)}remove(e){this.persistentStorage.remove(`tab_activity_${e}`)}clearClosedTabsActivity(){const e=this.fetchOpenTabIds();this.persistentStorage.keys().filter(e=>e.startsWith("tab_activity_")).filter(t=>{const i=this.getTabEvents(t.replace("tab_activity_",""))?.map(e=>e.ts).reduce((e,t)=>Math.max(e,t));return!i||(this.date.now()-i>this.config.tabOpenerDetectionTimeWindow+5e3||-1===e.indexOf(t.replace("tab_activity_","")))}).map(e=>this.persistentStorage.remove(e))}fetchOpenTabIds(){return this.persistentStorage.keys().filter(e=>e.startsWith("tab_info_")).map(e=>e.replace("tab_info_",""))}}class Ls{persistentStorage;visibilityService;activityTracker;activitySynchronizer;date;config;tabId;unloaded=!1;persisted=!1;lastActivity;constructor(e,t,i,s,n,r){this.persistentStorage=e,this.visibilityService=t,this.activityTracker=i,this.activitySynchronizer=s,this.date=n,this.config=r;const o=n.now();this.lastActivity=o,this.persistentStorage.freeSpace$.subscribe(()=>{this.cleanup()})}startService(e){this.tabId=e,this.setupActivityTracker(),this.updateTabInfo(),this.cleanup()}fetchSiblingTabs(e=""){if(!Zi(this.config.eventEnrichment,"tab_id"))return[];if(!this.tabId)throw new Error("Tab identifier is not available!");const t=this.tabId;return this.persistentStorage.keys().filter(i=>i.startsWith(`tab_info_${e}`)&&-1===i.indexOf(t)).map(e=>this.persistentStorage.getJSON(e)).filter(Boolean)}getCurrentTab(){if(!this.tabId)throw new Error("Tab identifier is not available!");return{id:this.tabId,lastActivity:this.lastActivity,persisted:this.persisted,unloaded:this.unloaded,visible:this.visibilityService.visible}}updateTabInfo(){const e=this.getCurrentTab();this.persistentStorage.setJSON(`tab_info_${e.id}`,e)}cleanup(){const e=this.date.now(),t=this.fetchSiblingTabs().filter(t=>e-t.lastActivity>this.config.tabOpenerDetectionTimeWindow);for(const e of t)this.persistentStorage.remove(`tab_info_${e.id}`),this.activitySynchronizer.remove(e.id)}setupActivityTracker(){this.visibilityService.legacyPageHide().subscribe(e=>{this.unloaded=!0,this.persisted=e.persisted,this.updateTabInfo()}),this.visibilityService.legacyOnUnload().subscribe(()=>{this.unloaded=!0,this.updateTabInfo()}),this.activityTracker.interactions().subscribe(()=>{this.lastActivity=this.date.now(),this.updateTabInfo()})}}class Ds{debug;debugControl;config;deviceIdService;constructor(e,t,i,s){this.debug=e,this.debugControl=t,this.config=i,this.deviceIdService=s}displayControl(){this.debugControl.registerControl({control:"debug",content:"Debug mode is enabled",title:"",url:"https://picsart.tools/organization/picsart/app/picsart-website/debugger",deviceId:this.deviceIdService.getDeviceId(),callbackFn:this.disableDebugMode.bind(this)})}disableDebugMode(){this.debugControl.unregisterControl("debug"),this.debug.disable("debugger"),this.debug.disable(this.config.debugLiveEventKey)}}class Ms{static commandMap=new Map([["event","event"],["send","event"],["set","set"],["state","set"]])}class $s extends Ms{plugins;pipes;logger;defaultPipes;queue;sessionService;tabManagerService;date;config;stateService;constructor(e,t,i,s,n,r,o,a,c,u){super(),this.plugins=e,this.pipes=t,this.logger=i,this.defaultPipes=s,this.queue=n,this.sessionService=r,this.tabManagerService=o,this.date=a,this.config=c,this.stateService=u;const h=this.getContext();e.init(h)}event(e,t=Gi.Normal){this.events([e],t)}events(e,t=Gi.Normal){this.processMessages("event",e,t)}attribute(e,t=Gi.Normal){this.attributes([e],t)}attributes(e,t=Gi.Normal){this.processMessages("attribute",e,t)}attributeHint(e,t=Gi.Normal){this.processMessages("attribute-hint",[e],t)}set(e){if("object"!=typeof e||!e||Array.isArray(e))return;const t={...e};delete t.language_code,this.stateService.setState(t)}state(e){this.set(e)}cmd(e,...t){if(Array.isArray(e))return this.cmd(e[0],...e.slice(1));const i=e.split("."),s=this[$s.commandMap.get(i[1]||i[0]||"")||i[0]||""];"function"==typeof s?s.apply(this,t):this.logger.warn("Tracker",`Pulse command '${e}' not found!`)}flush(){this.queue.flush()}getContext(){return{config:this.config,session:this.sessionService.getSession(),tracker:this}}getTabId(){return this.tabManagerService.getTabId()}processMessages(e,t,i){const s=this.getContext(),n=t.map(t=>{let n;try{n=oi(t)}catch(e){console.error("The event provided has an incorrect schema.",e)}return{type:e,data:n,priority:i,state:s.session.state,timestamp:this.date.now()}}),r=n.flatMap(e=>this.pipes.transform(e,s).map(e=>this.defaultPipes.transform(e,s)).flat().map(e=>this.defaultPipes.enrich(e,s)).map(e=>this.pipes.enrich(e,s)));this.queue.push(...r)}}function Us(e,t){return Q(function(i,s){var n=null,r=0,o=!1,a=function(){return o&&!n&&s.complete()};i.subscribe(X(s,function(i){null==n||n.unsubscribe();var o=0,c=r++;le(e(i,c)).subscribe(n=X(s,function(e){return s.next(t?t(i,e,c,o++):e)},function(){n=null,a()}))},function(){o=!0,a()}))})}function Bs(e,t){return void 0===e&&(e=0),void 0===t&&(t=Wt),e<0&&(e=0),function(e,t,i){void 0===e&&(e=0),void 0===i&&(i=Yt);var s=-1;return null!=t&&(xt(t)?i=t:s=t),new V(function(t){var n=Qt(e)?+e-i.now():e;n<0&&(n=0);var r=0;return i.schedule(function(){t.closed||(t.next(r++),0<=s?this.schedule(void 0,s):t.complete())},n)})}(e,e,t)}function js(e){return function(e){let t=e.length;for(let i=e.length-1;i>=0;i--){const s=e.charCodeAt(i);s>127&&s<=2047?t++:s>2047&&s<=65535&&(t+=2),s>=56320&&s<=57343&&i--}return t}(JSON.stringify(e))}function Hs(e,t){const i=[...e],s=[];let n=0;for(let e=0;e<i.length;e++){const r=Vs([i[e]],t),o=js({chunks:r});if(o>6e4){s.push({chunks:r,keepAlive:!1,size:o}),i.splice(e,1),e-=1;continue}const a=Vs(i.slice(n,e+1),t),c=js(a),u={chunks:a,keepAlive:!0,size:c};c>6e4?(Fs(i.slice(n,e),s,t),n=e,e===i.length-1&&Fs(i.slice(n,e+1),s,t)):e===i.length-1&&s.push(u)}return s}function Fs(e,t,i){const s=Vs(e,i),n={chunks:s,keepAlive:!0,size:js(s)};t.push(n)}function Vs(e,t){const i=new Map;for(const t of e){let e=i.get(t.state);e||(e=[],i.set(t.state,e)),e.push(t)}return Array.from(i).map(e=>{const i=[],s=[];let n;return e[1].map(e=>{switch(e.type){case"event":i.push(e.data);break;case"attribute":s.push(e.data);break;case"attribute-hint":n=e.data}}),{config:t,header:e[0],events:i,attributes:s,attributeHints:n}})}function qs(e,t=!0){const i=Zi(e.stateEnrichment,"device_id"),s=Zi(e.stateEnrichment,"session_id"),n=Zi(e.eventEnrichment,"tab_id"),r=!!t&&e.serverCookies;return{deviceId:i?e.sessionStorageType:"none",sessionId:s?e.sessionStorageType:"none",tabId:n?e.tabManagerStorageType:"none",serverCookies:r}}class Ks{consentService;config;batchQueue;visibility;queueEmpty$;trackingEnabled;batchConfig;messageReceived=new z;flushRequested=new z;constructor(e,t,i,s){this.consentService=e,this.config=t,this.batchQueue=i,this.visibility=s,this.queueEmpty$=i.queueEmpty$,this.batchConfig=qs(this.config,this.trackingEnabled),this.consentService.trackingEnabled().subscribe(e=>{this.trackingEnabled=e,this.batchConfig=qs(this.config,this.trackingEnabled)}),this.visibility.onVisibilityChange().subscribe(async e=>{!e&&this.trackingEnabled?(this.flush(),this.batchQueue.stopQueue()):e&&this.trackingEnabled&&this.batchQueue.startQueue()}),this.start()}push(...e){const t=e.some(e=>e.priority===Gi.Force),i=e.some(e=>e.priority===Gi.High)||t;(this.trackingEnabled||t)&&(e.forEach(e=>this.messageReceived.next(e)),(i&&this.trackingEnabled||t)&&this.flushRequested.next())}flush(){this.flushRequested.next()}start(){const e=new z,t=e.pipe(Mt({}),Us(()=>Bs(this.config.batchTimeMS))),i=new J(0),s=new z;i.pipe(ee(e=>e===this.config.batchSize+1)).subscribe(()=>{s.next()});const n=At([t,s,this.flushRequested]);var r;kt(this.messageReceived).pipe(Es(()=>i.next(i.value+1)),(r=n,Q(function(e,t){var i=[];return e.subscribe(X(t,function(e){return i.push(e)},function(){t.next(i),t.complete()})),le(r).subscribe(X(t,function(){var e=i;i=[],t.next(e)},I)),function(){i=null}}))).subscribe(t=>{i.next(0),e.next(),this.pushToBatchQueue(t)}),i.next(0),s.next(),this.flushRequested.next(),e.next()}pushToBatchQueue(e){const t=Hs(e,this.batchConfig);t.length&&t.map(e=>this.batchQueue.pushBatch(e))}}class zs{storage;lockManager;uuid;visibility;consentService;transport;config;batchQueue=[];sendingBatches=[];trackingEnabled;currentRequestSize=0;beaconLimit=6e4;queueProcessor=null;STORED_BATECHES_KEY="pulse-unpublished-events";batchConfig;queueEmpty$=new z;constructor(e,t,i,s,n,r,o){this.storage=e,this.lockManager=t,this.uuid=i,this.visibility=s,this.consentService=n,this.transport=r,this.config=o,this.trackingEnabled&&this.queueStoredMessagesIfAny(),this.listenAndQueueOnStoreChanges(),this.consentService.trackingEnabled().subscribe(e=>{this.trackingEnabled=e,this.batchConfig=qs(this.config,this.trackingEnabled)}),this.batchConfig=qs(this.config,this.trackingEnabled)}pushBatch(e){const t=this.uuid.generate();this.visibility.visible?(this.batchQueue.push({batch:e,batchId:t}),this.queueProcessor||this.controlQueueProcessor()):(this.storeBatches([{batch:e,batchId:t}]),this.clearQueue(),this.sendStoredBatches())}startQueue(){this.queueStoredMessagesIfAny(),this.batchQueue.length&&!this.queueProcessor&&this.controlQueueProcessor()}async stopQueue(){if(this.stopQueueProcessor(),this.batchQueue.length){const e=this.batchQueue[0].batch.size||0;(!this.currentRequestSize||this.currentRequestSize+e<this.beaconLimit)&&(this.currentRequestSize=this.currentRequestSize+e,this.sendBatch(this.batchQueue[0].batch,this.batchQueue[0].batchId).then(e=>this.handleResponse(e)).catch(e=>{console.error(e)}),this.sendingBatches.push(this.batchQueue[0]),this.batchQueue.splice(0,1))}this.storeBatches([...this.batchQueue]),this.clearQueue(),await Ke(500),this.sendStoredBatches()}async queueStoredMessagesIfAny(){if(await this.lockManager.locked(this.STORED_BATECHES_KEY))return void this.postpone(this.queueStoredMessagesIfAny);const e=await this.lockManager.request(this.STORED_BATECHES_KEY,6e3);if(!e)return void this.postpone(this.queueStoredMessagesIfAny);const t=this.storage.getJSON(this.STORED_BATECHES_KEY)||[];if(this.storage.remove(this.STORED_BATECHES_KEY),this.lockManager.release(e),t.length){if("batchId"in t[0])t.forEach(e=>{this.batchQueue.some(t=>t.batchId===e.batchId)||this.batchQueue.push(e)});else{Hs(t,this.batchConfig).forEach(e=>this.pushBatch(e))}this.batchQueue.length&&!this.queueProcessor&&this.controlQueueProcessor()}}listenAndQueueOnStoreChanges(){this.storage.change(this.STORED_BATECHES_KEY).subscribe(async()=>{this.queueStoredMessagesIfAny()})}storeBatches(e){const t=this.storage.getJSON(this.STORED_BATECHES_KEY)||[],i=e||[];this.storage.set(this.STORED_BATECHES_KEY,JSON.stringify([...t,...this.batchQueue,...i,...this.sendingBatches]))}clearQueue(){this.batchQueue=[]}controlQueueProcessor(){this.queueProcessor||(this.queueProcessor=setInterval(()=>{if(this.batchQueue.length||this.sendingBatches.length||(this.queueEmpty$.next(!0),this.currentRequestSize=0),0===this.batchQueue.length&&this.queueProcessor)return void this.stopQueueProcessor();const e=this.batchQueue[0].batch.size||0;if(!this.currentRequestSize||this.currentRequestSize+e<this.beaconLimit){this.currentRequestSize+=e;const t=this.batchQueue.shift();t&&(this.sendingBatches.push(t),this.sendBatch(t.batch,t.batchId).then(e=>this.handleResponse(e)).catch(e=>console.error(e))),0===this.batchQueue.length&&this.queueProcessor&&(this.sendingBatches.length||this.queueEmpty$.next(!0),this.stopQueueProcessor(),this.queueProcessor=null)}},100))}stopQueueProcessor(){this.queueProcessor&&(clearInterval(this.queueProcessor),this.queueProcessor=null)}handleResponse({size:e,batchId:t}){this.currentRequestSize-=e;const i=this.sendingBatches.findIndex(e=>e.batchId===t);-1!==i&&this.sendingBatches.splice(i,1),this.sendingBatches.length||this.batchQueue.length||this.queueEmpty$.next(!0)}sendBatch(e,t){return new Promise(i=>{const s=Boolean(e.keepAlive);delete e.keepAlive,this.transport.send(e,s,i,t)})}async sendStoredBatches(){if(await Ke(1e3),this.visibility.visible)return;if(await this.lockManager.locked(this.STORED_BATECHES_KEY))return void this.postpone(this.sendStoredBatches);const e=await this.lockManager.request(this.STORED_BATECHES_KEY,6e3);if(!e)return void this.postpone(this.sendStoredBatches);const t=this.storage.getJSON(this.STORED_BATECHES_KEY)||[];if(!t.length)return void this.lockManager.release(e);const i=t.splice(0,1);this.storage.set(this.STORED_BATECHES_KEY,JSON.stringify([...t])),this.lockManager.release(e),this.sendBatch(i[0].batch,i[0].batchId).then(()=>{this.visibility.visible||this.sendStoredBatches()}).catch(e=>{console.error(e)})}postpone(e,t=1e3,i){setTimeout(()=>{e.call(this,i)},t)}}class Gs{attributeSpreadPipe;actionParamEventPipe;navigationEventPipe;changedAttributesPipe;eventGlobalsPipe;sourcePipe;pipesHost;defaultPipesHost;config;constructor(e,t,i,s,n,r,o,a,c){this.attributeSpreadPipe=e,this.actionParamEventPipe=t,this.navigationEventPipe=i,this.changedAttributesPipe=s,this.eventGlobalsPipe=n,this.sourcePipe=r,this.pipesHost=o,this.defaultPipesHost=a,this.config=c}registerPipes(){const e=this.config.transformPipes||[],t=this.config.enrichmentPipes||[],i=[{selector:"attribute",use:[this.attributeSpreadPipe,this.changedAttributesPipe]},{selector:"event",use:[this.actionParamEventPipe,this.navigationEventPipe]}],s=[{selector:"event",use:[this.eventGlobalsPipe,this.sourcePipe]}];i.forEach(e=>this.defaultPipesHost.registerTransformSet(e)),s.forEach(e=>this.defaultPipesHost.registerEnrichmentSet(e)),e.forEach(e=>this.pipesHost.registerTransformSet(e)),t.forEach(e=>this.pipesHost.registerEnrichmentSet(e))}}var Js;!function(e){e[e.Visible=0]="Visible",e[e.Hidden=1]="Hidden"}(Js||(Js={}));class Ws{visibility;visibilityState=Js.Visible;constructor(e){this.visibility=e}init(){this.visibility.onVisibilityChange().subscribe(e=>{this.visibilityState=e?Js.Visible:Js.Hidden})}}class Ys{dataLayer;commandPrefix;visibilityChangePlugin;defaultPush;tracker;constructor(e,t,i){this.dataLayer=e,this.commandPrefix=t,this.visibilityChangePlugin=i}init(e){if(this.tracker=e.tracker,!Array.isArray(this.dataLayer))throw new Error("DataLayer must be an array!");this.defaultPush=this.dataLayer.push.bind(this.dataLayer),this.dataLayer.push=this.onPush.bind(this),this.readFromBeginning()}onPush(...e){for(const t of e)this.processItem(t);return this.defaultPush?this.defaultPush(...e):0}readFromBeginning(){for(const e of this.dataLayer)this.processItem(e)}processItem(e){if(!this.tracker||"object"!=typeof e||!e)return;const t=e;if(this.isCommand(e)){const t=Array.from(e);this.tracker.cmd(t)}else if("event"===e.pulse){let i;e.event_priority&&(i=e.event_priority,delete t.event_priority);const s=this.normalize(e);this.tracker.event(s,i||(this.visibilityChangePlugin.visibilityState===Js.Hidden?Gi.High:Gi.Normal))}else if("attribute"===e.pulse){const t=this.normalize(e);this.tracker.attribute(t)}else if("attribute_hints"===e.pulse){const t=this.normalize(e);this.tracker.attributeHint(t)}else if("state"===e.pulse){const t=this.normalize(e);this.tracker.set(t)}else if("custom_event"===t.event||"custom_event_non_interaction"===t.event){const e=t.event_priority;t.event_priority&&delete t.event_priority,this.tracker.event(t.data,2===e?Gi.High:Gi.Normal)}}isCommand(e){return(Array.isArray(e)||"[object Arguments]"===Object.prototype.toString.call(e))&&"string"==typeof e[0]&&e[0].startsWith(this.commandPrefix)}normalize(e){const t={...e};return delete t.paa,t.pulse&&delete t.pulse,t}}class Qs{sessionStartPlugin;navigationEventPlugin;infectedPlugin;visibilityChangePlugin;clickEventPlugin;tabLinkingPlugin;statePlugin;deviceAttributesPlugin;consentEventPlugin;pluginHost;config;facebookPixelAttributePlugin;popupEventPlugin;contextMenuPlugin;internalDataLayer;debugEventPlugin;dataLayer;constructor(e,t,i,s,n,r,o,a,c,u,h,l,d,p,g,f,v){this.sessionStartPlugin=e,this.navigationEventPlugin=t,this.infectedPlugin=i,this.visibilityChangePlugin=s,this.clickEventPlugin=n,this.tabLinkingPlugin=r,this.statePlugin=o,this.deviceAttributesPlugin=a,this.consentEventPlugin=c,this.pluginHost=u,this.config=h,this.facebookPixelAttributePlugin=l,this.popupEventPlugin=d,this.contextMenuPlugin=p,this.internalDataLayer=g,this.debugEventPlugin=f,this.dataLayer=v}registerPlugins(){const e=[this.visibilityChangePlugin,this.debugEventPlugin,this.clickEventPlugin,this.tabLinkingPlugin,this.statePlugin,this.sessionStartPlugin,this.navigationEventPlugin,this.infectedPlugin,this.deviceAttributesPlugin,this.consentEventPlugin,this.facebookPixelAttributePlugin,this.popupEventPlugin,this.contextMenuPlugin,...this.config.plugins||[]];this.dataLayer&&e.push(new Ys(this.dataLayer,"paa.",this.visibilityChangePlugin)),this.internalDataLayer&&Array.isArray(this.internalDataLayer)&&e.push(new Ys(this.internalDataLayer,"",this.visibilityChangePlugin)),e.forEach(e=>this.pluginHost.register(e))}}const Xs=new ye("INTERNAL_DATA_LAYER"),Zs=new ye("DATA_LAYER"),en=new ye("DEFAULT_PIPES_HOST_TOKEN"),tn=new ye("PIPES_HOST_TOKEN");const sn={...ve,sessionTimeoutMS:18e5,attributeTimeoutMS:6048e5,attributeSyncIntervalMS:864e5,plugins:[],transformPipes:[],enrichmentPipes:[],consentChecks:[],serverCookies:!0,sessionStorageType:"persistent",attributesStorageType:"persistent",tabManagerStorageType:"tab",debug:[],debugClear:!1,debugLiveEventKey:"debug-leuid",customerID:"",batchTimeMS:500,batchSize:100,serverBaseURL:"https://t.picsart.com/events/v2/web",eventEnrichment:!0,stateEnrichment:!0,attributeHints:!0,storagePrefix:"paa_",tabOpenerDetectionTimeWindow:6e3,rumUnsafeRequestBodyMeasure:!0,rumReportOnce:[],rumReport:[],dataLayerKey:"dataLayer"};const nn=(new Ce).provide(function(e){return e.useFactory(ot,e=>e,[Se]).useFactory(Zs,(e,t)=>e.win[t.dataLayerKey],[me,ot]).useFactory(Xs,e=>e.win.pulse?.q,[me]).useClass(fs,fs,[Ae]).useClass(vs,vs,[fs,Ei,Je,ot]).useClass(bs,bs,[tt,Xe]).useFactory(ms,(e,t,i,s,n,r,o,a,c)=>new ms(e,t(n.sessionStorageType),i,s,n,r,o,a,c,$e.All),[De,Pe,qe,Je,ot,He,ys,xi,We]).useClass(Ss,Ss,[ys,ot,ze]).useFactory(ws,async(e,t,i,s)=>new ws(e,t(i.tabManagerStorageType),s),[me,Pe,ot,De]).useClass(Ds,Ds,[ys,et,ot,He]).useFactory(ys,(e,t)=>new ys(e(t.sessionStorageType),t),[Pe,ot]).useFactory(_s,(e,t)=>new _s(e,t),[Is,me]).useClass(Ks,Ks,[vs,ot,zs,ji]).useFactory(xs,(e,t,i)=>new xs(e("persistent"),t,i),[Pe,ot,We]).useClass(Ps,Ps,[be,Ye,He,De]).useClass(Ns,Ns,[me]).useFactory(zs,(e,t,i,s,n,r,o)=>new zs(e("persistent"),t,i,s,n,r,o),[Pe,Oe,Si,ji,vs,Ss,ot]).useFactory(As,(e,t,i,s,n,r,o,a)=>new As(e,t,i("persistent"),s,n,r,o,a),[Ns,tt,Pe,De,ot,ms,zs,me]).useClass(Vi,Vi,[]).useClass(tn,qi,[]).useClass(en,qi,[]).useClass(Ki,Ki,[]).useClass(zi,zi,[]).useClass(Qi,Qi,[Xe]).useClass(Xi,Xi,[Je,ot]).useClass(es,es,[ws,Os,Xe,ot,Is,Si,me,xi]).useClass(ts,ts,[bs,ot]).useClass(is,is,[ji]).useClass(hs,hs,[Cs,me]).useClass(gs,gs,[Rs,Ls,Os,ot]).useClass(ss,ss,[ws,_s,ms,vs]).useClass(ds,ds,[xs]).useClass(ns,ns,[ms,xs,ys,ot,Ns,We]).useClass(is,is,[ji]).useClass(rs,rs,[Cs,me]).useClass(os,os,[As]).useClass(as,as,[vs,ms,As,me]).useClass(cs,cs,[Ae,Je,As,me]).useClass(us,us,[Je,qe,ms,me,xi]).useClass(ls,ls,[Cs,me]).useClass(ps,ps,[ys,me,Ds,ot,Ze,xi]).useClass(Qs,Qs,[us,ss,ds,is,hs,gs,ns,os,as,Vi,ot,cs,rs,ls,Xs,ps,Zs]).useClass(Gs,Gs,[Ki,zi,Qi,Xi,es,ts,tn,en,ot]).useFactory(Os,async(e,t,i,s,n,r,o)=>{const a=new Os(e(o.tabManagerStorageType),t,i,s,n,r,o);return await a.init(),a},[Pe,ki,Oe,Si,Ye,me,ot]).useFactory(Ls,(e,t,i,s,n,r)=>new Ls(e(r.sessionStorageType),t,i,s,n,r),[Pe,ji,Cs,Rs,De,ot]).useFactory(Is,(e,t,i,s,n,r,o)=>new Is(e,t(o.tabManagerStorageType),i,s,n,r,o),[Ls,Pe,Rs,Os,De,me,ot]).useFactory(Rs,(e,t,i,s)=>new Rs(e("persistent"),t,i,s),[Pe,Cs,De,ot]).useClass(Cs,Cs,[ji,me,Os,ot,Hi]).useFactory($s,(e,t,i,s,n,r,o,a,c,u,h,l)=>{c.registerPipes(),u.registerPlugins();return new $s(e,t,s,i,n,r,h,o,a,l)},[Vi,tn,en,Ei,Ks,ms,De,ot,Gs,Qs,Os,We])}).beforeInit(function(e){const t={...sn,...e};return"standard"!==t.mode&&(t.sessionStorageType="memory",t.attributesStorageType="memory",t.tabManagerStorageType="memory",t.trafficSourceDetectorStorageType="memory",t.eventEnrichment={tab_id:!1,legacy_source:!1,referrer:!1},t.stateEnrichment={device_id:!1,session_id:"page-session"===t.mode,market:!0,platform:!0},t.attributeHints=!1,t.serverCookies=!1),t}).onInit(async(e,t,i)=>{await f(i.win,!0)&&await t.connectDB()},[be,me]);function rn(e){if("string"!=typeof e)throw new Error("Invalid input. Input must be a string");const t=e.match(/(\/?)(.+)\1([a-z]*)/i);return t?t[3]&&!/^(?!.*?(.).*?\1)[gmixXsuUAJ]+$/.test(t[3])?RegExp(e):new RegExp(t[2],t[3]):null}class on{value;optimized;constructor(e,t){this.value=e,this.optimized=t}toString(){return this.value}}class an{cssPath(e,t=!1){try{if(e.nodeType!==Node.ELEMENT_NODE)return"";const i=[];let s=e;for(;s;){const n=this.createStep(s,Boolean(t),s===e);if(!n)break;if(i.push(n),n?.optimized)break;s=s.parentNode}return i.reverse(),i.join(" > ")}catch(e){return console.error(e),""}}createStep(e,t,i){if(e.nodeType!==Node.ELEMENT_NODE)return null;const s=e.getAttribute("id");if(t){if(s)return new on(this.idSelector(s),!0);const t=e.nodeName.toLowerCase();if("body"===t||"head"===t||"html"===t)return new on(e.nodeName.toLowerCase(),!0)}const n=e.nodeName.toLowerCase();if(s)return new on(n.toLowerCase()+this.idSelector(s),!0);const r=e.parentNode;if(!r||r.nodeType===Node.DOCUMENT_NODE)return new on(n.toLowerCase(),!0);const o=this.prefixedElementClassNames(e),a=r.children;let c=!1,u=!1,h=-1;for(let t=0;(-1===h||!u)&&t<a.length;++t){const i=a[t];if(i===e){h=t;continue}if(u)continue;if(i?.nodeName.toLowerCase()!==n.toLowerCase())continue;c=!0;const s=o;let r=0;for(const e in s)++r;if(0===r){u=!0;continue}const l=this.prefixedElementClassNames(i);for(const e of l)if(!s.indexOf(e)&&(delete s[e],! --r)){u=!0;break}}let l=n.toLowerCase();if(i&&"input"===n.toLowerCase()&&e.getAttribute("type")&&!e.getAttribute("id")&&!e.getAttribute("class")&&(l+='[type="'+e.getAttribute("type")+'"]'),u)l+=":nth-child("+(h+1)+")";else if(c)for(const e in o)l+="."+this.escapeIdentifierIfNeeded(o[e]?.substr(1)||"");return new on(l,!1)}prefixedElementClassNames(e){const t=e.getAttribute("class");return t?t.split(/\s+/g).filter(Boolean).map(e=>"$"+e):[]}idSelector(e){return"#"+this.escapeIdentifierIfNeeded(e)}escapeIdentifierIfNeeded(e){if(this.isCSSIdentifier(e))return e;const t=/^(?:[0-9]|-[0-9-]?)/.test(e),i=e.length-1;return e.replace(/./g,(e,s)=>t&&0===s||!this.isCSSIdentChar(e)?this.escapeAsciiChar(e,s===i):e)}escapeAsciiChar(e,t){return"\\"+this.toHexByte(e)+(t?"":" ")}toHexByte(e){let t=e.charCodeAt(0).toString(16);return 1===t.length&&(t="0"+t),t}isCSSIdentChar(e){return!!/[a-zA-Z0-9_-]/.test(e)||e.charCodeAt(0)>=160}isCSSIdentifier(e){return/^-?[a-zA-Z_][a-zA-Z0-9_-]*$/.test(e)}}class cn{}class un extends cn{transformPipes=[];enrichmentPipes=[];process(e,t){return this.transform(e,t).map(e=>this.enrich(e,t))}transform(e,t){const i=this.selectPipeSet(e,this.transformPipes);let s=[e];for(const e of i){if(!e.transform)continue;const i=[];for(const n of s){const s=e.transform(n,t);i.push(...s)}s=i}return s}enrich(e,t){return this.selectPipeSet(e,this.enrichmentPipes).reverse().reduce((e,i)=>i.enrich(e,t),e)}registerTransformSet(e){this.transformPipes.push(e)}registerEnrichmentSet(e){this.enrichmentPipes.push(e)}selectPipeSet(e,t){for(const i of t){if(!("*"===i.selector||i.selector===e.type||"function"==typeof i.selector&&i.selector(e)||!1))continue;if(!("function"==typeof i.exclude&&i.exclude(e)))return[...i.use]}return[]}}class hn{rum;env;constructor(e,t){this.rum=e,this.env=t}init(e){this.rum.subscribe(e.config.rumReport,e.config.rumReportOnce).subscribe(e=>{this.env.win.dataLayer?.push({pulse:"event",event:"rum",data:e})})}}function ln(){return new W}function dn(e,t){var i=arguments.length>=2;return function(s){return s.pipe(e?ee(function(t,i){return e(t,i,s)}):H,qt(1),i?function(e){return Q(function(t,i){var s=!1;t.subscribe(X(i,function(e){s=!0,i.next(e)},function(){s||i.next(e),i.complete()}))})}(t):(void 0===(n=function(){return new W})&&(n=ln),Q(function(e,t){var i=!1;e.subscribe(X(t,function(e){i=!0,t.next(e)},function(){return i?t.complete():t.error(n())}))})));var n}}function pn(e,t){const i="string"==typeof t?t:t?.entryType,s=e.entry_type===i,n=function(e,t){if("string"==typeof t)return!0;if(void 0===t.name)return!0;if(Array.isArray(t.name))return t.name.some(t=>t instanceof RegExp?t.test(e):t===e);return!1}(e.name,t),r="object"!=typeof t||"function"!=typeof t.filter||t.filter(e);return s&&n&&r}class gn{timeline;resource;constructor(e,t){this.timeline=e,this.resource=t}subscribe(e,t){const i=[...e,...t||[]],s=i.some(e=>"resource"===e||"object"==typeof e&&"resource"===e.entryType),n=Ui(s?this.resource.subscribe(i):kt([]),this.timeline.subscribe(i).pipe(ee(e=>"resource"!==e.entry_type))),r=n.pipe(ee(e=>!t||t.every(t=>!pn(e,t))));return Ui(kt(t||[]).pipe(Us(e=>n.pipe(ee(t=>pn(t,e)),dn()))),r).pipe(ge(e=>this.enrichWithServerAttributes(e)))}enrichWithServerAttributes(e){if(Array.isArray(e.server_timing)){const t=[...e.server_timing],i={};for(const s of e.server_timing){const e=/^pulse\$([^$]+)\$([^$]+)$/.exec(s.name);if(!e?.length)continue;const n=(e[1]||"").toLowerCase(),r=(e[2]||"").toLowerCase();i[n]=r,t.splice(t.indexOf(s),1)}e.server_timing=t,e.server_attributes=i}return e}}class fn{env;cssPathService;date;firstPageHide;constructor(e,t,i,s){this.env=e,this.cssPathService=t,this.date=i,s.visible||(this.firstPageHide=i.hrtTimeOrigin),s.onVisibilityChange().pipe(ee(e=>!e),dn()).subscribe(()=>{this.firstPageHide=i.hrt()})}subscribe(e,t=!0){return Ui(...e.filter(e=>this.entrySupported(e)).map(e=>this.getFilterStream(e,t)))}getEntries(e){return Ui(...e.filter(e=>this.entrySupported(e)).map(e=>this.getFilterStream(e,!1,!0)))}getFilterStream(e,t,i){const s=this.env.win;return s.performance.getEntries&&s.performance.getEntriesByType&&s.performance.timeOrigin?i?this.readEntries(e):"function"==typeof s.PerformanceObserver&&s.WeakSet?this.getFilterStreamNative(e,t):this.getFilterStreamLegacy(e,t):kt([])}readEntries(e){const t="string"==typeof e?e:e.entryType,i=new WeakSet;return kt(this.env.win.performance.getEntriesByType(t)).pipe(ee(e=>!i.has(e)),Es(e=>i.add(e)),ge(e=>this.mapEntry(e)),ee(t=>pn(t,e)))}getFilterStreamNative(e,t){return new V(i=>{const s=new WeakSet,n=new this.env.win.PerformanceObserver(t=>{const n=t.getEntries();for(const t of n){if(s.has(t))continue;s.add(t);const n=this.mapEntry(t);pn(n,e)&&i.next(n)}}),r="string"==typeof e?e:e?.entryType;return n.observe({type:r,buffered:t}),()=>n.disconnect()})}getFilterStreamLegacy(e,t){return new V(i=>{const s=this.env.win.performance,n="string"==typeof e?e:e?.entryType;let r=t?0:s.now();const o=setInterval(()=>{const t=this.env.win.performance.getEntriesByType(n);let s=r;for(const n of t){const t=this.mapEntry(n);s<n.startTime&&(s=n.startTime),n.startTime<r||pn(t,e)&&i.next(t)}r=s},1e3);return()=>clearInterval(o)})}mapEntry(e){const t=this.env.win.navigator.connection,i="xmlhttprequest"===(String(e.initiatorType)+"").toLowerCase()?"xhr":String(e.initiatorType);let s={time_origin:this.date.hrtTimeOrigin,details:e.detail,name:e.name,entry_type:e.entryType,type:e.type,protocol:e.nextHopProtocol||void 0,task_duration:e.duration,start_time:e.startTime,end_time:e.responseEnd??(e.duration?e.startTime+e.duration:void 0),initiator_type:i,worker_start:e.workerStart,redirect_start:e.redirectStart,redirect_end:e.redirectEnd,fetch_start:e.fetchStart,domain_lookup_start:e.domainLookupStart,domain_lookup_end:e.domainLookupEnd,connect_start:e.connectStart,connect_end:e.connectEnd,secure_connection_start:e.secureConnectionStart,request_start:e.requestStart,response_start:e.responseStart,response_end:e.responseEnd,transfer_size:e.transferSize,encoded_body_size:e.encodedBodySize,decoded_body_size:e.decodedBodySize,unload_event_start:e.unloadEventStart,unload_event_end:e.unloadEventEnd,dom_interactive:e.domInteractive,dom_content_loaded_event_start:e.domContentLoadedEventStart,dom_content_loaded_event_end:e.domContentLoadedEventEnd,dom_complete:e.domComplete,load_event_start:e.loadEventStart,load_event_end:e.loadEventEnd,redirect_count:e.redirectCount,processing_start:e.processingStart,processing_end:e.processingEnd,cancelable:e.cancelable,render_blocking:e.renderBlockingStatus?"blocking"===e.renderBlockingStatus:void 0,had_recent_input:e.hadRecentInput,last_input_time:e.lastInputTime,cls_value:e.value,before_page_hide:this.beforePageHide(e.startTime)};return Array.isArray(e.serverTiming)&&e.serverTiming.length&&(s.server_timing=e.serverTiming),Array.isArray(e.workerTiming)&&e.workerTiming.length&&(s.worker_timing=e.workerTiming),!t||"resource"!==s.entry_type&&"navigation"!==s.entry_type||(s={...s,connection_downlink:t.downlink,connection_rtt:t.rtt,connection_type:t.effectiveType,data_saving_mode:t.saveData}),Array.isArray(e.attribution)&&(s.attribution=e.attribution.map(e=>({name:e?.name,entry_type:e?.entryType,start_time:e?.startTime,duration:e?.duration,container_type:e?.containerType,container_src:e?.containerSrc,container_id:e?.containerId,container_name:e?.containerName}))),"layout-shift"===s.entry_type&&Array.isArray(e.sources)&&(s.cls_sources=e.sources.map(e=>this.createCLSAttribution(e)).filter(Boolean)),s}beforePageHide(e){return!this.firstPageHide||(e?e<this.firstPageHide:void 0)}entrySupported(e){const t=this.env.win.PerformanceObserver?.supportedEntryTypes||[],i="string"==typeof e?e:e.entryType;return t.indexOf(i)>-1}createCLSAttribution(e){if("object"!=typeof e||"object"!=typeof e.node)return null;const t=e.node,i={current_rect:e.currentRect,previous_rect:e.previousRect};if(t){const e=this.cssPathService.cssPath(t);i.node={path:e}}return i}}class vn{fetchCollector;xhrCollector;timeline;date;env;performanceTimeline;constructor(e,t,i,s,n){this.fetchCollector=e,this.xhrCollector=t,this.timeline=i,this.date=s,this.env=n;const r=new je(1e3);this.performanceTimeline=r,this.timeline.subscribe(["resource"]).subscribe(r)}subscribe(e){const t=this.date.hrt(),i=Ui(this.fetchCollector.requests(),this.xhrCollector.requests()).pipe(Us(e=>this.findEntry(e)));return Ui(this.performanceTimeline.pipe(ee(e=>"fetch"!==e.initiator_type&&"xhr"!==e.initiator_type||e.start_time<=t),ge(e=>({entry:e}))),i).pipe(ge(e=>this.mergeRequestEntry(e)),ee(Boolean),ee(t=>!e||e.some(e=>pn(t,e))))}mergeRequestEntry(e){const t=e.request,i=Boolean(t)&&void 0!==t&&("basic"===t.responseMode||"cors"===t.responseMode||"default"===t.responseMode);let s=e.entry;if(s)s.response_entry_matched=Boolean(t);else{if(!t)return null;const e=this.env.win.navigator.connection;s={name:t.url,entry_type:"resource",initiator_type:t.initiator,start_time:t.start,end_time:t.end,task_duration:(t.fetchEnd||t.end)-t.start,time_origin:this.date.hrtTimeOrigin,response_entry_matched:!1},i&&(s.decoded_body_size=t.responseBodySize,s.transfer_size=t.responseBodySize),e&&(s={...s,connection_downlink:e.downlink,connection_rtt:e.rtt,connection_type:e.effectiveType,data_saving_mode:e.saveData})}return t&&this.enrichWithRequest(s,t,i),s}enrichWithRequest(e,t,i){e.request_method=t.method,e.response_status=t.responseStatus,e.response_mode=t.responseMode,e.request_body_size=t.requestBodySize,e.response_end=e.response_end||t.fetchEnd||t.end,e.end_time=t.end,e.user_duration=t.end-t.start,e.response_content_type=t.responseContentType,e.request_content_type=t.requestContentType,e.redirected=t.redirected,e.aborted=t.aborted,i&&(e.transfer_size=e.transfer_size||t.responseBodySize,e.response_body_size=t.responseBodySize,e.decoded_body_size=t.responseBodySize,e.transfer_size=t.responseBodySize)}findEntry(e){return this.performanceTimeline.pipe(ee(e=>"fetch"===e.initiator_type||"xhr"===e.initiator_type),ee(t=>this.matchLax(e,t)),dn(),ge(t=>({entry:t,request:e})))}matchLax(e,t){const i=t.start_time,s=t.task_duration?t.start_time+t.task_duration:t.response_end||0;return i>=e.start-1&&s<=e.end+1&&e.url===t.name}}const bn=new Set(["plain/text","text/html","text/css","text/xml","text/csv","text/javascript","application/json","application/ld+json","application/xml","application/xhtml+xml","application/atom+xml","application/javascript","application/x-javascript","image/svg+xml"]),mn=new Set(["font/woff2","font/ttf","image/gif","image/png","image/jpg","image/jpeg","image/webp","image/bmp"]),yn=new Set([...bn.values(),...mn.values()]);function Sn(e,t){try{return new URL("string"==typeof e?e:e.href,t.win.location.href).href}catch(t){return"string"==typeof e?e:"object"==typeof e&&e.href?e.href:void console.warn(t)}}function wn(e){if(e)return e.toLowerCase().split(";").map(e=>e.trim())[0]}function _n(e,t){try{if(null==e||""===e)return 0;if("string"==typeof e)return new t.Blob([e]).size;if(e instanceof t.Blob)return e.size;if((e instanceof t.ArrayBuffer||t.ArrayBuffer.isView(e))&&"number"==typeof e.byteLength)return e.byteLength;if(e instanceof t.URLSearchParams)return _n(e.toString(),t);if("object"==typeof e)return _n(JSON.stringify(e),t)}catch{}}function En(e,t,i,s){if(t?.body&&!function(e,t){return"ReadableStream"in t&&e instanceof t.ReadableStream}(t.body,s.win)){const i=new Ee;try{const e=_n(t.body,s.win);i.resolve({size:e,start:-1,end:-1,cancelled:!1})}catch(e){i.reject(e)}return{wrappedRequest:new Request(e,t),bodyStats:i.waitUntilResolved()}}if("object"==typeof e&&e.body instanceof ReadableStream){const{wrappedStream:n,complete:r}=function(e,t,i){const s=new Ee,n=new Ee;let r=-1;const o=new i.ReadableStream({start(s){r=t.hrt();const o=e.getReader();let a=0;o.read().then(({done:e,value:o})=>{if(e){const e=t.hrt();return n.resolve({start:r,end:e,size:a,cancelled:!1}),void s.close()}try{a+=_n(o,i)??0}catch(e){console.error(e)}s.enqueue(o)}).catch(e=>{n.reject(e),s.error(e)})},cancel(i){e.cancel(i);const s=t.hrt();n.resolve({start:r,end:s,cancelled:!0})}});return{started:s.waitUntilResolved(),complete:n.waitUntilResolved(),wrappedStream:o}}(e.body,i,s.win),o={cache:e?.cache,credentials:e?.credentials,headers:e?.headers,integrity:e?.integrity,keepalive:e?.keepalive,method:e?.method,mode:e?.mode,redirect:e?.redirect,referrer:e?.referrer,referrerPolicy:e?.referrerPolicy,signal:e?.signal,...t||{},body:n};return{wrappedRequest:new Request(e,o),bodyStats:r}}return{wrappedRequest:new Request(e,t),bodyStats:Promise.resolve(void 0)}}class Tn{date;env;reportStream=new z;patched=!1;constructor(e,t){this.date=e,this.env=t}requests(){return this.patchFetch(),this.reportStream.asObservable()}supported(){return"ReadableStream"in this.env.win&&"ArrayBuffer"in this.env.win&&"Request"in this.env.win&&"Response"in this.env.win&&"function"==typeof this.env.win.fetch}patchFetch(){if(this.patched||!this.supported())return;const e=this.env.win,t=e.fetch.bind(e);this.env.win.fetch=async(e,i)=>this.monitoredFetch(e,i,t),this.patched=!0}async monitoredFetch(e,t,i){const s={url:"",method:"",start:0,fetchEnd:0,end:0,responseStatus:0,initiator:"fetch"};let n,r,o;try{n=En(e,t,this.date,this.env),s.url=Sn(n.wrappedRequest.url,this.env)||"",s.method=n.wrappedRequest.method.toUpperCase(),n.bodyStats.then(e=>{s.requestBodySize=e?.size}).catch(e=>{console.error(e)}),n.wrappedRequest.signal?.addEventListener("abort",()=>{s.aborted=!0}),s.start=this.date.hrt(),r=await i(n.wrappedRequest),s.fetchEnd=this.date.hrt();try{s.responseBodySize=r.headers.has("content-length")?Number(r.headers.get("content-length")):void 0;("basic"===r.type||"cors"===r.type||"default"===r.type)&&s.responseContentType&&!Number.isSafeInteger(s.responseBodySize)&&yn.has(s.responseContentType)&&(o=r.clone())}catch{}return r}finally{s.fetchEnd=r?s.fetchEnd:this.date.hrt(),Ke(0).then(()=>this.reportResponse(r,o,s)).catch(e=>console.error(e))}}async reportResponse(e,t,i){if(i){if(e)try{const s=e.headers?.get("content-type");if(i.responseContentType=wn(s),i.redirected=e.redirected,i.responseMode=e.type,i.responseStatus=e.status,!Number.isSafeInteger(i.responseBodySize)&&t)try{const e=await t.blob();i.responseBodySize=e.size}catch{}}catch{}i.end=this.date.hrt(),this.reportStream.next(i)}}}function kn(e,t){if(!t||!e)return!1;if(bn.has(t))return!0;if(mn.has(t))try{return e instanceof Blob||e instanceof ArrayBuffer}catch(e){console.error(e)}return!1}function Cn(e,t){const i=new z;function s(s){if(s.___pulse)return s.___pulse;const n={requestHeaders:new Headers,hasError:!1};return s.___pulse=n,s.addEventListener("error",()=>{n.hasError=!0}),s.addEventListener("timeout",()=>{n.hasError=!0,n.aborted=!0}),s.addEventListener("loadend",r=>{n.end=e.hrt(),Ke(0).then(()=>function(s,n,r){const o=wn(n.requestHeaders.get("content-type"));let a,c,u;kn(n.requestBody,o)&&(a=_n(n.requestBody,t.win));let h={url:n.url,method:n.method,start:n.start,fetchEnd:n.end,end:n.end,aborted:Boolean(n.aborted),requestBodySize:a,requestContentType:o,responseStatus:s.status,initiator:"xhr"};if(n.hasError)i.next(h);else{try{u=wn(s.getResponseHeader("content-type"))}catch(e){console.error(e)}if(r.lengthComputable&&"number"==typeof r.total)c=r.total;else try{const e=Number(s.getResponseHeader("content-length"));Number.isSafeInteger(e)&&(h.responseBodySize=e)}catch(e){console.error(e)}"number"!=typeof h.responseBodySize&&kn(s.response,u)&&(c=_n(s.response,t.win)),h={...h,responseBodySize:c,responseContentType:u,end:e.hrt()},i.next(h)}}(s,n,r)).catch(e=>console.error(e))}),n}function n(e,t){const i=XMLHttpRequest.prototype[e];"function"==typeof i&&(XMLHttpRequest.prototype[e]=function(...e){const n=this,r=s(n);return t(n,r,i.bind(n),...e)})}return n("setRequestHeader",(e,t,i,...s)=>{const[n,r]=s;try{t.requestHeaders.set(n,r)}catch(e){console.error(e)}i.apply(e,s)}),n("open",(e,i,s,...n)=>{const[r,o]=n;s.apply(e,n),i.method=r,i.url=Sn(o,t)||""}),n("send",(t,i,s,...n)=>{i.start=e.hrt(),s.apply(t,n)}),n("abort",(e,t,i)=>{t.aborted=!0,i.apply(e)}),i.asObservable()}class In{date;env;stream;constructor(e,t){this.date=e,this.env=t}requests(){return this.stream||(this.stream=Cn(this.date,this.env)),this.stream}}class xn{value;optimized;constructor(e,t=!1){this.value=e,this.optimized=t}toString(){return this.value}}class Pn{xPath(e,t){if(e.nodeType===Node.DOCUMENT_NODE)return"/";const i=[];let s=e;for(;s;){const e=this.xPathValue(s,t);if(!e)break;if(i.push(e),e.optimized)break;s=s.parentNode}return i.reverse(),(i.length&&i[0]?.optimized?"":"/")+i.join("/")}xPathValue(e,t){const i=this.xPathIndex(e);let s;if(-1===i)return null;switch(e.nodeType){case Node.ELEMENT_NODE:{const i=e;if(t&&i.getAttribute("id"))return new xn('//*[@id="'+i.getAttribute("id")+'"]',!0);s=i.localName;break}case Node.ATTRIBUTE_NODE:s="@"+e.nodeName;break;case Node.TEXT_NODE:case Node.CDATA_SECTION_NODE:s="text()";break;case Node.PROCESSING_INSTRUCTION_NODE:s="processing-instruction()";break;case Node.COMMENT_NODE:s="comment()";break;case Node.DOCUMENT_NODE:default:s=""}return i>0&&(s+="["+i+"]"),new xn(s,e.nodeType===Node.DOCUMENT_NODE)}xPathIndex(e){const t=e.parentNode?e.parentNode.children:null;if(!t)return 0;let i=!1;for(const s of t)if(this.areNodesSimilar(e,s)&&s!==e){i=!0;break}if(!i)return 0;let s=1;for(const i of t)if(this.areNodesSimilar(e,i)){if(i===e)return s;++s}return-1}areNodesSimilar(e,t){if(e===t)return!0;if(e.nodeType===Node.ELEMENT_NODE&&t.nodeType===Node.ELEMENT_NODE)return e.localName===t.localName;if(e.nodeType===t.nodeType)return!0;return(e.nodeType===Node.CDATA_SECTION_NODE?Node.TEXT_NODE:e.nodeType)===(t.nodeType===Node.CDATA_SECTION_NODE?Node.TEXT_NODE:t.nodeType)}}class Nn{pipesHost;config;constructor(e,t){this.pipesHost=e,this.config=t}registerPipes(){const e=this.config.transformPipes||[],t=this.config.enrichmentPipes||[];e.forEach(e=>this.pipesHost.registerTransformSet(e)),t.forEach(e=>this.pipesHost.registerEnrichmentSet(e))}}class An{visibilityChangePlugin;config;rumPlugin;pluginHost;constructor(e,t,i,s){this.visibilityChangePlugin=e,this.config=t,this.rumPlugin=i,this.pluginHost=s}registerPlugins(){[this.visibilityChangePlugin,this.rumPlugin,...this.config.plugins||[]].forEach(e=>this.pluginHost.register(e))}}const On=new ye("INTERNAL_DATA_LAYER"),Rn=new ye("DATA_LAYER"),Ln=new ye("DEFAULT_PIPES_HOST_TOKEN"),Dn=new ye("PIPES_HOST_TOKEN");const Mn={...ve,plugins:[],transformPipes:[],enrichmentPipes:[],sessionStorageType:"persistent",tabManagerStorageType:"tab",debug:[],storagePrefix:"paa_",tabOpenerDetectionTimeWindow:6e3,rumUnsafeRequestBodyMeasure:!0,rumReportOnce:[],rumReport:[],dataLayerKey:"dataLayer"};function $n(e){for(const t of e)if("object"==typeof t&&Array.isArray(t.name))for(let e=0;e<t.name.length;e++){const i=t.name[e];if("string"==typeof i&&i.startsWith("/")){const s=rn(i);s instanceof RegExp&&(t.name[e]=s)}}}const Un=(new Ce).provide(function(e){return e.useFactory(rt,e=>e,[Se]).useFactory(Rn,(e,t)=>e.win[t.dataLayerKey],[me,rt]).useFactory(On,e=>e.win.pulse?.q,[me]).useClass(Vi,Vi,[]).useClass(Dn,un,[]).useClass(Ln,un,[]).useClass(Ws,Ws,[ji]).useClass(gn,gn,[fn,vn]).useClass(vn,vn,[Tn,In,fn,De,me]).useClass(an,an,[]).useClass(fn,fn,[me,an,De,ji]).useClass(Tn,Tn,[De,me]).useClass(In,In,[De,me]).useClass(An,An,[Ws,rt,hn,Vi]).useClass(Pn,Pn,[]).useClass(Nn,Nn,[Dn,rt])}).beforeInit(function(e){const t={...Mn,...e};return function(e){e.rumReport=e.rumReport||[],e.rumReportOnce=e.rumReportOnce||[],$n(e.rumReport),$n(e.rumReportOnce)}(t),t});function Bn(){return function(){const e=("object"==typeof globalThis?globalThis:{}).__pulseAsyncContextStore;return e?.getStore()}()??globalThis.pulse?.θ?.i}async function jn(){const e=Bn();if(e)return e;if(!globalThis.pulse.θ)throw new Error("Pulse sdk is not initialized!");return new Promise(e=>{globalThis.pulse.θ.ready.push(t=>e(t))})}function Hn(e){return async function(...t){const i=await jn();return i[e].apply(i,t)}}function Fn(e={},t={}){const i=function(){if(_e()){const e=globalThis?.navigator,t=e?.connection||e?.mozConnection||e?.webkitConnection;let i=1e4;switch(t?.effectiveType){case"slow 2g":case"slow-2g":i=6e4;break;case"2g":i=3e4;break;case"3g":i=15e3;break;case"4g":i=5e3}return(e?.userAgentData?.mobile??(e?.maxTouchPoints>0||globalThis?.document&&"ontouchstart"in globalThis.document.documentElement))&&(i=Math.min(2*i,6e4)),i}return 6e3}(),s=Hn("get");return{get(n,r,o){const a=new AbortController;return Promise.race([s(n,r,o??e[n],t).then(e=>(a.abort(),e)),Ke(i,a.signal).then(()=>o)])},observe:(n="observe",function(...e){const t=new z;return jn().then(function(i){i[n].apply(i,e).subscribe(t)}),t.asObservable()}),segments:Hn("segments"),experiments:Hn("experiments")};var n}function Vn(e){return{pulseInit:[],ready:[],idu:globalThis.location?.href,c:e}}function qn(e){return Object.assign(async function(){const e=arguments,t=await jn();"function"!=typeof e[0]?t.cmd.apply(t,e):e[0](t)},Fn(e?.defaults,e?.attributes),{event:Hn("event"),events:Hn("events"),attribute:Hn("attribute"),attributes:Hn("attributes"),set:Hn("set"),state:Hn("state"),flush:Hn("flush"),cmd:Hn("cmd")},{getStateString:Hn("getStateString")},{θ:Vn(e)})}const Kn=(new Ce).provide(function(e){return e.useFactory(it,e=>e,[Se]).useClass(at,at,[])}).beforeInit(function(e){const t={...fe,...e};return"standard"!==t.mode&&(t.hashStoreStorageType="memory"),t});function zn(e){return e?Object.getOwnPropertyNames(e).filter(t=>"function"==typeof e[t]&&"constructor"!==t):[]}function Gn(e,t){const{settingsMethods:i,trackerMethods:s}=function(e,t){return{settingsMethods:zn(Object.getPrototypeOf(e)),trackerMethods:zn(Object.getPrototypeOf(t))}}(e,t);const n=function(){t.cmd(arguments)};for(const t of i)n[t]=e[t].bind(e);for(const e of s)n[e]=t[e].bind(t);return n.settings=e,n.tracker=t,n}var Jn=window,Wn=Jn.pulseInit||[],Yn=Jn.pulseReady||[];Jn.pulseInit=Wn,Jn.pulseReady=Yn;var Qn=Wn.push.bind(Wn),Xn=Yn.push.bind(Yn);function Zn(){for(var e,t,i,s,n=[],r=0;r<arguments.length;r++)n[r]=arguments[r];try{for(var a=o(n),c=a.next();!c.done;c=a.next()){var u=c.value;(null===(i=Jn.pulse)||void 0===i?void 0:i.tracker)||(null===(s=Jn.pulse)||void 0===s?void 0:s.settingsFactory)?u.onReady():(Qn(u),Xn(u))}}catch(t){e={error:t}}finally{try{c&&!c.done&&(t=a.return)&&t.call(a)}finally{if(e)throw e.error}}return Wn.length}function er(e,t){var i,s,n,r;if(t)console.warn(t,e);else{var a=Wn,c=Yn;try{for(var u=o(a),h=u.next();!h.done;h=u.next()){var l=h.value;Wn.splice(Wn.indexOf(l),1),l.onReady()}}catch(e){i={error:e}}finally{try{h&&!h.done&&(s=u.return)&&s.call(u)}finally{if(i)throw i.error}}try{for(var d=o(c),p=d.next();!p.done;p=d.next()){l=p.value;Yn.splice(Yn.indexOf(l),1),l.onReady()}}catch(e){n={error:e}}finally{try{p&&!p.done&&(r=d.return)&&r.call(d)}finally{if(n)throw n.error}}}}Wn.push=Zn,Yn.push=Zn,function(){n(this,void 0,void 0,function(){var e,t,i,n,o,c,u,h,l,d,p,g;return r(this,function(r){switch(r.label){case 0:return(null===(g=globalThis.pulse)||void 0===g?void 0:g.tracker)?(console.warn("Pulse is already initialized"),[2]):(e={"app_version":"0","app":"picsart.com","storagePrefix":"paa_","batchTimeMS":500,"batchSize":50,"rumReport":[],"rumReportOnce":[],"debug":[],"consentChecks":[{"type":"tracking","consent":"OneTrust","report":true,"mode":"opt-out","forceReport":true}]},t=function(e){if("object"!=typeof globalThis)throw new Error("Unsupported execution environment!");if(globalThis.pulse){if(globalThis.pulse.θ?.c?.app&&e?.app&&globalThis.pulse.θ?.c?.app!==e.app)throw new Error("Pulse is already initialized with a different app id!")}else{const t=qn(e);globalThis.pulse=t}return globalThis.pulse}(),i=t.θ,n=i.c||{},o=s(s({},e||{}),n||{}),globalThis.dataLayer=globalThis.dataLayer||[],[4,(new Ce).import(Kn).import(Fi).import(Un).import(nn).import(di).bootstrap(o)]);case 1:return c=r.sent(),[4,Promise.all([c.get(ii),c.get($s),c.get(si)])];case 2:return u=a.apply(void 0,[r.sent(),3]),h=u[0],l=u[1],d=u[2],p=Gn(h,l),function(e,t,i){var s=window;s.dataLayer=s.dataLayer||[],s.pulse?(s.pulse.tracker=t,s.pulse.settings=e,s.pulse.settingsFactory=i,s.pulse._initialized=!0,er("tracker"),er("settings")):console.warn("Pulse is not initialized")}(h,l,d),function(e,t){var i,s;null===(i=e.ready)||void 0===i||i.forEach(function(e){return e(t)}),null===(s=e.ready)||void 0===s||s.splice(0,e.ready.length),e.ready.push=function(e){return e(t),0}}(i,p),[2]}})})}()})()})();
//# sourceMappingURL=pulse.bundle.all.es5.76102e2df7c23d2c9210.js.map